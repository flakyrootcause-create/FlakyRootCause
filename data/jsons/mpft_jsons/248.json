{
  "id": 248,
  "repo": "hadoop",
  "issue_url": "https://github.com/apache/hadoop/pull/7659",
  "pr_url": "https://github.com/apache/hadoop/pull/7659",
  "issue_description": "\r\n<!--\r\n  Thanks for sending a pull request!\r\n    1. If this is your first time, please read our contributor guidelines: https://cwiki.apache.org/confluence/display/HADOOP/How+To+Contribute\r\n    2. Make sure your PR title starts with JIRA issue id, e.g., 'HADOOP-17799. Your PR title ...'.\r\n-->\r\n\r\n### Description of PR\r\nPlease refer to YARN-11816 for details.\r\n\r\n### How was this patch tested?\r\n\r\n\r\n### For code changes:\r\n\r\n- [x] Does the title or this PR starts with the corresponding JIRA issue id (e.g. 'HADOOP-17799. Your PR title ...')?\r\n- [ ] Object storage: have the integration tests been executed and the endpoint declared according to the connector-specific documentation?\r\n- [ ] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?\r\n- [ ] If applicable, have you updated the `LICENSE`, `LICENSE-binary`, `NOTICE-binary` files?\r\n\r\n",
  "files_changed": [
    {
      "filename": "hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/TestCapacitySchedulerMultiNodes.java",
      "status": "modified",
      "patch": "@@ -23,7 +23,6 @@\n import static org.junit.jupiter.api.Assertions.assertEquals;\n import static org.junit.jupiter.api.Assertions.assertNotNull;\n import static org.junit.jupiter.api.Assertions.assertNull;\n-import static org.junit.jupiter.api.Assertions.assertTrue;\n import static org.junit.jupiter.api.Assertions.fail;\n import static org.mockito.Mockito.when;\n \n@@ -35,8 +34,10 @@\n import java.util.Map;\n import java.util.Set;\n import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.TimeoutException;\n import java.util.concurrent.atomic.AtomicBoolean;\n \n+import org.apache.hadoop.test.GenericTestUtils;\n import org.apache.hadoop.thirdparty.com.google.common.collect.Iterators;\n \n import org.apache.hadoop.yarn.server.resourcemanager.RMContext;\n@@ -625,7 +626,6 @@ public void testCheckRequestOnceForUnsatisfiedRequest() throws Exception {\n     // mock node tracker with 2000 nodes\n     // to simulate the scenario where there are many nodes in the cluster\n     List<FiCaSchedulerNode> mockNodes = new ArrayList<>();\n-    long ss = System.currentTimeMillis();\n     for (int i = 0; i < 2000; i++) {\n       FiCaSchedulerNode node =\n           TestUtils.getMockNode(\"host\" + i + \":1234\", \"\", 0, 10 * GB, 10);\n@@ -660,26 +660,34 @@ public List<FiCaSchedulerNode> getNodesPerPartition(String partition) {\n     // create an unsatisfied request which will reach the headroom\n     am1.allocate(\"*\", 2 * GB, 10, new ArrayList<>());\n \n-    // verify that when headroom is reached for an unsatisfied request,\n-    // scheduler should only check the request once before checking all nodes.\n-    CandidateNodeSet<FiCaSchedulerNode> candidates =\n-        new SimpleCandidateNodeSet<>(Collections.emptyMap(), \"\");\n-    int numSchedulingCycles = 10;\n-    long startTime = System.currentTimeMillis();\n-    for (int i = 0; i < numSchedulingCycles; i++) {\n-      spyCs.allocateContainersToNode(candidates, false);\n+    List<Long> elapsedMsLst = new ArrayList<>();\n+    try {\n+      GenericTestUtils.waitFor(() -> {\n+        // verify that when headroom is reached for an unsatisfied request,\n+        // scheduler should only check the request once before checking all nodes.\n+        CandidateNodeSet<FiCaSchedulerNode> candidates =\n+            new SimpleCandidateNodeSet<>(Collections.emptyMap(), \"\");\n+        int numSchedulingCycles = 10;\n+        long startTime = System.currentTimeMillis();\n+        for (int i = 0; i < numSchedulingCycles; i++) {\n+          spyCs.allocateContainersToNode(candidates, false);\n+        }\n+        long avgElapsedMs =\n+            (System.currentTimeMillis() - startTime) / numSchedulingCycles;\n+        LOG.info(\"Average elapsed time for a scheduling cycle: {} ms\",\n+            avgElapsedMs);\n+\n+        elapsedMsLst.add(avgElapsedMs);\n+        // verify that the scheduling cycle is less than 10ms,\n+        // ideally the latency should be less than 2ms.\n+        return avgElapsedMs < 10;\n+      }, 500, 3000);\n+    } catch (TimeoutException e) {\n+      fail(\"Scheduling cycle expected to be less than 10ms, \" +\n+          \"but took too long, elapsedMs:\" + elapsedMsLst);\n+    } finally {\n+      rm.stop();\n     }\n-    long avgElapsedMs =\n-        (System.currentTimeMillis() - startTime) / numSchedulingCycles;\n-    LOG.info(\"Average elapsed time for a scheduling cycle: {} ms\",\n-        avgElapsedMs);\n-    // verify that the scheduling cycle is less than 5ms,\n-    // ideally the latency should be less than 2ms.\n-    assertTrue(avgElapsedMs < 5,\n-        String.format(\"%d ms elapsed in average for a scheduling cycle, \" +\n-            \"expected to be less than 5ms.\", avgElapsedMs));\n-\n-    rm.stop();\n   }\n \n   private static void moveReservation(CapacityScheduler cs,"
    }
  ],
  "fix_category": "WaitFor",
  "root_cause_category": "Time",
  "root_cause_subcategory": NaN
}