{
  "id": 36,
  "repo": "pytorch",
  "issue_url": "https://github.com/pytorch/pytorch/pull/135370",
  "pr_url": "https://github.com/pytorch/pytorch/pull/135370",
  "issue_description": "Stack from [ghstack](https://github.com/ezyang/ghstack) (oldest at bottom):\n* __->__ #135370\n\nSummary: This test is flaky when run after `test_dynamic_shapes_persistent_reduction_mixed_x_dim_cuda_cuda_wrapper` because the TestCase sets config options globally in its setUp() that stick around for subsequent tests. For test isolation, we use a contextlib.ExitStack pattern in other tests to patch the config options and restore them in tearDown(). Update all TestCases in `test/inductor/test_combo_kernels.py` to use that pattern.\n\nTest Plan:\n```\npython test/inductor/test_combo_kernels.py\npython test/inductor/test_cuda_cpp_wrapper.py TestCudaWrapper.test_dynamic_shapes_persistent_reduction_mixed_x_dim_cuda_cuda_wrapper TestCudaWrapper.test_randint_cuda_cuda_wrapper\n```\n\ncc @voznesenskym @penguinwu @EikanWang @jgong5 @Guobing-Chen @XiaobingSuper @zhuhaozhe @blzheng @wenzhe-nrv @jiayisunx @ipiszy @yf225 @chenyang78 @kadeng @muchulee8 @ColinPeppler @amjames @desertfire @chauhang",
  "files_changed": [
    {
      "filename": "test/inductor/test_combo_kernels.py",
      "status": "modified",
      "patch": "@@ -1,5 +1,6 @@\n # Owner(s): [\"module: inductor\"]\n \n+import contextlib\n import sys\n import unittest\n \n@@ -36,12 +37,20 @@ class ComboKernelTests(TestCase):\n     def setUp(self):\n         super().setUp()\n         torch._inductor.metrics.reset()\n-        torch._inductor.config.combo_kernels = True\n-        torch._inductor.config.benchmark_combo_kernel = False\n+        self._test_stack = contextlib.ExitStack()\n+        self._test_stack.enter_context(\n+            torch._inductor.config.patch(\n+                {\n+                    \"combo_kernels\": True,\n+                    \"benchmark_combo_kernel\": False,\n+                }\n+            )\n+        )\n \n     def tearDown(self):\n-        super().tearDown()\n+        self._test_stack.close()\n         torch._inductor.metrics.reset()\n+        super().tearDown()\n \n     @requires_cuda\n     def test_activation_functions(self):\n@@ -157,12 +166,20 @@ class ComboKernelBenchmarkTests(TestCase):\n     def setUp(self):\n         super().setUp()\n         torch._inductor.metrics.reset()\n-        torch._inductor.config.combo_kernels = True\n-        torch._inductor.config.benchmark_combo_kernel = True\n+        self._test_stack = contextlib.ExitStack()\n+        self._test_stack.enter_context(\n+            torch._inductor.config.patch(\n+                {\n+                    \"combo_kernels\": True,\n+                    \"benchmark_combo_kernel\": True,\n+                }\n+            )\n+        )\n \n     def tearDown(self):\n-        super().tearDown()\n+        self._test_stack.close()\n         torch._inductor.metrics.reset()\n+        super().tearDown()\n \n     @requires_cuda\n     def test_activation_benchmark(self):\n@@ -303,14 +320,28 @@ class ComboKernelDynamicShapesTests(TestCase):\n     def setUp(self):\n         super().setUp()\n         torch._inductor.metrics.reset()\n-        torch._inductor.config.combo_kernels = True\n-        torch._inductor.config.benchmark_combo_kernel = True\n-        torch._dynamo.config.automatic_dynamic_shapes = False\n-        torch._dynamo.config.assume_static_by_default = False\n+        self._test_stack = contextlib.ExitStack()\n+        self._test_stack.enter_context(\n+            torch._inductor.config.patch(\n+                {\n+                    \"combo_kernels\": True,\n+                    \"benchmark_combo_kernel\": True,\n+                }\n+            )\n+        )\n+        self._test_stack.enter_context(\n+            torch._dynamo.config.patch(\n+                {\n+                    \"automatic_dynamic_shapes\": False,\n+                    \"assume_static_by_default\": False,\n+                }\n+            )\n+        )\n \n     def tearDown(self):\n-        super().tearDown()\n+        self._test_stack.close()\n         torch._inductor.metrics.reset()\n+        super().tearDown()\n \n     @requires_cuda\n     def test_dynamic_shapes_activations(self):"
    }
  ],
  "fix_category": "Setup/clean up state",
  "root_cause_category": "Test order dependency",
  "root_cause_subcategory": NaN
}