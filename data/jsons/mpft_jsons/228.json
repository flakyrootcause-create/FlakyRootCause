{
  "id": 228,
  "repo": "jbpm",
  "issue_url": "https://github.com/kiegroup/jbpm/commit/02eb4f8c8f3c35aee0cd3cfb6cac3aed65ed2b25",
  "pr_url": "https://github.com/kiegroup/jbpm/commit/02eb4f8c8f3c35aee0cd3cfb6cac3aed65ed2b25",
  "issue_description": "I have written integration code which would allow conditionExpressions to be xpath and evaluator for it\n\nalso test case is added to illustrate the use of xpath\n",
  "files_changed": [
    {
      "filename": "jbpm-bpmn2/src/test/java/org/jbpm/bpmn2/SimpleBPMNProcessTest.java",
      "status": "modified",
      "patch": "@@ -72,6 +72,11 @@\n import bitronix.tm.TransactionManagerServices;\n import bitronix.tm.resource.jdbc.PoolingDataSource;\n \n+import org.w3c.dom.Document;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+\n+import java.io.ByteArrayInputStream;\n+\n public class SimpleBPMNProcessTest extends JbpmTestCase {\n \n \tprivate PoolingDataSource ds1;\n@@ -907,6 +912,20 @@ public void testNoneIntermediateThrow() throws Exception {\n         ProcessInstance processInstance = ksession.startProcess(\"NoneIntermediateEvent\", null);\n         assertEquals(ProcessInstance.STATE_COMPLETED, processInstance.getState());\n     }\n+\n+    public void testXpathExpression() throws Exception {\n+                KnowledgeBase kbase = createKnowledgeBase(\"BPMN2-XpathExpression.bpmn2\");\n+                StatefulKnowledgeSession ksession = createKnowledgeSession(kbase);\n+        Document document = DocumentBuilderFactory.newInstance().newDocumentBuilder()\n+            .parse(new ByteArrayInputStream(\n+                \"<instanceMetadata><user approved=\\\"false\\\" id=\\\"58735964413\\\"/></instanceMetadata>\".getBytes()));\n+        Map<String, Object> params = new HashMap<String, Object>();\n+        params.put(\"instanceMetadata\", document);\n+\n+                ProcessInstance processInstance = ksession.startProcess(\"594975243920585248\", params);\n+                assertTrue(processInstance.getState() == ProcessInstance.STATE_COMPLETED);\n+    }\n+\n     \n \tprivate KnowledgeBase createKnowledgeBase(String process) throws Exception {\n \t\tKnowledgeBuilderConfiguration conf = KnowledgeBuilderFactory.newKnowledgeBuilderConfiguration();"
    },
    {
      "filename": "jbpm-bpmn2/src/test/resources/BPMN2-XpathExpression.bpmn2",
      "status": "added",
      "patch": "@@ -0,0 +1,32 @@\n+<bpmn2:definitions xmlns:bpmn2='http://www.omg.org/spec/BPMN/20100524/MODEL' xmlns:xrm='http://www.intalio.com/cloud/xrm' typeLanguage='http://www.java.com/javaTypes' expressionLanguage='http://www.mvel.org/2.0' id='594975243920585248' targetNamespace=''>\n+   <bpmn2:import importType='xrm' namespace='http://www.intalio.com/cloud/xrm'/>\n+   <bpmn2:itemDefinition id='objectType' structureRef='java.lang.Object'/>\n+  <bpmn2:process id='594975243920585248'>\n+  <bpmn2:property id='instanceMetadata' itemSubjectRef='objectType'/>\n+<bpmn2:property id='processsMetadata' itemSubjectRef='objectType'/>\n+<bpmn2:startEvent id='_5DF6C746-EEDF-4D39-A953-B529A0320D24' name=''/>\n+<bpmn2:exclusiveGateway id='_81070F07-C929-4C93-8B08-18FF6D319F6A' name='' gatewayDirection='Diverging'/>\n+<bpmn2:sequenceFlow id='_036CFFA5-945F-4597-BD74-DBFBA5553D7D' sourceRef='_5DF6C746-EEDF-4D39-A953-B529A0320D24' targetRef='_81070F07-C929-4C93-8B08-18FF6D319F6A'/>\n+  <bpmn2:scriptTask id='_BF09B923-BE11-4447-BECB-609BD86C59EF' name=''>\n+  <bpmn2:ioSpecification><bpmn2:inputSet/>\n+<bpmn2:outputSet/>\n+</bpmn2:ioSpecification>\n+<bpmn2:script>System.out.println(\"Task 1\");</bpmn2:script>\n+</bpmn2:scriptTask>\n+<bpmn2:sequenceFlow id='_E6BD9F03-8580-4AD8-A5CC-6D1F416E514C' sourceRef='_81070F07-C929-4C93-8B08-18FF6D319F6A' targetRef='_BF09B923-BE11-4447-BECB-609BD86C59EF'>    <conditionExpression language='http://www.w3.org/1999/XPath'>count($instanceMetadata/user[@approved='true']) = 1</conditionExpression>\n+</bpmn2:sequenceFlow>\n+  <bpmn2:scriptTask id='_7CA18647-714B-44D5-8DEB-544709C4221A' name=''>\n+  <bpmn2:ioSpecification><bpmn2:inputSet/>\n+<bpmn2:outputSet/>\n+</bpmn2:ioSpecification>\n+<bpmn2:script>System.out.println(\"Task 2\");</bpmn2:script>\n+</bpmn2:scriptTask>\n+<bpmn2:sequenceFlow id='_ED6FD301-F8C0-4241-A8FF-A1F7756652B7' sourceRef='_81070F07-C929-4C93-8B08-18FF6D319F6A' targetRef='_7CA18647-714B-44D5-8DEB-544709C4221A'>    <conditionExpression language='http://www.w3.org/1999/XPath'>count($instanceMetadata/user[@approved='false']) = 1</conditionExpression>\n+</bpmn2:sequenceFlow>\n+<bpmn2:sequenceFlow id='_2BF3E89A-B28F-40E3-9A9B-A982206BF500' sourceRef='_7CA18647-714B-44D5-8DEB-544709C4221A' targetRef='_FB90F2CD-5CA2-4F85-88C0-022B03130BAE'/>\n+<bpmn2:endEvent id='_C1D067D7-3596-45F7-9B75-69F60C3442F1' name=''/>\n+<bpmn2:sequenceFlow id='_119E4948-40CF-4C76-9988-22C706C1AB1A' sourceRef='_FB90F2CD-5CA2-4F85-88C0-022B03130BAE' targetRef='_C1D067D7-3596-45F7-9B75-69F60C3442F1'/>\n+<bpmn2:exclusiveGateway id='_FB90F2CD-5CA2-4F85-88C0-022B03130BAE' name='' gatewayDirection='Converging'/>\n+<bpmn2:sequenceFlow id='_0849EEE3-09A2-4E99-A232-E1EA8B8C4121' sourceRef='_BF09B923-BE11-4447-BECB-609BD86C59EF' targetRef='_FB90F2CD-5CA2-4F85-88C0-022B03130BAE'/>\n+</bpmn2:process>\n+</bpmn2:definitions>"
    },
    {
      "filename": "jbpm-flow-builder/src/main/java/org/jbpm/process/builder/dialect/ProcessDialectRegistry.java",
      "status": "modified",
      "patch": "@@ -5,6 +5,7 @@\n \n import org.jbpm.process.builder.dialect.java.JavaProcessDialect;\n import org.jbpm.process.builder.dialect.mvel.MVELProcessDialect;\n+import org.jbpm.process.builder.dialect.xpath.XPATHProcessDialect;\n \n public class ProcessDialectRegistry {\n \t\n@@ -14,6 +15,7 @@ public class ProcessDialectRegistry {\n \t\t dialects = new HashMap<String, ProcessDialect>();\n \t\t dialects.put(\"java\", new JavaProcessDialect());\n \t\t dialects.put(\"mvel\", new MVELProcessDialect());\n+\t\t dialects.put(\"XPath\", new XPATHProcessDialect());\n \t}\n \t\n \tpublic static ProcessDialect getDialect(String dialect) {"
    },
    {
      "filename": "jbpm-flow-builder/src/main/java/org/jbpm/process/builder/dialect/xpath/XPATHProcessDialect.java",
      "status": "added",
      "patch": "@@ -0,0 +1,47 @@\n+/*\n+  Copyright 2010 Intalio Inc\n+\n+  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+  Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.jbpm.process.builder.dialect.xpath;\n+\n+import org.jbpm.process.builder.ActionBuilder;\n+import org.jbpm.process.builder.ProcessBuildContext;\n+import org.jbpm.process.builder.ProcessClassBuilder;\n+import org.jbpm.process.builder.ReturnValueEvaluatorBuilder;\n+import org.jbpm.process.builder.dialect.ProcessDialect;\n+\n+public class XPATHProcessDialect implements ProcessDialect {\n+\n+//\tprivate static final ActionBuilder actionBuilder = new XPATHActionBuilder();\n+\tprivate static final ReturnValueEvaluatorBuilder returnValueBuilder = new XPATHReturnValueEvaluatorBuilder();\n+\t\n+\tpublic void addProcess(final ProcessBuildContext context) {\n+        // @TODO setup line mappings\n+\t}\n+\n+\tpublic ActionBuilder getActionBuilder() {\n+//\t\treturn actionBuilder;\n+\t\tthrow new UnsupportedOperationException( \"XPATHProcessDialect.getActionBuilder is not supported\" );\n+\t}\n+\n+\tpublic ProcessClassBuilder getProcessClassBuilder() {\n+        throw new UnsupportedOperationException( \"XPATHLProcessDialect.getProcessClassBuilder is not supported\" );\n+\t}\n+\n+\tpublic ReturnValueEvaluatorBuilder getReturnValueEvaluatorBuilder() {\n+\t\treturn returnValueBuilder;\n+\t}\n+\n+}"
    },
    {
      "filename": "jbpm-flow-builder/src/main/java/org/jbpm/process/builder/dialect/xpath/XPATHReturnValueEvaluatorBuilder.java",
      "status": "added",
      "patch": "@@ -0,0 +1,58 @@\n+/*\r\n+  Copyright 2010 Intalio Inc\r\n+\r\n+  Licensed under the Apache License, Version 2.0 (the \"License\");\r\n+ * you may not use this file except in compliance with the License.\r\n+ * You may obtain a copy of the License at\r\n+\r\n+       http://www.apache.org/licenses/LICENSE-2.0\r\n+\r\n+  Unless required by applicable law or agreed to in writing, software\r\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n+ * See the License for the specific language governing permissions and\r\n+ * limitations under the License.\r\n+ */\r\n+\r\n+package org.jbpm.process.builder.dialect.xpath;\r\n+\r\n+import org.drools.compiler.DescrBuildError;\r\n+import org.drools.compiler.ReturnValueDescr;\r\n+import org.jbpm.process.builder.ReturnValueEvaluatorBuilder;\r\n+import org.jbpm.process.core.ContextResolver;\r\n+import org.jbpm.process.instance.impl.ReturnValueConstraintEvaluator;\r\n+import org.jbpm.process.instance.impl.XPATHReturnValueEvaluator;\r\n+import org.drools.rule.builder.PackageBuildContext;\r\n+\r\n+public class XPATHReturnValueEvaluatorBuilder\r\n+    implements\r\n+    ReturnValueEvaluatorBuilder {\r\n+\r\n+    public XPATHReturnValueEvaluatorBuilder() {\r\n+\r\n+    }\r\n+\r\n+    public void build(final PackageBuildContext context,\r\n+                      final ReturnValueConstraintEvaluator constraintNode,\r\n+                      final ReturnValueDescr descr,\r\n+                      final ContextResolver contextResolver) {\r\n+\r\n+        String text = descr.getText();\r\n+\r\n+        try {\r\n+//            XPATHReturnValueEvaluator expr = new XPATHReturnValueEvaluator( text,\r\n+//                                                                          context.getDialect( \"XPath\" ).getId() );\r\n+            XPATHReturnValueEvaluator expr = new XPATHReturnValueEvaluator( text,\r\n+                    null );\r\n+\r\n+            constraintNode.setEvaluator( expr );\r\n+            \r\n+        } catch ( final Exception e ) {\r\n+            context.getErrors().add( new DescrBuildError( context.getParentDescr(),\r\n+                                                          descr,\r\n+                                                          null,\r\n+                                                          \"Unable to build expression for 'constraint' \" + descr.getText() + \"': \" + e ) );\r\n+        }\r\n+    }\r\n+\r\n+}\r"
    },
    {
      "filename": "jbpm-flow/src/main/java/org/jbpm/process/instance/impl/XPATHReturnValueEvaluator.java",
      "status": "added",
      "patch": "@@ -0,0 +1,101 @@\n+/*\r\n+  Copyright 2010 Intalio Inc\r\n+\r\n+  Licensed under the Apache License, Version 2.0 (the \"License\");\r\n+ * you may not use this file except in compliance with the License.\r\n+ * You may obtain a copy of the License at\r\n+\r\n+       http://www.apache.org/licenses/LICENSE-2.0\r\n+\r\n+  Unless required by applicable law or agreed to in writing, software\r\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n+ * See the License for the specific language governing permissions and\r\n+ * limitations under the License.\r\n+ */\r\n+\r\n+package org.jbpm.process.instance.impl;\r\n+\r\n+import java.io.Externalizable;\r\n+import java.io.IOException;\r\n+import java.io.ObjectInput;\r\n+import java.io.ObjectOutput;\r\n+\r\n+import javax.xml.namespace.QName;\r\n+import javax.xml.parsers.DocumentBuilder;\r\n+import javax.xml.parsers.DocumentBuilderFactory;\r\n+import javax.xml.xpath.XPath;\r\n+import javax.xml.xpath.XPathConstants;\r\n+import javax.xml.xpath.XPathExpression;\r\n+import javax.xml.xpath.XPathFactory;\r\n+import javax.xml.xpath.XPathVariableResolver;\r\n+\r\n+import org.drools.runtime.process.ProcessContext;\r\n+\r\n+public class XPATHReturnValueEvaluator\r\n+    implements\r\n+    ReturnValueEvaluator,\r\n+    Externalizable {\r\n+    private static final long   serialVersionUID = 510l;\r\n+\r\n+    private String              xpath;\r\n+    private String              id;\r\n+\r\n+    public XPATHReturnValueEvaluator() {\r\n+    }\r\n+\r\n+    public XPATHReturnValueEvaluator(final String xpath,\r\n+                                    final String id) {\r\n+        this.xpath = xpath;\r\n+        this.id = id;\r\n+    }\r\n+\r\n+    public void readExternal(ObjectInput in) throws IOException,\r\n+                                            ClassNotFoundException {\r\n+        id = in.readUTF();\r\n+        xpath = (String) in.readObject();\r\n+    }\r\n+\r\n+    public void writeExternal(ObjectOutput out) throws IOException {\r\n+        out.writeUTF( id );\r\n+        out.writeObject(xpath);\r\n+    }\r\n+\r\n+    public String getDialect() {\r\n+        return this.id;\r\n+    }\r\n+\r\n+    public Object evaluate(final ProcessContext context) throws Exception {        \r\n+    \tXPathFactory factory = XPathFactory.newInstance();\r\n+    \tXPath xpath = factory.newXPath();\r\n+    \txpath.setXPathVariableResolver( \r\n+    \t\t\tnew  XPathVariableResolver() {\r\n+    \t\t\t\tpublic Object resolveVariable(QName var)\r\n+    \t\t\t\t{\r\n+    \t\t\t\t\tif (var == null) {\r\n+    \t\t\t\t\t\tthrow new NullPointerException(\"The variable name cannot be null\");\r\n+    \t\t\t\t\t}\r\n+\r\n+    \t\t\t\t\tif (context.getVariable(var.getLocalPart()) != null) {\r\n+    \t\t\t\t\t\treturn context.getVariable(var.getLocalPart());\r\n+    \t\t\t\t\t}\r\n+    \t\t\t\t\telse {\r\n+    \t\t\t\t\t\treturn null;\r\n+    \t\t\t\t\t}\r\n+    \t\t\t\t}\r\n+\r\n+    \t\t\t}\r\n+    \t);\r\n+        \r\n+        XPathExpression expr \r\n+         = xpath.compile(this.xpath);\r\n+\r\n+\t\tDocumentBuilder builder = DocumentBuilderFactory.newInstance().newDocumentBuilder();\r\n+        return expr.evaluate(builder.newDocument(), XPathConstants.BOOLEAN);\r\n+    }\r\n+\r\n+    public String toString() {\r\n+        return this.xpath;\r\n+    }    \r\n+\r\n+}\r"
    }
  ],
  "fix_category": "Sleep",
  "root_cause_category": "Time",
  "root_cause_subcategory": NaN
}