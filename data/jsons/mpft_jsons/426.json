{
  "id": 426,
  "repo": "kubernetes",
  "issue_url": "https://github.com/kubernetes/kubernetes/pull/128239",
  "pr_url": "https://github.com/kubernetes/kubernetes/pull/128239",
  "issue_description": "<!--  Thanks for sending a pull request!  Here are some tips for you:\r\n\r\n1. If this is your first time, please read our contributor guidelines: https://git.k8s.io/community/contributors/guide/first-contribution.md#your-first-contribution and developer guide https://git.k8s.io/community/contributors/devel/development.md#development-guide\r\n2. Please label this pull request according to what type of issue you are addressing, especially if this is a release targeted pull request. For reference on required PR/issue labels, read here:\r\nhttps://git.k8s.io/community/contributors/devel/sig-release/release.md#issuepr-kind-label\r\n3. Ensure you have added or ran the appropriate tests for your PR: https://git.k8s.io/community/contributors/devel/sig-testing/testing.md\r\n4. If you want *faster* PR reviews, read how: https://git.k8s.io/community/contributors/guide/pull-requests.md#best-practices-for-faster-reviews\r\n5. If the PR is unfinished, see how to mark it: https://git.k8s.io/community/contributors/guide/pull-requests.md#marking-unfinished-pull-requests\r\n-->\r\n\r\n#### What type of PR is this?\r\n/kind failing-test\r\n<!--\r\nAdd one of the following kinds:\r\n/kind bug\r\n/kind cleanup\r\n/kind documentation\r\n/kind feature\r\n\r\nOptionally add one or more of the following kinds if applicable:\r\n/kind api-change\r\n/kind deprecation\r\n/kind failing-test\r\n/kind flake\r\n/kind regression\r\n-->\r\n\r\n#### What this PR does / why we need it:\r\n\r\n#### Which issue(s) this PR fixes:\r\n<!--\r\n*Automatically closes linked issue when PR is merged.\r\nUsage: `Fixes #<issue number>`, or `Fixes (paste link of issue)`.\r\n_If PR is about `failing-tests or flakes`, please post the related issues/tests in a comment and do not use `Fixes`_*\r\n-->\r\nFixes part of #128113 #129036\r\n\r\n#### Special notes for your reviewer:\r\nIn the PreStop hook of a pod, we continuously output \"Looping\" in a loop and sleep for 1 second. The script declared in PreStop is as follows:\r\n```\r\nsh -c '\r\ntouch /persistent/my-container.log;\r\necho $(date -u +%FT$(nmeter -d0 '%3t' | head -n1)Z) '\\''prestop-my-container Starting 0'\\'' | tee -a /persistent/my-container.log >> /proc/1/fd/1;\r\n_term() { sleep 0; echo $(date -u +%FT$(nmeter -d0 '%3t' | head -n1)Z) '\\''prestop-my-container Exiting'\\'' | tee -a /persistent/my-container.log >> /proc/1/fd/1; exit 0; };\r\ntrap _term TERM;\r\ntouch started;\r\necho $(date -u +%FT$(nmeter -d0 '%3t' | head -n1)Z) '\\''prestop-my-container Started'\\'' | tee -a /persistent/my-container.log >> /proc/1/fd/1;\r\necho $(date -u +%FT$(nmeter -d0 '%3t' | head -n1)Z) '\\''prestop-my-container Delaying 0'\\'' | tee -a /persistent/my-container.log >> /proc/1/fd/1;\r\nwhile true; do\r\n  echo $(date -u +%FT$(nmeter -d0 '%3t' | head -n1)Z) '\\''prestop-my-container Looping'\\'' | tee -a /persistent/my-container.log >> /proc/1/fd/1;\r\n  sleep 1;\r\ndone;\r\necho $(date -u +%FT$(nmeter -d0 '%3t' | head -n1)Z) '\\''prestop-my-container Exiting'\\'' | tee -a /persistent/my-container.log >> /proc/1/fd/1;\r\nexit 0'\r\n```\r\nIt exhibits the following issues:\r\n\r\n1. The while loop execution time isn't consistently 1 second - it often takes slightly longer by tens of milliseconds\r\n\r\n2. The start/end times of the while loop vary across containers (not just loop execution variance, but also hundreds of milliseconds difference in when kubelet initiates preStop execution)\r\n\r\n3. When kubelet forcibly terminates containers, due to the inconsistent loop timings across containers, some loops might execute N times while others execute N+1 times\r\n\r\nTo mitigate these, I modified the loop timing to be configurable externally through ExecCommand parameters, which should help alleviate these issues.\r\n\r\n#### Does this PR introduce a user-facing change?\r\n<!--\r\nIf no, just write \"NONE\" in the release-note block below.\r\nIf yes, a release note is required:\r\nEnter your extended release note in the block below. If the PR requires additional action from users switching to the new release, include the string \"action required\".\r\n\r\nFor more information on release notes see: https://git.k8s.io/community/contributors/guide/release-notes.md\r\n-->\r\n```release-note\r\nNONE\r\n```\r\n\r\n#### Additional documentation e.g., KEPs (Kubernetes Enhancement Proposals), usage docs, etc.:\r\n\r\n<!--\r\nThis section can be blank if this pull request does not require a release note.\r\n\r\nWhen adding links which point to resources within git repositories, like\r\nKEPs or supporting documentation, please reference a specific commit and avoid\r\nlinking directly to the master branch. This ensures that links reference a\r\nspecific point in time, rather than a document that may change over time.\r\n\r\nSee here for guidance on getting permanent links to files: https://help.github.com/en/articles/getting-permanent-links-to-files\r\n\r\nPlease use the following format for linking documentation:\r\n- [KEP]: <link>\r\n- [Usage]: <link>\r\n- [Other doc]: <link>\r\n-->\r\n```docs\r\n\r\n```\r\n",
  "files_changed": [
    {
      "filename": "test/e2e_node/container_lifecycle_pod_construction.go",
      "status": "modified",
      "patch": "@@ -48,6 +48,8 @@ type execCommand struct {\n \t// ContainerName is the name of the container to append the log. If empty,\n \t// the name specified in ExecCommand will be used.\n \tContainerName string\n+\t// LoopPeriod is the time interval for executing the loop.\n+\tLoopPeriod float32\n }\n \n // ExecCommand returns the command to execute in the container that implements\n@@ -88,8 +90,13 @@ func ExecCommand(name string, c execCommand) []string {\n \tif c.Delay != 0 {\n \t\tfmt.Fprint(&cmd, sleepCommand(c.Delay))\n \t}\n+\n+\tloopPeriod := float32(1)\n+\tif c.LoopPeriod != 0 {\n+\t\tloopPeriod = c.LoopPeriod\n+\t}\n \tif c.LoopForever {\n-\t\tfmt.Fprintf(&cmd, \"while true; do echo %s '%s Looping' | tee -a %s >> /proc/1/fd/1 ; sleep 1 ; done; \", timeCmd, name, containerLog)\n+\t\tfmt.Fprintf(&cmd, \"while true; do echo %s '%s Looping' | tee -a %s >> /proc/1/fd/1 ; sleep %f ; done; \", timeCmd, name, containerLog, loopPeriod)\n \t}\n \tfmt.Fprintf(&cmd, \"echo %s '%s Exiting'  | tee -a %s >> /proc/1/fd/1; \", timeCmd, name, containerLog)\n \tfmt.Fprintf(&cmd, \"exit %d\", c.ExitCode)"
    },
    {
      "filename": "test/e2e_node/container_lifecycle_test.go",
      "status": "modified",
      "patch": "@@ -3178,6 +3178,7 @@ var _ = SIGDescribe(nodefeature.SidecarContainers, \"Containers Lifecycle\", func(\n \t\t\t\t\t\t\t\t\tExitCode:      0,\n \t\t\t\t\t\t\t\t\tContainerName: containerName,\n \t\t\t\t\t\t\t\t\tLoopForever:   true,\n+\t\t\t\t\t\t\t\t\tLoopPeriod:    0.2,\n \t\t\t\t\t\t\t\t}),\n \t\t\t\t\t\t\t},\n \t\t\t\t\t\t},\n@@ -3280,7 +3281,7 @@ var _ = SIGDescribe(nodefeature.SidecarContainers, \"Containers Lifecycle\", func(\n \t\t\t\tps3Last, err := results.TimeOfLastLoop(prefixedName(PreStopPrefix, restartableInit3))\n \t\t\t\tframework.ExpectNoError(err)\n \n-\t\t\t\tconst simulToleration = 500 // milliseconds\n+\t\t\t\tconst simulToleration = 1000 // milliseconds\n \t\t\t\t// should all end together since they loop infinitely and exceed their grace period\n \t\t\t\tgomega.Expect(ps1Last-ps2Last).To(gomega.BeNumerically(\"~\", 0, simulToleration),\n \t\t\t\t\tfmt.Sprintf(\"expected PostStart 1 & PostStart 2 to be killed at the same time, got %s\", results))\n@@ -3290,7 +3291,7 @@ var _ = SIGDescribe(nodefeature.SidecarContainers, \"Containers Lifecycle\", func(\n \t\t\t\t\tfmt.Sprintf(\"expected PostStart 2 & PostStart 3 to be killed at the same time, got %s\", results))\n \n \t\t\t\t// 30 seconds + 2 second minimum grace for the SIGKILL\n-\t\t\t\tconst lifetimeToleration = 1000 // milliseconds\n+\t\t\t\tconst lifetimeToleration = 1500 // milliseconds\n \t\t\t\tgomega.Expect(ps1Last-ps1).To(gomega.BeNumerically(\"~\", 32000, lifetimeToleration),\n \t\t\t\t\tfmt.Sprintf(\"expected PostStart 1 to live for ~32 seconds, got %s\", results))\n \t\t\t\tgomega.Expect(ps2Last-ps2).To(gomega.BeNumerically(\"~\", 32000, lifetimeToleration),"
    }
  ],
  "fix_category": "Other",
  "root_cause_category": "Time",
  "root_cause_subcategory": NaN
}