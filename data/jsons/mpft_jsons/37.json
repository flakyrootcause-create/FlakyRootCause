{
  "id": 37,
  "repo": "pytorch",
  "issue_url": "https://github.com/pytorch/pytorch/pull/134058",
  "pr_url": "https://github.com/pytorch/pytorch/pull/134058",
  "issue_description": "[PR Linked Issue]\nPlatforms: asan, linux, mac, macos, rocm, slow, win, windows, dynamo\n\n\n\n\n\nThis test was disabled because it is failing in CI. See [recent examples](https://hud.pytorch.org/flakytest?name=test_get_mode_stack&suite=TestTorchFunctionMode&limit=100) and the most recent trunk [workflow logs](https://github.com/pytorch/pytorch/runs/28989307006).\n\nOver the past 3 hours, it has been determined flaky in 69 workflow(s) with 210 failures and 69 successes.\n\n**Debugging instructions (after clicking on the recent samples link):**\nDO NOT ASSUME THINGS ARE OKAY IF THE CI IS GREEN. We now shield flaky tests from developers so CI will thus be green but it will be harder to parse the logs.\nTo find relevant log snippets:\n1. Click on the workflow logs linked above\n2. Click on the Test step of the job so that it is expanded. Otherwise, the grepping will not work.\n3. Grep for `test_get_mode_stack`\n4. There should be several instances run (as flaky tests are rerun in CI) from which you can study the logs.\n\n\n\n<details><summary>Sample error message</summary>\n\n```\nTraceback (most recent call last):\n  File \"/var/lib/jenkins/workspace/test/test_overrides.py\", line 1328, in test_get_mode_stack\n    self.assertEqual(_get_current_function_mode_stack(), [])\n  File \"/opt/conda/envs/py_3.10/lib/python3.10/site-packages/torch/testing/_internal/common_utils.py\", line 3785, in assertEqual\n    error_metas = not_close_error_metas(\n  File \"/opt/conda/envs/py_3.10/lib/python3.10/site-packages/torch/testing/_comparison.py\", line 1227, in not_close_error_metas\n    raise error_meta.to_error() from None  # noqa: RSE102\nAssertionError: The length of the sequences mismatch: 1 != 0\n\nTo execute this test, run the following from the base repo dir:\n    python test/test_overrides.py TestTorchFunctionMode.test_get_mode_stack\n\nThis message can be suppressed by setting PYTORCH_PRINT_REPRO_ON_FAILURE=0\n```\n\n</details>\n\n\nTest file path: `test_overrides.py`\n\ncc @clee2000 @hameerabbasi @rgommers @ezyang",
  "files_changed": [
    {
      "filename": "test/test_overrides.py",
      "status": "modified",
      "patch": "@@ -1621,22 +1621,25 @@ def __torch_function__(self, func, types, args=(), kwargs=None):\n     def test_device_context_semantics(self):\n         from torch._C import _len_torch_function_stack\n         from torch.utils._device import DeviceContext\n-        torch.set_default_device(\"cuda\")\n+        try:\n+            torch.set_default_device(\"cuda\")\n \n-        def get_stack():\n-            return [torch._C._get_function_stack_at(i) for i in range(_len_torch_function_stack())]\n+            def get_stack():\n+                return [torch._C._get_function_stack_at(i) for i in range(_len_torch_function_stack())]\n+\n+            base_mode = BaseTorchFunctionMode()\n+            with base_mode:\n+                torch.set_default_device(\"cpu\")\n+                x = torch.ones(2, 2)\n+                stack = get_stack()\n+                self.assertIsInstance(stack[0], DeviceContext)\n+                self.assertEqual(stack[0].device, torch.device(\"cpu\"))\n \n-        base_mode = BaseTorchFunctionMode()\n-        with base_mode:\n-            torch.set_default_device(\"cpu\")\n-            x = torch.ones(2, 2)\n             stack = get_stack()\n             self.assertIsInstance(stack[0], DeviceContext)\n             self.assertEqual(stack[0].device, torch.device(\"cpu\"))\n-\n-        stack = get_stack()\n-        self.assertIsInstance(stack[0], DeviceContext)\n-        self.assertEqual(stack[0].device, torch.device(\"cpu\"))\n+        finally:\n+            torch.set_default_device(None)\n \n \n "
    }
  ],
  "fix_category": "Setup/clean up state",
  "root_cause_category": "Test order dependency",
  "root_cause_subcategory": NaN
}