{
  "id": 108,
  "repo": "unomi",
  "issue_url": "https://github.com/apache/unomi/pull/626",
  "pr_url": "https://github.com/apache/unomi/pull/626",
  "issue_description": "",
  "files_changed": [
    {
      "filename": "itests/src/test/java/org/apache/unomi/itests/SegmentIT.java",
      "status": "modified",
      "patch": "@@ -204,7 +204,8 @@ public void testSegmentWithPastEventCondition() throws InterruptedException {\n         // send event for profile from a previous date (today -3 days)\n         ZoneId defaultZoneId = ZoneId.systemDefault();\n         LocalDate localDate = LocalDate.now().minusDays(3);\n-        Event testEvent = new Event(\"test-event-type\", null, profile, null, null, profile, Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n+        Event testEvent = new Event(\"test-event-type\", null, profile, null, null, profile,\n+                Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n         testEvent.setPersistent(true);\n         int changes = eventService.send(testEvent);\n         if ((changes & EventService.PROFILE_UPDATED) == EventService.PROFILE_UPDATED) {\n@@ -225,14 +226,11 @@ public void testSegmentWithPastEventCondition() throws InterruptedException {\n         segmentService.setSegmentDefinition(segment);\n \n         // insure the profile that did the past event condition is correctly engaged in the segment.\n-        keepTrying(\"Profile should be engaged in the segment\",\n-                () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> updatedProfile.getSegments().contains(\"past-event-segment-test\"),\n-                1000, 20);\n+        keepTrying(\"Profile should be engaged in the segment\", () -> profileService.load(\"test_profile_id\"),\n+                updatedProfile -> updatedProfile.getSegments().contains(\"past-event-segment-test\"), 1000, 20);\n     }\n \n     @Test\n-    @Ignore\n     public void testSegmentWithNegativePastEventCondition() throws InterruptedException {\n         // create Profile\n         Profile profile = new Profile();\n@@ -255,17 +253,24 @@ public void testSegmentWithNegativePastEventCondition() throws InterruptedExcept\n         // insure that profile is correctly engaged in sement since there is no events yet.\n         keepTrying(\"Profile should be engaged in the segment, there is no event for the past condition yet\",\n                 () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> updatedProfile.getSegments().contains(\"negative-past-event-segment-test\"),\n-                1000, 20);\n+                updatedProfile -> updatedProfile.getSegments().contains(\"negative-past-event-segment-test\"), 1000, 20);\n \n         // we load the profile so that we are sure that it contains the segments\n         profile = profileService.load(\"test_profile_id\");\n \n         // send event for profile from a previous date (today -3 days)\n         ZoneId defaultZoneId = ZoneId.systemDefault();\n         LocalDate localDate = LocalDate.now().minusDays(3);\n-        Event testEvent = new Event(\"negative-test-event-type\", null, profile, null, null, profile, Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n+        Event testEvent = new Event(\"negative-test-event-type\", null, profile, null, null, profile,\n+                Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n         testEvent.setPersistent(true);\n+\n+        // wait for segment auto generated rule to be available\n+        keepTrying(\"The segment auto generated rule should be available to handle the test event\",\n+                () -> rulesService.getMatchingRules(testEvent),\n+                rules -> rules.size() > 0, 1000, 20);\n+\n+        // send the event\n         int changes = eventService.send(testEvent);\n         if ((changes & EventService.PROFILE_UPDATED) == EventService.PROFILE_UPDATED) {\n             profileService.save(profile);\n@@ -276,8 +281,7 @@ public void testSegmentWithNegativePastEventCondition() throws InterruptedExcept\n         // now Profile should be out of the segment since one event have been done and the past event is only valid for no events occurrences\n         keepTrying(\"Profile should not be engaged in the segment anymore, it have a least one event now\",\n                 () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> !updatedProfile.getSegments().contains(\"negative-past-event-segment-test\"),\n-                1000, 20);\n+                updatedProfile -> !updatedProfile.getSegments().contains(\"negative-past-event-segment-test\"), 1000, 20);\n     }\n \n     @Test\n@@ -304,7 +308,8 @@ public void testSegmentPastEventRecalculation() throws Exception {\n         // Persist the event (do not send it into the system so that it will not be processed by the rules)\n         ZoneId defaultZoneId = ZoneId.systemDefault();\n         LocalDate localDate = LocalDate.now().minusDays(3);\n-        Event testEvent = new Event(\"test-event-type\", null, profile, null, null, profile, Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n+        Event testEvent = new Event(\"test-event-type\", null, profile, null, null, profile,\n+                Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n         testEvent.setPersistent(true);\n         persistenceService.save(testEvent, null, true);\n         persistenceService.refreshIndex(Event.class, testEvent.getTimeStamp()); // wait for event to be fully persisted and indexed\n@@ -316,25 +321,22 @@ public void testSegmentPastEventRecalculation() throws Exception {\n         // now recalculate the past event conditions\n         segmentService.recalculatePastEventConditions();\n         persistenceService.refreshIndex(Profile.class, null);\n-        keepTrying(\"Profile should be engaged in the segment\",\n-                () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> updatedProfile.getSegments().contains(\"past-event-segment-test\"),\n-                1000, 20);\n+        keepTrying(\"Profile should be engaged in the segment\", () -> profileService.load(\"test_profile_id\"),\n+                updatedProfile -> updatedProfile.getSegments().contains(\"past-event-segment-test\"), 1000, 20);\n \n         // update the event to a date out of the past event condition\n         removeItems(Event.class);\n         localDate = LocalDate.now().minusDays(15);\n-        testEvent = new Event(\"test-event-type\", null, profile, null, null, profile, Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n+        testEvent = new Event(\"test-event-type\", null, profile, null, null, profile,\n+                Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n         persistenceService.save(testEvent);\n         persistenceService.refreshIndex(Event.class, testEvent.getTimeStamp()); // wait for event to be fully persisted and indexed\n \n         // now recalculate the past event conditions\n         segmentService.recalculatePastEventConditions();\n         persistenceService.refreshIndex(Profile.class, null);\n-        keepTrying(\"Profile should not be engaged in the segment anymore\",\n-                () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> !updatedProfile.getSegments().contains(\"past-event-segment-test\"),\n-                1000, 20);\n+        keepTrying(\"Profile should not be engaged in the segment anymore\", () -> profileService.load(\"test_profile_id\"),\n+                updatedProfile -> !updatedProfile.getSegments().contains(\"past-event-segment-test\"), 1000, 20);\n     }\n \n     @Test\n@@ -348,7 +350,8 @@ public void testScoringWithPastEventCondition() throws InterruptedException {\n         // send event for profile from a previous date (today -3 days)\n         ZoneId defaultZoneId = ZoneId.systemDefault();\n         LocalDate localDate = LocalDate.now().minusDays(3);\n-        Event testEvent = new Event(\"test-event-type\", null, profile, null, null, profile, Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n+        Event testEvent = new Event(\"test-event-type\", null, profile, null, null, profile,\n+                Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n         testEvent.setPersistent(true);\n         int changes = eventService.send(testEvent);\n         if ((changes & EventService.PROFILE_UPDATED) == EventService.PROFILE_UPDATED) {\n@@ -376,12 +379,9 @@ public void testScoringWithPastEventCondition() throws InterruptedException {\n         segmentService.setScoringDefinition(scoring);\n \n         // insure the profile that did the past event condition is correctly engaged in the scoring plan.\n-        keepTrying(\"Profile should be engaged in the scoring with a score of 50\",\n-                () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> updatedProfile.getScores() != null &&\n-                        updatedProfile.getScores().containsKey(\"past-event-scoring-test\") &&\n-                        updatedProfile.getScores().get(\"past-event-scoring-test\") == 50,\n-                1000, 20);\n+        keepTrying(\"Profile should be engaged in the scoring with a score of 50\", () -> profileService.load(\"test_profile_id\"),\n+                updatedProfile -> updatedProfile.getScores() != null && updatedProfile.getScores().containsKey(\"past-event-scoring-test\")\n+                        && updatedProfile.getScores().get(\"past-event-scoring-test\") == 50, 1000, 20);\n     }\n \n     @Test\n@@ -414,39 +414,37 @@ public void testScoringPastEventRecalculation() throws Exception {\n         // Persist the event (do not send it into the system so that it will not be processed by the rules)\n         ZoneId defaultZoneId = ZoneId.systemDefault();\n         LocalDate localDate = LocalDate.now().minusDays(3);\n-        Event testEvent = new Event(\"test-event-type\", null, profile, null, null, profile, Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n+        Event testEvent = new Event(\"test-event-type\", null, profile, null, null, profile,\n+                Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n         testEvent.setPersistent(true);\n         persistenceService.save(testEvent, null, true);\n         persistenceService.refreshIndex(Event.class, testEvent.getTimeStamp()); // wait for event to be fully persisted and indexed\n \n         // insure the profile is not yet engaged since we directly saved the event in ES\n         profile = profileService.load(\"test_profile_id\");\n-        Assert.assertTrue(\"Profile should not be engaged in the scoring\", profile.getScores() == null || !profile.getScores().containsKey(\"past-event-scoring-test\"));\n+        Assert.assertTrue(\"Profile should not be engaged in the scoring\",\n+                profile.getScores() == null || !profile.getScores().containsKey(\"past-event-scoring-test\"));\n \n         // now recalculate the past event conditions\n         segmentService.recalculatePastEventConditions();\n         persistenceService.refreshIndex(Profile.class, null);\n-        keepTrying(\"Profile should be engaged in the scoring with a score of 50\",\n-                () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> updatedProfile.getScores() != null &&\n-                        updatedProfile.getScores().containsKey(\"past-event-scoring-test\") &&\n-                        updatedProfile.getScores().get(\"past-event-scoring-test\") == 50,\n-                1000, 20);\n+        keepTrying(\"Profile should be engaged in the scoring with a score of 50\", () -> profileService.load(\"test_profile_id\"),\n+                updatedProfile -> updatedProfile.getScores() != null && updatedProfile.getScores().containsKey(\"past-event-scoring-test\")\n+                        && updatedProfile.getScores().get(\"past-event-scoring-test\") == 50, 1000, 20);\n \n         // update the event to a date out of the past event condition\n         removeItems(Event.class);\n         localDate = LocalDate.now().minusDays(15);\n-        testEvent = new Event(\"test-event-type\", null, profile, null, null, profile, Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n+        testEvent = new Event(\"test-event-type\", null, profile, null, null, profile,\n+                Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n         persistenceService.save(testEvent);\n         persistenceService.refreshIndex(Event.class, testEvent.getTimeStamp()); // wait for event to be fully persisted and indexed\n \n         // now recalculate the past event conditions\n         segmentService.recalculatePastEventConditions();\n         persistenceService.refreshIndex(Profile.class, null);\n-        keepTrying(\"Profile should not be engaged in the scoring anymore\",\n-                () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> !updatedProfile.getScores().containsKey(\"past-event-scoring-test\"),\n-                1000, 20);\n+        keepTrying(\"Profile should not be engaged in the scoring anymore\", () -> profileService.load(\"test_profile_id\"),\n+                updatedProfile -> !updatedProfile.getScores().containsKey(\"past-event-scoring-test\"), 1000, 20);\n     }\n \n     @Test\n@@ -480,44 +478,42 @@ public void testScoringPastEventRecalculationMaximumEventCount() throws Exceptio\n         // Persist the event (do not send it into the system so that it will not be processed by the rules)\n         ZoneId defaultZoneId = ZoneId.systemDefault();\n         LocalDate localDate = LocalDate.now().minusDays(3);\n-        Event testEvent = new Event(\"test-event-type-max\", null, profile, null, null, profile, Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n+        Event testEvent = new Event(\"test-event-type-max\", null, profile, null, null, profile,\n+                Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n         testEvent.setPersistent(true);\n         persistenceService.save(testEvent, null, true);\n         persistenceService.refreshIndex(Event.class, testEvent.getTimeStamp()); // wait for event to be fully persisted and indexed\n \n         // insure the profile is not yet engaged since we directly saved the event in ES\n         profile = profileService.load(\"test_profile_id\");\n-        Assert.assertTrue(\"Profile should not be engaged in the scoring\", profile.getScores() == null || !profile.getScores().containsKey(\"past-event-scoring-test-max\"));\n+        Assert.assertTrue(\"Profile should not be engaged in the scoring\",\n+                profile.getScores() == null || !profile.getScores().containsKey(\"past-event-scoring-test-max\"));\n \n         // now recalculate the past event conditions\n         segmentService.recalculatePastEventConditions();\n         persistenceService.refreshIndex(Profile.class, null);\n-        keepTrying(\"Profile should be engaged in the scoring with a score of 50\",\n-                () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> updatedProfile.getScores() != null &&\n-                        updatedProfile.getScores().containsKey(\"past-event-scoring-test-max\") &&\n-                        updatedProfile.getScores().get(\"past-event-scoring-test-max\") == 50,\n+        keepTrying(\"Profile should be engaged in the scoring with a score of 50\", () -> profileService.load(\"test_profile_id\"),\n+                updatedProfile -> updatedProfile.getScores() != null && updatedProfile.getScores()\n+                        .containsKey(\"past-event-scoring-test-max\") && updatedProfile.getScores().get(\"past-event-scoring-test-max\") == 50,\n                 1000, 20);\n \n         // Persist the 2 event (do not send it into the system so that it will not be processed by the rules)\n         defaultZoneId = ZoneId.systemDefault();\n         localDate = LocalDate.now().minusDays(3);\n-        testEvent = new Event(\"test-event-type-max\", null, profile, null, null, profile, Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n+        testEvent = new Event(\"test-event-type-max\", null, profile, null, null, profile,\n+                Date.from(localDate.atStartOfDay(defaultZoneId).toInstant()));\n         testEvent.setPersistent(true);\n         persistenceService.save(testEvent, null, true);\n         persistenceService.refreshIndex(Event.class, testEvent.getTimeStamp()); // wait for event to be fully persisted and indexed\n \n         // now recalculate the past event conditions\n         segmentService.recalculatePastEventConditions();\n         persistenceService.refreshIndex(Profile.class, null);\n-        keepTrying(\"Profile should not be engaged in the scoring anymore\",\n-                () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> !updatedProfile.getScores().containsKey(\"past-event-scoring-test-max\"),\n-                1000, 20);\n+        keepTrying(\"Profile should not be engaged in the scoring anymore\", () -> profileService.load(\"test_profile_id\"),\n+                updatedProfile -> !updatedProfile.getScores().containsKey(\"past-event-scoring-test-max\"), 1000, 20);\n     }\n \n     @Test\n-    @Ignore\n     public void testScoringRecalculation() throws Exception {\n         // create Profile\n         Profile profile = new Profile();\n@@ -531,8 +527,9 @@ public void testScoringRecalculation() throws Exception {\n         pastEventCondition.setParameter(\"minimumEventCount\", 1);\n         pastEventCondition.setParameter(\"maximumEventCount\", 2);\n \n-        pastEventCondition.setParameter(\"fromDate\",\"2000-07-15T07:00:00Z\");\n-        pastEventCondition.setParameter(\"toDate\",\"2001-01-15T07:00:00Z\");;\n+        pastEventCondition.setParameter(\"fromDate\", \"2000-07-15T07:00:00Z\");\n+        pastEventCondition.setParameter(\"toDate\", \"2001-01-15T07:00:00Z\");\n+        ;\n         Condition pastEventEventCondition = new Condition(definitionsService.getConditionType(\"eventTypeCondition\"));\n         pastEventEventCondition.setParameter(\"eventTypeId\", \"test-event-type\");\n         pastEventCondition.setParameter(\"eventCondition\", pastEventEventCondition);\n@@ -547,41 +544,47 @@ public void testScoringRecalculation() throws Exception {\n         scoringElements.add(scoringElement);\n         scoring.setElements(scoringElements);\n         segmentService.setScoringDefinition(scoring);\n-        refreshPersistence(Scoring.class, Profile.class);\n+        refreshPersistence(Segment.class);\n \n         // Send 2 events that match the scoring plan.\n         profile = profileService.load(\"test_profile_id\");\n         Event testEvent = new Event(\"test-event-type\", null, profile, null, null, profile, timestampEventInRange);\n         testEvent.setPersistent(true);\n         eventService.send(testEvent);\n-        persistenceService.refreshIndex(Event.class, timestampEventInRange);\n+        refreshPersistence(Event.class);\n         // 2nd event\n         testEvent = new Event(\"test-event-type\", null, testEvent.getProfile(), null, null, testEvent.getProfile(), timestampEventInRange);\n         eventService.send(testEvent);\n-        persistenceService.refreshIndex(Event.class, timestampEventInRange);\n+        refreshPersistence(Event.class, Profile.class);\n \n         // insure the profile is engaged;\n-        Assert.assertTrue(\"Profile should have 2 events in the scoring\",  (Long) ((Map) testEvent.getProfile().getSystemProperties().get(\"pastEvents\")).get(pastEventCondition.getParameterValues().get(\"generatedPropertyKey\")) == 2);\n-        Assert.assertTrue(\"Profile is engaged\",  testEvent.getProfile().getScores().containsKey(\"past-event-scoring-test\") && testEvent.getProfile().getScores().get(\"past-event-scoring-test\") == 50);\n+        try {\n+            Assert.assertTrue(\"Profile should have 2 events in the scoring\",\n+                    (Long) ((Map) testEvent.getProfile().getSystemProperties().get(\"pastEvents\"))\n+                            .get(pastEventCondition.getParameterValues().get(\"generatedPropertyKey\")) == 2);\n+            Assert.assertTrue(\"Profile is engaged\", testEvent.getProfile().getScores().containsKey(\"past-event-scoring-test\")\n+                    && testEvent.getProfile().getScores().get(\"past-event-scoring-test\") == 50);\n+        } catch (Exception e) {\n+            Assert.fail(\"Unable to read past event because \" + e.getMessage());\n+        }\n         profileService.save(testEvent.getProfile());\n         refreshPersistence(Profile.class);\n         // recalculate event conditions\n         segmentService.recalculatePastEventConditions();\n         // insure the profile is still engaged after recalculate;\n-        keepTrying(\"Profile should have 2 events in the scoring\",\n-                () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> {\n-                    try {\n-                        boolean eventCounted = (Integer) ((Map) updatedProfile.getSystemProperties().get(\"pastEvents\")).get(pastEventCondition.getParameterValues().get(\"generatedPropertyKey\")) == 2;\n-                        boolean profileEngaged = updatedProfile.getScores().containsKey(\"past-event-scoring-test\") && updatedProfile.getScores().get(\"past-event-scoring-test\") == 50;\n-                        return eventCounted && profileEngaged;\n-                    } catch (Exception e) {\n-                        // Do nothing, unable to read value\n-                    };\n-                    return false;\n-                },\n-                1000, 20);\n-\n+        keepTrying(\"Profile should have 2 events in the scoring\", () -> profileService.load(\"test_profile_id\"), updatedProfile -> {\n+            try {\n+                boolean eventCounted = (Integer) ((Map) updatedProfile.getSystemProperties().get(\"pastEvents\"))\n+                        .get(pastEventCondition.getParameterValues().get(\"generatedPropertyKey\")) == 2;\n+                boolean profileEngaged = updatedProfile.getScores().containsKey(\"past-event-scoring-test\")\n+                        && updatedProfile.getScores().get(\"past-event-scoring-test\") == 50;\n+                return eventCounted && profileEngaged;\n+            } catch (Exception e) {\n+                // Do nothing, unable to read value\n+            }\n+            ;\n+            return false;\n+        }, 1000, 20);\n \n         // Add one more event\n         testEvent = new Event(\"test-event-type\", null, testEvent.getProfile(), null, null, testEvent.getProfile(), timestampEventInRange);\n@@ -599,17 +602,15 @@ public void testScoringRecalculation() throws Exception {\n         segmentService.recalculatePastEventConditions();\n         refreshPersistence(Profile.class);\n         // As 3 events have match, the profile should not be part of the scoring plan.\n-        keepTrying(\"Profile should not be part of the scoring anymore\",\n-                () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> {\n-                    try {\n-                        return updatedProfile.getScores().get(\"past-event-scoring-test\") == 0;\n-                    } catch (Exception e) {\n-                        // Do nothing, unable to read value\n-                    };\n-                    return false;\n-                },\n-                1000, 20);\n+        keepTrying(\"Profile should not be part of the scoring anymore\", () -> profileService.load(\"test_profile_id\"), updatedProfile -> {\n+            try {\n+                return updatedProfile.getScores().get(\"past-event-scoring-test\") == 0;\n+            } catch (Exception e) {\n+                // Do nothing, unable to read value\n+            }\n+            ;\n+            return false;\n+        }, 1000, 20);\n     }\n \n     @Test\n@@ -640,15 +641,17 @@ public void testLinkedItems() throws Exception {\n         refreshPersistence(Segment.class);\n         // Check linkedItems\n         List<Rule> rules = persistenceService.getAllItems(Rule.class);\n-        Rule scoringRule = rules.stream().filter(rule -> rule.getItemId().equals(pastEventCondition.getParameter(\"generatedPropertyKey\"))).findFirst().get();\n+        Rule scoringRule = rules.stream().filter(rule -> rule.getItemId().equals(pastEventCondition.getParameter(\"generatedPropertyKey\")))\n+                .findFirst().get();\n         Assert.assertEquals(\"Scoring linked Item should be one\", 1, scoringRule.getLinkedItems().size());\n \n         // save the scoring once again\n         segmentService.setScoringDefinition(scoring);\n         refreshPersistence(Segment.class);\n         // Check linkedItems\n         rules = persistenceService.getAllItems(Rule.class);\n-        scoringRule = rules.stream().filter(rule -> rule.getItemId().equals(pastEventCondition.getParameter(\"generatedPropertyKey\"))).findFirst().get();\n+        scoringRule = rules.stream().filter(rule -> rule.getItemId().equals(pastEventCondition.getParameter(\"generatedPropertyKey\")))\n+                .findFirst().get();\n         Assert.assertEquals(\"Scoring linked Item should be one\", 1, scoringRule.getLinkedItems().size());\n \n         // Remove scoring\n@@ -701,7 +704,8 @@ public void testSegmentWithRelativeDateExpressions() throws Exception {\n         // insure the profile is not yet engaged since we directly saved the profile in ES\n         profile = profileService.load(\"test_profile_id\");\n         Assert.assertFalse(\"Profile should not be engaged in the segment\", profile.getSegments().contains(\"relative-date-segment-test\"));\n-        Assert.assertTrue(\"Profile should not be engaged in the scoring\", profile.getScores() == null || !profile.getScores().containsKey(\"relative-date-scoring-test\"));\n+        Assert.assertTrue(\"Profile should not be engaged in the scoring\",\n+                profile.getScores() == null || !profile.getScores().containsKey(\"relative-date-scoring-test\"));\n \n         // Update the profile last visit to match the segment ans the scoring\n         ZoneId defaultZoneId = ZoneId.systemDefault();\n@@ -713,15 +717,15 @@ public void testSegmentWithRelativeDateExpressions() throws Exception {\n         // insure the profile is not yet engaged since we directly saved the profile in ES\n         profile = profileService.load(\"test_profile_id\");\n         Assert.assertFalse(\"Profile should not be engaged in the segment\", profile.getSegments().contains(\"relative-date-segment-test\"));\n-        Assert.assertTrue(\"Profile should not be engaged in the scoring\", profile.getScores() == null || profile.getScores().containsKey(\"relative-date-scoring-test\"));\n+        Assert.assertTrue(\"Profile should not be engaged in the scoring\",\n+                profile.getScores() == null || profile.getScores().containsKey(\"relative-date-scoring-test\"));\n \n         // now force the recalculation of the date relative segments/scorings\n         segmentService.recalculatePastEventConditions();\n         persistenceService.refreshIndex(Profile.class, null);\n-        keepTrying(\"Profile should be engaged in the segment and scoring\",\n-                () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> updatedProfile.getSegments().contains(\"relative-date-segment-test\") && updatedProfile.getScores() != null && updatedProfile.getScores().get(\"relative-date-scoring-test\") == 5,\n-                1000, 20);\n+        keepTrying(\"Profile should be engaged in the segment and scoring\", () -> profileService.load(\"test_profile_id\"),\n+                updatedProfile -> updatedProfile.getSegments().contains(\"relative-date-segment-test\") && updatedProfile.getScores() != null\n+                        && updatedProfile.getScores().get(\"relative-date-scoring-test\") == 5, 1000, 20);\n \n         // update the profile to a date out of date expression\n         localDate = LocalDate.now().minusDays(15);\n@@ -732,9 +736,9 @@ public void testSegmentWithRelativeDateExpressions() throws Exception {\n         // now force the recalculation of the date relative segments/scorings\n         segmentService.recalculatePastEventConditions();\n         persistenceService.refreshIndex(Profile.class, null);\n-        keepTrying(\"Profile should not be engaged in the segment and scoring anymore\",\n-                () -> profileService.load(\"test_profile_id\"),\n-                updatedProfile -> !updatedProfile.getSegments().contains(\"relative-date-segment-test\") && (updatedProfile.getScores() == null || !updatedProfile.getScores().containsKey(\"relative-date-scoring-test\")),\n-                1000, 20);\n+        keepTrying(\"Profile should not be engaged in the segment and scoring anymore\", () -> profileService.load(\"test_profile_id\"),\n+                updatedProfile -> !updatedProfile.getSegments().contains(\"relative-date-segment-test\") && (\n+                        updatedProfile.getScores() == null || !updatedProfile.getScores().containsKey(\"relative-date-scoring-test\")), 1000,\n+                20);\n     }\n }"
    }
  ],
  "fix_category": "WaitFor",
  "root_cause_category": "Async wait",
  "root_cause_subcategory": NaN
}