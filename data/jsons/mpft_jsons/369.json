{
  "id": 369,
  "repo": "rocketmq",
  "issue_url": "https://github.com/apache/rocketmq/pull/7432",
  "pr_url": "https://github.com/apache/rocketmq/pull/7432",
  "issue_description": "<!-- Please make sure the target branch is right. In most case, the target branch should be `develop`. -->\r\n\r\n### Which Issue(s) This PR Fixes\r\n\r\n<!-- Please ensure that the related issue has already been created, and [link this pull request to that issue using keywords](<https://docs.github.com/en/issues/tracking-your-work-with-issues/linking-a-pull-request-to-an-issue#linking-a-pull-request-to-an-issue-using-a-keyword>) to ensure automatic closure. -->\r\n\r\nFixes #7431\r\n\r\n### Brief Description\r\n\r\nFix flaky test of DLedgerControllerTest#testBrokerLifecycleListener\r\n\r\n### How Did You Test This Change?\r\n\r\n<!-- In order to ensure the code quality of Apache RocketMQ, we expect every pull request to have undergone thorough testing. -->\r\n",
  "files_changed": [
    {
      "filename": "controller/src/test/java/org/apache/rocketmq/controller/impl/DLedgerControllerTest.java",
      "status": "modified",
      "patch": "@@ -63,7 +63,8 @@ public class DLedgerControllerTest {\n     private List<String> baseDirs;\n     private List<DLedgerController> controllers;\n \n-    public DLedgerController launchController(final String group, final String peers, final String selfId, final boolean isEnableElectUncleanMaster) {\n+    public DLedgerController launchController(final String group, final String peers, final String selfId,\n+        final boolean isEnableElectUncleanMaster) {\n         String tmpdir = System.getProperty(\"java.io.tmpdir\");\n         final String path = (StringUtils.endsWith(tmpdir, File.separator) ? tmpdir : tmpdir + File.separator) + group + File.separator + selfId;\n         baseDirs.add(path);\n@@ -121,11 +122,11 @@ public void registerNewBroker(Controller leader, String clusterName, String brok\n         final RegisterBrokerToControllerRequestHeader registerBrokerToControllerRequestHeader = new RegisterBrokerToControllerRequestHeader(clusterName, brokerName, nextBrokerId, brokerAddress);\n         RemotingCommand remotingCommand2 = leader.registerBroker(registerBrokerToControllerRequestHeader).get(2, TimeUnit.SECONDS);\n \n-\n         assertEquals(ResponseCode.SUCCESS, remotingCommand2.getCode());\n     }\n \n-    public void brokerTryElectMaster(Controller leader, String clusterName, String brokerName, String brokerAddress, Long brokerId,\n+    public void brokerTryElectMaster(Controller leader, String clusterName, String brokerName, String brokerAddress,\n+        Long brokerId,\n         boolean exceptSuccess) throws Exception {\n         final ElectMasterRequestHeader electMasterRequestHeader = ElectMasterRequestHeader.ofBrokerTrigger(clusterName, brokerName, brokerId);\n         RemotingCommand command = leader.electMaster(electMasterRequestHeader).get(2, TimeUnit.SECONDS);\n@@ -186,9 +187,9 @@ public DLedgerController mockMetaData(boolean enableElectUncleanMaster) throws E\n         registerNewBroker(leader, DEFAULT_CLUSTER_NAME, DEFAULT_BROKER_NAME, DEFAULT_IP[1], 2L);\n         registerNewBroker(leader, DEFAULT_CLUSTER_NAME, DEFAULT_BROKER_NAME, DEFAULT_IP[2], 3L);\n         // try elect\n-        brokerTryElectMaster(leader, DEFAULT_CLUSTER_NAME, DEFAULT_BROKER_NAME, DEFAULT_IP[0], 1L,true);\n-        brokerTryElectMaster(leader, DEFAULT_CLUSTER_NAME, DEFAULT_BROKER_NAME, DEFAULT_IP[1], 2L,  false);\n-        brokerTryElectMaster(leader, DEFAULT_CLUSTER_NAME, DEFAULT_BROKER_NAME, DEFAULT_IP[2], 3L,false);\n+        brokerTryElectMaster(leader, DEFAULT_CLUSTER_NAME, DEFAULT_BROKER_NAME, DEFAULT_IP[0], 1L, true);\n+        brokerTryElectMaster(leader, DEFAULT_CLUSTER_NAME, DEFAULT_BROKER_NAME, DEFAULT_IP[1], 2L, false);\n+        brokerTryElectMaster(leader, DEFAULT_CLUSTER_NAME, DEFAULT_BROKER_NAME, DEFAULT_IP[2], 3L, false);\n         final RemotingCommand getInfoResponse = leader.getReplicaInfo(new GetReplicaInfoRequestHeader(DEFAULT_BROKER_NAME)).get(10, TimeUnit.SECONDS);\n         final GetReplicaInfoResponseHeader replicaInfo = (GetReplicaInfoResponseHeader) getInfoResponse.readCustomHeader();\n         assertEquals(1, replicaInfo.getMasterEpoch().intValue());\n@@ -239,6 +240,8 @@ public void testElectMaster() throws Exception {\n     @Test\n     public void testBrokerLifecycleListener() throws Exception {\n         final DLedgerController leader = mockMetaData(false);\n+\n+        assertTrue(leader.isLeaderState());\n         // Mock that master broker has been inactive, and try to elect a new master from sync-state-set\n         // But we shut down two controller, so the ElectMasterEvent will be appended to DLedger failed.\n         // So the statemachine still keep the stale master's information\n@@ -247,15 +250,20 @@ public void testBrokerLifecycleListener() throws Exception {\n             dLedgerController.shutdown();\n             controllers.remove(dLedgerController);\n         }\n+\n         final ElectMasterRequestHeader request = ElectMasterRequestHeader.ofControllerTrigger(DEFAULT_BROKER_NAME);\n         setBrokerElectPolicy(leader, 1L);\n         Exception exception = null;\n+        RemotingCommand remotingCommand = null;\n         try {\n-            leader.electMaster(request).get(5, TimeUnit.SECONDS);\n+            remotingCommand = leader.electMaster(request).get(5, TimeUnit.SECONDS);\n         } catch (Exception e) {\n             exception = e;\n         }\n-        assertNotNull(exception);\n+\n+        assertTrue(exception != null ||\n+            remotingCommand != null && remotingCommand.getCode() == ResponseCode.CONTROLLER_NOT_LEADER);\n+\n         // Shut down leader controller\n         leader.shutdown();\n         controllers.remove(leader);\n@@ -272,7 +280,7 @@ public void testBrokerLifecycleListener() throws Exception {\n         setBrokerAlivePredicate(newLeader, 1L);\n         // Check if the statemachine is stale\n         final RemotingCommand resp = newLeader.getReplicaInfo(new GetReplicaInfoRequestHeader(DEFAULT_BROKER_NAME)).\n-                get(10, TimeUnit.SECONDS);\n+            get(10, TimeUnit.SECONDS);\n         final GetReplicaInfoResponseHeader replicaInfo = (GetReplicaInfoResponseHeader) resp.readCustomHeader();\n         assertEquals(1, replicaInfo.getMasterBrokerId().longValue());\n         assertEquals(1, replicaInfo.getMasterEpoch().intValue());"
    }
  ],
  "fix_category": "Reorder execution",
  "root_cause_category": "Concurrency",
  "root_cause_subcategory": NaN
}