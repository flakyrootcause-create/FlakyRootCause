{
  "id": 71,
  "repo": "risingwave",
  "issue_url": "https://github.com/risingwavelabs/risingwave/pull/22874",
  "pr_url": "https://github.com/risingwavelabs/risingwave/pull/22874",
  "issue_description": "I hereby agree to the terms of the [RisingWave Labs, Inc. Contributor License Agreement](https://raw.githubusercontent.com/risingwavelabs/risingwave/17af8a747593ebdbfa826691daf75bdab7d14fa0/.github/contributor-license-agreement.txt).\r\n\r\nissue: resolve #22872 \r\n\r\n## What's changed and what's your intention?\r\n\r\nTests under src/storage/src/vector/distance.rs used a signed difference to compare floating-point values:\r\n`($first - $second) < FLOAT_ALLOWED_BIAS`\r\n\r\nThis is asymmetric and can let large negative differences pass. After upgrading CMake I also observed a drift (~1.2e-5) that slightly exceeds the current 1e-5 epsilon causing the test to fail locally.\r\n\r\nObserved failure: `Expected: 31.531513, Actual: 31.531525  (|\u0394| \u2248 1.2e-5)`\r\n\r\n**This PR:**\r\n- Fixes the logic to compare absolute difference.\r\n- Uses a combined absolute + relative tolerance to remain strict yet robust across SIMD/FMA/BLAS/FAISS code paths.\r\n\r\n**Changes:**\r\n- Replace the signed comparison with abs() on the difference, this measures the magnitude of the difference, so both positive and negative deviations are caught.\r\n- Introduce FLOAT_ABS_EPS = 2e-5 and FLOAT_REL_EPS = 1e-6 to allow for expected noise while still detecting genuine errors.\r\n- The tolerance is computed as the larger of the absolute floor (FLOAT_ABS_EPS) and a scaled relative term (FLOAT_REL_EPS * max(|a|, |b|)). This relative component adjusts the allowed difference based on the magnitude of the values, ensuring the comparison remains fair and consistent across both small and large numbers.\r\n\r\n<!--\r\n\r\n**Please do not leave this empty!**\r\n\r\nPlease explain **IN DETAIL** what the changes are in this PR and why they are needed:\r\n\r\n- Summarize your change (**mandatory**)\r\n- How does this PR work? Need a brief introduction for the changed logic (optional)\r\n- Describe clearly one logical change and avoid lazy messages (optional)\r\n- Describe any limitations of the current code (optional)\r\n- Refer to a related PR or issue link (optional)\r\n\r\n-->\r\n\r\n## Checklist\r\n\r\n- [ ] I have written necessary rustdoc comments.\r\n- [ ] <!-- OPTIONAL --> I have added necessary unit tests and integration tests.\r\n- [ ] <!-- OPTIONAL --> I have added test labels as necessary. <!-- See https://github.com/risingwavelabs/risingwave/blob/main/docs/developer-guide.md#ci-labels-guide) -->\r\n- [ ] <!-- OPTIONAL --> I have added fuzzing tests or opened an issue to track them. <!-- Recommended for new SQL features, see #7934 -->\r\n- [ ] <!-- OPTIONAL --> My PR contains breaking changes. <!-- If it deprecates some features, please create a tracking issue to remove them in the future -->\r\n- [ ] <!-- OPTIONAL --> My PR changes performance-critical code, so I will run (micro) benchmarks and present the results. <!-- To manually trigger a benchmark, please check out [Notion](https://www.notion.so/risingwave-labs/Manually-trigger-nexmark-performance-dashboard-test-b784f1eae1cf48889b2645d020b6b7d3). -->\r\n- [ ] <!-- OPTIONAL --> I have checked the [Release Timeline](https://github.com/risingwavelabs/rw-commits-history/blob/main/release_timeline.md) and [Currently Supported Versions](https://docs.risingwave.com/changelog/release-support-policy#support-end-dates-for-recent-releases) to determine which release branches I need to cherry-pick this PR into. <!-- Please check out the [details](https://github.com/risingwavelabs/risingwave/blob/main/CONTRIBUTING.md) -->\r\n\r\n\r\n## Documentation\r\n\r\n- [ ] <!-- OPTIONAL --> My PR needs documentation updates. <!-- Please use the **Release note** section below to summarize the impact on users -->\r\n\r\n<details>\r\n<summary><b>Release note</b></summary>\r\n\r\n<!--\r\nIf this PR includes changes that directly affect users or other significant modifications relevant to the community, kindly draft a release note to provide a concise summary of these changes.\r\n\r\nPlease prioritize highlighting the impact these changes will have on users.\r\nDiscuss technical details in the \"What's changed\" section, and focus on the impact on users in the release note.\r\n\r\nYou should also mention the environment or conditions where the impact may occur.\r\n-->\r\n\r\n</details>\r\n",
  "files_changed": [
    {
      "filename": "src/storage/src/vector/distance.rs",
      "status": "modified",
      "patch": "@@ -235,17 +235,24 @@ mod tests {\n         0.22877127, 0.97690505, 0.44438475,\n     ];\n \n-    const FLOAT_ALLOWED_BIAS: f32 = 1e-5;\n+    const FLOAT_ABS_EPS: f32 = 2e-5;\n+    const FLOAT_REL_EPS: f32 = 1e-6;\n \n     macro_rules! assert_eq_float {\n-        ($first:expr, $second:expr) => {\n+        ($first:expr, $second:expr) => {{\n+            let a: f32 = $first;\n+            let b: f32 = $second;\n+            let diff = (a - b).abs();\n+            let tol = FLOAT_ABS_EPS.max(FLOAT_REL_EPS * a.abs().max(b.abs()));\n             assert!(\n-                ($first - $second) < FLOAT_ALLOWED_BIAS,\n-                \"Expected: {}, Actual: {}\",\n-                $second,\n-                $first\n+                diff <= tol,\n+                \"Expected: {}, Actual: {}, |\u0394|={} > tol={}\",\n+                b,\n+                a,\n+                diff,\n+                tol\n             );\n-        };\n+        }};\n     }\n \n     #[test]"
    }
  ],
  "fix_category": "Change assertion",
  "root_cause_category": "Floating point operations",
  "root_cause_subcategory": NaN
}