{
  "id": 386,
  "repo": "airflow",
  "issue_url": "https://github.com/apache/airflow/pull/42028",
  "pr_url": "https://github.com/apache/airflow/pull/42028",
  "issue_description": "[PR Linked Issue]\n### Body\n\nThe test_listener_logs_failed_serialization is flaky - likely due to a race condition. This should be improve.\r\n\r\nExample failure: \r\n\r\nhttps://github.com/apache/airflow/actions/runs/10714765649/job/29709338209?pr=41331#step:7:5256\r\n\r\n\r\n```\r\n=================================== FAILURES ===================================\r\n___________________ test_listener_logs_failed_serialization ____________________\r\n\r\nself = <MagicMock name='mock.warning' id='139678763968448'>\r\n\r\n    def assert_called_once(self):\r\n        \"\"\"assert that the mock was called only once.\r\n        \"\"\"\r\n        if not self.call_count == 1:\r\n            msg = (\"Expected '%s' to have been called once. Called %s times.%s\"\r\n                   % (self._mock_name or 'mock',\r\n                      self.call_count,\r\n                      self._calls_repr()))\r\n>           raise AssertionError(msg)\r\nE           AssertionError: Expected 'warning' to have been called once. Called 0 times.\r\n\r\n/usr/local/lib/python3.8/unittest/mock.py:892: AssertionError\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\n    def test_listener_logs_failed_serialization():\r\n        listener = OpenLineageListener()\r\n        listener.log = MagicMock()\r\n        listener.adapter = OpenLineageAdapter(\r\n            client=OpenLineageClient(transport=ConsoleTransport(config=ConsoleConfig()))\r\n        )\r\n        event_time = dt.datetime.now()\r\n    \r\n        fut = listener.submit_callable(\r\n            listener.adapter.dag_failed,\r\n            dag_id=\"\",\r\n            run_id=\"\",\r\n            end_date=event_time,\r\n            execution_date=threading.Thread(),\r\n            dag_run_state=DagRunState.FAILED,\r\n            task_ids=[\"task_id\"],\r\n            msg=\"\",\r\n        )\r\n        assert fut.exception(10)\r\n>       listener.log.warning.assert_called_once()\r\nE       AssertionError: Expected 'warning' to have been called once. Called 0 times.\r\n\r\ntests/providers/openlineage/plugins/test_listener.py:628: AssertionError\r\n----------------------------- Captured stdout call -----------------------------\r\n```\n\n### Committer\n\n- [X] I acknowledge that I am a maintainer/committer of the Apache Airflow project.",
  "files_changed": [
    {
      "filename": "tests/providers/openlineage/plugins/test_listener.py",
      "status": "modified",
      "patch": "@@ -17,8 +17,8 @@\n from __future__ import annotations\n \n import datetime as dt\n-import threading\n import uuid\n+from concurrent.futures import Future\n from contextlib import suppress\n from typing import Callable\n from unittest import mock\n@@ -606,26 +606,33 @@ def test_listener_on_dag_run_state_changes_configure_process_pool_size(mock_exec\n     mock_executor.return_value.submit.assert_called_once()\n \n \n-@pytest.mark.flaky(reruns=5)\n def test_listener_logs_failed_serialization():\n     listener = OpenLineageListener()\n+    callback_future = Future()\n+\n+    def set_result(*args, **kwargs):\n+        callback_future.set_result(True)\n+\n     listener.log = MagicMock()\n+    listener.log.warning = MagicMock(side_effect=set_result)\n     listener.adapter = OpenLineageAdapter(\n         client=OpenLineageClient(transport=ConsoleTransport(config=ConsoleConfig()))\n     )\n     event_time = dt.datetime.now()\n-\n     fut = listener.submit_callable(\n         listener.adapter.dag_failed,\n         dag_id=\"\",\n         run_id=\"\",\n         end_date=event_time,\n-        execution_date=threading.Thread(),\n+        execution_date=callback_future,\n         dag_run_state=DagRunState.FAILED,\n         task_ids=[\"task_id\"],\n         msg=\"\",\n     )\n     assert fut.exception(10)\n+    callback_future.result(10)\n+    assert callback_future.done()\n+    listener.log.debug.assert_not_called()\n     listener.log.warning.assert_called_once()\n \n "
    }
  ],
  "fix_category": "WaitFor",
  "root_cause_category": "Async wait",
  "root_cause_subcategory": NaN
}