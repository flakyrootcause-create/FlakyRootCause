{
  "id": 249,
  "repo": "hadoop",
  "issue_url": "https://github.com/apache/hadoop/pull/6417",
  "pr_url": "https://github.com/apache/hadoop/pull/6417",
  "issue_description": "<!--\r\n  Thanks for sending a pull request!\r\n    1. If this is your first time, please read our contributor guidelines: https://cwiki.apache.org/confluence/display/HADOOP/How+To+Contribute\r\n    2. Make sure your PR title starts with JIRA issue id, e.g., 'HADOOP-17799. Your PR title ...'.\r\n-->\r\n\r\n### Description of PR\r\n\r\nJIRA: YARN-11642. Fix Flaky Test TestTimelineAuthFilterForV2#testPutTimelineEntities.\r\n\r\nWe can find the following unit test failure report:\r\n\r\n[Report1\r\n](https://ci-hadoop.apache.org/job/hadoop-multibranch/job/PR-6410/1/testReport/org.apache.hadoop.yarn.server.timelineservice.security/TestTimelineAuthFilterForV2/testPutTimelineEntities_boolean__boolean__3_/)\r\n\r\n```\r\norg.opentest4j.AssertionFailedError: expected: <2> but was: <1>\r\n...\r\nat org.apache.hadoop.yarn.server.timelineservice.security.TestTimelineAuthFilterForV2.publishAndVerifyEntity(TestTimelineAuthFilterForV2.java:324)\r\nat org.apache.hadoop.yarn.server.timelineservice.security.TestTimelineAuthFilterForV2.publishWithRetries(TestTimelineAuthFilterForV2.java:337)\r\nat org.apache.hadoop.yarn.server.timelineservice.security.TestTimelineAuthFilterForV2.testPutTimelineEntities(TestTimelineAuthFilterForV2.java:383)\r\n```\r\n\r\n[Report2\r\n](https://ci-hadoop.apache.org/job/hadoop-multibranch/job/PR-6396/2/testReport/org.apache.hadoop.yarn.server.timelineservice.security/TestTimelineAuthFilterForV2/testPutTimelineEntities_boolean__boolean__3_/)\r\n\r\n```\r\nexpected: <true> but was: <false>\r\n...\r\nat org.apache.hadoop.yarn.server.timelineservice.security.TestTimelineAuthFilterForV2.verifyEntity(TestTimelineAuthFilterForV2.java:294)\r\nat org.apache.hadoop.yarn.server.timelineservice.security.TestTimelineAuthFilterForV2.testPutTimelineEntities(TestTimelineAuthFilterForV2.java:441)\r\n```\r\n\r\nThe reason for this error is that `PerNodeTimelineCollectorsAuxService` was not initialized normally.\r\n\r\n```\r\n2024-01-05 09:34:21,511 WARN  [main] collector.PerNodeTimelineCollectorsAuxService (StringUtils.java:startupShutdownMessage(755)) - failed to register any UNIX signal loggers: \r\njava.lang.IllegalStateException: Can't re-install the signal handlers.\r\nat org.apache.hadoop.util.SignalLogger.register(SignalLogger.java:73)\r\nat org.apache.hadoop.util.StringUtils.startupShutdownMessage(StringUtils.java:753)\r\n... \r\n```\r\n\r\n`PerNodeTimelineCollectorsAuxService` is initialized using a static method and is initialized in parallel by multiple threads(because our unit tests are parallel.), resulting in an error. \r\n\r\n```\r\n/usr/bin/mvn --batch-mode -Dmaven.repo.local=/home/jenkins/jenkins-home/workspace/hadoop-multibranch_PR-6396/yetus-m2/hadoop-trunk-patch-0 -Dsurefire.rerunFailingTestsCount=2 -Pparallel-tests -Pshelltest -Pnative -Drequire.fuse -Drequire.openssl -Drequire.snappy -Drequire.valgrind -Drequire.zstd -Drequire.test.libhadoop -Pyarn-ui clean test -fae ...\r\n```\r\n\r\nWe can change the static `initialization` to `new PerNodeTimelineCollectorsAuxService()` to avoid this problem, which has been verified in the local environment.\r\n\r\n### How was this patch tested?\r\n\r\nJunit Test.\r\n\r\n### For code changes:\r\n\r\n- [ ] Does the title or this PR starts with the corresponding JIRA issue id (e.g. 'HADOOP-17799. Your PR title ...')?\r\n- [ ] Object storage: have the integration tests been executed and the endpoint declared according to the connector-specific documentation?\r\n- [ ] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?\r\n- [ ] If applicable, have you updated the `LICENSE`, `LICENSE-binary`, `NOTICE-binary` files?\r\n\r\n",
  "files_changed": [
    {
      "filename": "hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-tests/src/test/java/org/apache/hadoop/yarn/server/timelineservice/security/TestTimelineAuthFilterForV2.java",
      "status": "modified",
      "patch": "@@ -211,7 +211,8 @@ public void initialize() throws Exception {\n     }\n     UserGroupInformation.setConfiguration(conf);\n     collectorManager = new DummyNodeTimelineCollectorManager();\n-    auxService = PerNodeTimelineCollectorsAuxService.launchServer(\n+    PerNodeTimelineCollectorsAuxService as = new PerNodeTimelineCollectorsAuxService();\n+    auxService = as.launchServer(\n         new String[0], collectorManager, conf);\n     if (withKerberosLogin) {\n       SecurityUtil.login(conf, YarnConfiguration.TIMELINE_SERVICE_KEYTAB,"
    }
  ],
  "fix_category": "Make deterministic",
  "root_cause_category": "Concurrency",
  "root_cause_subcategory": NaN
}