{
  "id": 163,
  "repo": "sentry-python",
  "issue_url": "https://github.com/getsentry/sentry-python/pull/4052",
  "pr_url": "https://github.com/getsentry/sentry-python/pull/4052",
  "issue_description": "Not too sure what the problem is exactly but my suspicion is that the profiler runs in a separate thread and needs time to flush the chunk, the test wasn't waiting long enough.",
  "files_changed": [
    {
      "filename": "tests/profiler/test_continuous_profiler.py",
      "status": "modified",
      "patch": "@@ -127,7 +127,7 @@ def test_continuous_profiler_setup_twice(mode, make_options, teardown_profiling)\n \n \n def assert_single_transaction_with_profile_chunks(\n-    envelopes, thread, max_chunks, transactions=1\n+    envelopes, thread, max_chunks=None, transactions=1\n ):\n     items = defaultdict(list)\n     for envelope in envelopes:\n@@ -136,7 +136,8 @@ def assert_single_transaction_with_profile_chunks(\n \n     assert len(items[\"transaction\"]) == transactions\n     assert len(items[\"profile_chunk\"]) > 0\n-    assert len(items[\"profile_chunk\"]) <= max_chunks\n+    if max_chunks is not None:\n+        assert len(items[\"profile_chunk\"]) <= max_chunks\n \n     transaction = items[\"transaction\"][0].payload.json\n \n@@ -235,7 +236,7 @@ def test_continuous_profiler_auto_start_and_manual_stop(\n         with sentry_sdk.start_span(op=\"op\"):\n             time.sleep(0.05)\n \n-    assert_single_transaction_with_profile_chunks(envelopes, thread, max_chunks=10)\n+    assert_single_transaction_with_profile_chunks(envelopes, thread)\n \n     for _ in range(3):\n         stop_profiler()\n@@ -256,7 +257,7 @@ def test_continuous_profiler_auto_start_and_manual_stop(\n             with sentry_sdk.start_span(op=\"op\"):\n                 time.sleep(0.05)\n \n-        assert_single_transaction_with_profile_chunks(envelopes, thread, max_chunks=10)\n+        assert_single_transaction_with_profile_chunks(envelopes, thread)\n \n \n @pytest.mark.parametrize(\n@@ -299,18 +300,27 @@ def test_continuous_profiler_manual_start_and_stop_sampled(\n         envelopes.clear()\n \n         with sentry_sdk.start_transaction(name=\"profiling\"):\n+            assert get_profiler_id() is not None, \"profiler should be running\"\n             with sentry_sdk.start_span(op=\"op\"):\n-                time.sleep(0.05)\n+                time.sleep(0.1)\n+            assert get_profiler_id() is not None, \"profiler should be running\"\n \n-        assert_single_transaction_with_profile_chunks(envelopes, thread, max_chunks=10)\n+        assert_single_transaction_with_profile_chunks(envelopes, thread)\n+\n+        assert get_profiler_id() is not None, \"profiler should be running\"\n \n         stop_profiler()\n \n+        # the profiler stops immediately in manual mode\n+        assert get_profiler_id() is None, \"profiler should not be running\"\n+\n         envelopes.clear()\n \n         with sentry_sdk.start_transaction(name=\"profiling\"):\n+            assert get_profiler_id() is None, \"profiler should not be running\"\n             with sentry_sdk.start_span(op=\"op\"):\n-                time.sleep(0.05)\n+                time.sleep(0.1)\n+            assert get_profiler_id() is None, \"profiler should not be running\"\n \n         assert_single_transaction_without_profile_chunks(envelopes)\n \n@@ -397,17 +407,17 @@ def test_continuous_profiler_auto_start_and_stop_sampled(\n         with sentry_sdk.start_transaction(name=\"profiling 1\"):\n             assert get_profiler_id() is not None, \"profiler should be running\"\n             with sentry_sdk.start_span(op=\"op\"):\n-                time.sleep(0.03)\n+                time.sleep(0.1)\n             assert get_profiler_id() is not None, \"profiler should be running\"\n \n-        # the profiler takes a while to stop so if we start a transaction\n-        # immediately, it'll be part of the same chunk\n+        # the profiler takes a while to stop in auto mode so if we start\n+        # a transaction immediately, it'll be part of the same chunk\n         assert get_profiler_id() is not None, \"profiler should be running\"\n \n         with sentry_sdk.start_transaction(name=\"profiling 2\"):\n             assert get_profiler_id() is not None, \"profiler should be running\"\n             with sentry_sdk.start_span(op=\"op\"):\n-                time.sleep(0.03)\n+                time.sleep(0.1)\n             assert get_profiler_id() is not None, \"profiler should be running\"\n \n         # wait at least 1 cycle for the profiler to stop"
    }
  ],
  "fix_category": "Sleep",
  "root_cause_category": "Async wait",
  "root_cause_subcategory": NaN
}