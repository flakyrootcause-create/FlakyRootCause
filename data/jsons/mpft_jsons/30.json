{
  "id": 30,
  "repo": "next.js",
  "issue_url": "https://github.com/vercel/next.js/commit/222f7f5b1e42e6107c39895e639e04d53d49da8d",
  "pr_url": "https://github.com/vercel/next.js/commit/222f7f5b1e42e6107c39895e639e04d53d49da8d",
  "issue_description": "We currently use `package.json` for our configuration. I think we should move away from using `package.json` and use something like `next.config.js` since it gives us more power than JSON.\r\n\r\nAn example is the issue for custom Webpack support: https://github.com/zeit/next.js/issues/40.\r\nWith a config like this you could do this for example:\r\n\r\n```js\r\n// next.config.js\r\n\r\nexport default {\r\n  webpack: (webpackConfig) => {\r\n    const newConfig = { ...webpackConfig };\r\n    newConfig.module.preloaders.push({ test: /\\.js$/, loader: 'eslint-loader' });\r\n    return newConfig;\r\n  },\r\n  cdn: false\r\n}\r\n```\r\n\r\nWhich is in my opinion better than creating a new file for webpack since this is more centralised. This does however still give users the option to use different files, for the webpack example:\r\n\r\n```js\r\n// next.config.js\r\n\r\nexport default {\r\n  webpack: require('./webpack').default,\r\n  cdn: false\r\n}\r\n```\r\n\r\nThese are just my thoughts, I found out that I needed a sort of config file in `.js` when starting a PR for this project. Very curious what others think of this \ud83d\ude04.",
  "files_changed": [
    {
      "filename": "README.md",
      "status": "modified",
      "patch": "@@ -285,6 +285,66 @@ Then run `now` and enjoy!\n \n Note: we recommend putting `.next` in `.npmignore` or `.gitignore`. Otherwise, use `files` or `now.files` to opt-into a whitelist of files you want to deploy (and obviously exclude `.next`)\n \n+## Configuration\n+\n+While Next.js aims to work without any configuration, sometimes there is a need to add custom behaviour.\n+You can define custom configuration in a file called `next.config.js` in the project root directory.\n+An example of a configuration looks like this:\n+\n+```javascript\n+// next.config.js\n+module.exports = {\n+  cdn: true\n+}\n+```\n+\n+### Customizing webpack config\n+\n+Sometimes the user needs to have custom configuration for webpack to add a specific behaviour in the build process.\n+An example of this is using `eslint-loader` to lint the files before compiling. This can be done by defining \n+`webpack` in the config.\n+\n+```javascript\n+module.exports = {\n+  webpack: (webpackConfig, { dev }) => {\n+    webpackConfig.module.preLoaders.push({ test: /\\.js$/, loader: 'eslint-loader' })\n+    return webpackConfig\n+  }\n+}\n+```\n+\n+As you can see you need to provide a function which has two parameters `webpackConfig`, which is the config used by Next.js, and `options`, which contains\n+`dev` (`true` if dev environment). The config you return is the config used by Next.js.\n+You can also return a `Promise` which will be resolved first.\n+\n+_NOTE: Use this option with care, because you can potentially break the existing webpack build configuration by using this option._\n+\n+These are some more examples:\n+\n+```javascript\n+const I18nPlugin = require('i18n-webpack-plugin');\n+\n+module.exports = {\n+  webpack: (webpackConfig, { dev }) => {\n+    // Read image files:\n+    webpackConfig.module.loaders.push({\n+      test: /\\.png$/,\n+      loader: 'file'\n+    })\n+\n+    // Adding a plugin\n+    webpackConfig.plugins.push(new I18nPlugin())\n+\n+    // Or adding an alias\n+    // Create webpackConfig.resolve.alias if it doesn't exist yet:\n+    webpackConfig.resolve.alias = webpackConfig.resolve.alias || {}\n+    webpackConfig.resolve.alias.src = './src'\n+\n+    return webpackConfig\n+  }\n+}\n+```\n+\n ## FAQ\n \n <details>\n@@ -423,7 +483,7 @@ For this reason we want to promote a situation where users can share the cache f\n \n We are committed to providing a great uptime and levels of security for our CDN. Even so, we also **automatically fall back** if the CDN script fails to load [with a simple trick](http://www.hanselman.com/blog/CDNsFailButYourScriptsDontHaveToFallbackFromCDNToLocalJQuery.aspx).\n \n-To turn the CDN off, just set `{ \u201cnext\u201d: { \u201ccdn\u201d: false } }` in `package.json`.\n+To turn the CDN off, just set `module.exports = { cdn: false }` in `next.config.js`.\n </details>\n \n <details>"
    },
    {
      "filename": "bin/next",
      "status": "modified",
      "patch": "@@ -2,6 +2,7 @@\n \n import { join } from 'path'\n import { spawn } from 'cross-spawn'\n+import { watchFile } from 'fs'\n \n const defaultCommand = 'dev'\n const commands = new Set([\n@@ -23,9 +24,26 @@ if (commands.has(cmd)) {\n \n const bin = join(__dirname, 'next-' + cmd)\n \n-const proc = spawn(bin, args, { stdio: 'inherit', customFds: [0, 1, 2] })\n-proc.on('close', (code) => process.exit(code))\n-proc.on('error', (err) => {\n-  console.error(err)\n-  process.exit(1)\n-})\n+const startProcess = () => {\n+  const proc = spawn(bin, args, { stdio: 'inherit', customFds: [0, 1, 2] })\n+  proc.on('close', (code) => process.exit(code))\n+  proc.on('error', (err) => {\n+    console.error(err)\n+    process.exit(1)\n+  })\n+  return proc\n+}\n+\n+let proc = startProcess()\n+\n+if (cmd === 'dev') {\n+  watchFile(join(process.cwd(), 'next.config.js'), (cur, prev) => {\n+    if (cur.size > 0 || prev.size > 0) {\n+      console.log('\\n> Found a change in next.config.js, restarting the server...')\n+      // Don't listen to 'close' now since otherwise parent gets killed by listener\n+      proc.removeAllListeners('close')\n+      proc.kill()\n+      proc = startProcess()\n+    }\n+  })\n+}"
    },
    {
      "filename": "server/build/webpack.js",
      "status": "modified",
      "patch": "@@ -9,6 +9,7 @@ import WatchPagesPlugin from './plugins/watch-pages-plugin'\n import WatchRemoveEventPlugin from './plugins/watch-remove-event-plugin'\n import DynamicEntryPlugin from './plugins/dynamic-entry-plugin'\n import DetachPlugin from './plugins/detach-plugin'\n+import getConfig from '../config'\n \n export default async function createCompiler (dir, { dev = false } = {}) {\n   dir = resolve(dir)\n@@ -166,7 +167,7 @@ export default async function createCompiler (dir, { dev = false } = {}) {\n     [errorDebugPath, 'dist/pages/_error-debug.js']\n   ])\n \n-  return webpack({\n+  let webpackConfig = {\n     context: dir,\n     entry,\n     output: {\n@@ -206,5 +207,11 @@ export default async function createCompiler (dir, { dev = false } = {}) {\n     customInterpolateName: function (url, name, opts) {\n       return interpolateNames.get(this.resourcePath) || url\n     }\n-  })\n+  }\n+  const config = getConfig(dir)\n+  if (config.webpack) {\n+    console.log('> Using Webpack config function defined in next.config.js.')\n+    webpackConfig = await config.webpack(webpackConfig, { dev })\n+  }\n+  return webpack(webpackConfig)\n }"
    },
    {
      "filename": "server/config.js",
      "status": "modified",
      "patch": "@@ -1,9 +1,11 @@\n import { join } from 'path'\n-import { readFile } from 'mz/fs'\n+import { existsSync } from 'fs'\n \n const cache = new Map()\n \n-const defaultConfig = {}\n+const defaultConfig = {\n+  webpack: null\n+}\n \n export default function getConfig (dir) {\n   if (!cache.has(dir)) {\n@@ -12,22 +14,16 @@ export default function getConfig (dir) {\n   return cache.get(dir)\n }\n \n-async function loadConfig (dir) {\n-  const path = join(dir, 'package.json')\n+function loadConfig (dir) {\n+  const path = join(dir, 'next.config.js')\n \n-  let data\n-  try {\n-    data = await readFile(path, 'utf8')\n-  } catch (err) {\n-    if (err.code === 'ENOENT') {\n-      data = '{}'\n-    } else {\n-      throw err\n-    }\n-  }\n+  let userConfig = {}\n \n-  // no try-cache, it must be a valid json\n-  const config = JSON.parse(data).next || {}\n+  const userHasConfig = existsSync(path)\n+  if (userHasConfig) {\n+    const userConfigModule = require(path)\n+    userConfig = userConfigModule.default || userConfigModule\n+  }\n \n-  return Object.assign({}, defaultConfig, config)\n+  return Object.assign({}, defaultConfig, userConfig)\n }"
    }
  ],
  "fix_category": "WaitFor",
  "root_cause_category": "Async wait",
  "root_cause_subcategory": NaN
}