{
  "id": 281,
  "repo": "kubernetes",
  "issue_url": "https://github.com/kubernetes/kubernetes/pull/133875",
  "pr_url": "https://github.com/kubernetes/kubernetes/pull/133875",
  "issue_description": "[PR Linked Issue]\n### Failure cluster [9ddf28290cbb0b1d7335](https://go.k8s.io/triage#9ddf28290cbb0b1d7335)\n\n##### Error text:\n```\nFailed\n=== RUN   TestApply/optional-list-map-key\napply_test.go:221: ERROR: \n        \tError Trace:\t/home/prow/go/src/k8s.io/kubernetes/test/integration/apimachinery/apply/apply_test.go:93\n        \t            \t\t\t\t/home/prow/go/src/k8s.io/kubernetes/test/integration/apimachinery/apply/apply_test.go:127\n        \t            \t\t\t\t/home/prow/go/src/k8s.io/kubernetes/test/integration/apimachinery/apply/apply_test.go:221\n        \t            \t\t\t\t/home/prow/go/src/k8s.io/kubernetes/test/utils/ktesting/tcontext.go:383\n        \tError:      \tNot equal: \n        \t            \texpected: \"- apiVersion: testapigroup.apimachinery.k8s.io/v1\\n  fieldsType: FieldsV1\\n  fieldsV1:\\n    f:status:\\n      f:infos:\\n        k:{\\\"a\\\":1,\\\"b\\\":\\\"x\\\"}:\\n          .: {}\\n          f:a: {}\\n          f:b: {}\\n          f:data: {}\\n  manager: status1\\n  operation: Apply\\n  subresource: status\\n- apiVersion: testapigroup.apimachinery.k8s.io/v1\\n  fieldsType: FieldsV1\\n  fieldsV1:\\n    f:status:\\n      f:infos:\\n        k:{\\\"a\\\":1,\\\"b\\\":\\\"y\\\"}:\\n          .: {}\\n          f:a: {}\\n          f:b: {}\\n          f:data: {}\\n        k:{\\\"a\\\":2,\\\"b\\\":\\\"y\\\"}:\\n          .: {}\\n          f:a: {}\\n          f:b: {}\\n          f:data: {}\\n  manager: status2\\n  operation: Apply\\n  subresource: status\\n\"\n        \t            \tactual  : \"- apiVersion: testapigroup.apimachinery.k8s.io/v1\\n  fieldsType: FieldsV1\\n  fieldsV1:\\n    f:status:\\n      f:infos:\\n        k:{\\\"a\\\":1,\\\"b\\\":\\\"y\\\"}:\\n          .: {}\\n          f:a: {}\\n          f:b: {}\\n          f:data: {}\\n        k:{\\\"a\\\":2,\\\"b\\\":\\\"y\\\"}:\\n          .: {}\\n          f:a: {}\\n          f:b: {}\\n          f:data: {}\\n  manager: status2\\n  operation: Apply\\n  subresource: status\\n- apiVersion: testapigroup.apimachinery.k8s.io/v1\\n  fieldsType: FieldsV1\\n  fieldsV1:\\n    f:status:\\n      f:infos:\\n        k:{\\\"a\\\":1,\\\"b\\\":\\\"x\\\"}:\\n          .: {}\\n          f:a: {}\\n          f:b: {}\\n          f:data: {}\\n  manager: status1\\n  operation: Apply\\n  subresource: status\\n\"\n        \t            \t\n        \t            \tDiff:\n        \t            \t--- Expected\n        \t            \t+++ Actual\n        \t            \t@@ -1,14 +1 @@\n        \t            \t-- apiVersion: testapigroup.apimachinery.k8s.io/v1\n        \t            \t-  fieldsType: FieldsV1\n        \t            \t-  fieldsV1:\n        \t            \t-    f:status:\n        \t            \t-      f:infos:\n        \t            \t-        k:{\"a\":1,\"b\":\"x\"}:\n        \t            \t-          .: {}\n        \t            \t-          f:a: {}\n        \t            \t-          f:b: {}\n        \t            \t-          f:data: {}\n        \t            \t-  manager: status1\n        \t            \t-  operation: Apply\n        \t            \t-  subresource: status\n        \t            \t - apiVersion: testapigroup.apimachinery.k8s.io/v1\n        \t            \t@@ -31,2 +18,15 @@\n        \t            \t   subresource: status\n        \t            \t+- apiVersion: testapigroup.apimachinery.k8s.io/v1\n        \t            \t+  fieldsType: FieldsV1\n        \t            \t+  fieldsV1:\n        \t            \t+    f:status:\n        \t            \t+      f:infos:\n        \t            \t+        k:{\"a\":1,\"b\":\"x\"}:\n        \t            \t+          .: {}\n        \t            \t+          f:a: {}\n        \t            \t+          f:b: {}\n        \t            \t+          f:data: {}\n        \t            \t+  manager: status1\n        \t            \t+  operation: Apply\n        \t            \t+  subresource: status\n        \t            \t \n        \tTest:       \tTestApply/optional-list-map-key\n        \tMessages:   \tremove status #1:\n        \t            \tapiVersion: testapigroup.apimachinery.k8s.io/v1\n        \t            \tkind: Carp\n        \t            \tmetadata:\n        \t            \t  creationTimestamp: \"2025-08-29T07:24:13Z\"\n        \t            \t  managedFields:\n        \t            \t  - apiVersion: testapigroup.apimachinery.k8s.io/v1\n        \t            \t    fieldsType: FieldsV1\n        \t            \t    fieldsV1:\n        \t            \t      f:status:\n        \t            \t        f:infos:\n        \t            \t          k:{\"a\":1,\"b\":\"y\"}:\n        \t            \t            .: {}\n        \t            \t            f:a: {}\n        \t            \t            f:b: {}\n        \t            \t            f:data: {}\n        \t            \t          k:{\"a\":2,\"b\":\"y\"}:\n        \t            \t            .: {}\n        \t            \t            f:a: {}\n        \t            \t            f:b: {}\n        \t            \t            f:data: {}\n        \t            \t    manager: status2\n        \t            \t    operation: Apply\n        \t            \t    subresource: status\n        \t            \t    time: \"2025-08-29T07:24:13Z\"\n        \t            \t  - apiVersion: testapigroup.apimachinery.k8s.io/v1\n        \t            \t    fieldsType: FieldsV1\n        \t            \t    fieldsV1:\n        \t            \t      f:status:\n        \t            \t        f:infos:\n        \t            \t          k:{\"a\":1,\"b\":\"x\"}:\n        \t            \t            .: {}\n        \t            \t            f:a: {}\n        \t            \t            f:b: {}\n        \t            \t            f:data: {}\n        \t            \t    manager: status1\n        \t            \t    operation: Apply\n        \t            \t    subresource: status\n        \t            \t    time: \"2025-08-29T07:24:14Z\"\n        \t            \t  name: test-carp\n        \t            \t  namespace: testapply-optional-list-map-key-tvqfh\n        \t            \t  resourceVersion: \"605\"\n        \t            \t  uid: a34ec7bb-a425-468a-b298-9f8ab731f2de\n        \t            \tspec: {}\n        \t            \tstatus:\n        \t            \t  infos:\n        \t            \t  - a: 1\n        \t            \t    b: x\n        \t            \t    data: status1_a1_bx\n        \t            \t  - a: 1\n        \t            \t    b: \"y\"\n        \t            \t    data: status2_a1_by\n        \t            \t  - a: 2\n        \t            \t    b: \"y\"\n        \t            \t    data: status2_a2_by\n        \n--- FAIL: TestApply/optional-list-map-key (0.75s)\n```\n\nIt looks like the order of the list entries is non-deterministic, causing a flake when the order is different than expected.\n\n\n#### Recent failures:\n[8/27/2025, 7:46:41 PM ci-kubernetes-integration-master](https://prow.k8s.io/view/gs/kubernetes-ci-logs/logs/ci-kubernetes-integration-master/1960760579014529024)\n[8/26/2025, 7:11:13 AM ci-kubernetes-integration-master](https://prow.k8s.io/view/gs/kubernetes-ci-logs/logs/ci-kubernetes-integration-master/1960208069166108672)\n[8/23/2025, 1:44:09 AM ci-kubernetes-integration-master](https://prow.k8s.io/view/gs/kubernetes-ci-logs/logs/ci-kubernetes-integration-master/1959038602079899648)\n[8/21/2025, 1:19:07 AM ci-kubernetes-integration-master](https://prow.k8s.io/view/gs/kubernetes-ci-logs/logs/ci-kubernetes-integration-master/1958307527783354368)\n\n\n/kind failing-test\n/kind flake\n/sig api-machinery\n\n",
  "files_changed": [
    {
      "filename": "test/integration/apimachinery/apply/apply_test.go",
      "status": "modified",
      "patch": "@@ -83,12 +83,20 @@ func testOptionalListMapKey(tCtx ktesting.TContext) {\n \trequireManagedFields := func(what string, obj *unstructured.Unstructured, expectedManagedFields any) {\n \t\ttCtx.Helper()\n \t\tactualManagedFields, _, _ := unstructured.NestedFieldCopy(obj.Object, \"metadata\", \"managedFields\")\n-\t\t// Strip non-deterministic time.\n \t\tif actualManagedFields != nil {\n \t\t\tmanagers := actualManagedFields.([]any)\n \t\t\tfor i := range managers {\n+\t\t\t\t// Strip non-deterministic time.\n \t\t\t\tunstructured.RemoveNestedField(managers[i].(map[string]any), \"time\")\n \t\t\t}\n+\t\t\t// Sort by manager. There should be at most one entry per manager, so\n+\t\t\t// no need for a tie breaker. Semantically the order is irrelevant,\n+\t\t\t// so we don't need to expect a specific one here.\n+\t\t\t//\n+\t\t\t// The order turned out to be non-deterministic (test flake!) without this.\n+\t\t\tslices.SortFunc(managers, func(a, b any) int {\n+\t\t\t\treturn strings.Compare(a.(map[string]any)[\"manager\"].(string), b.(map[string]any)[\"manager\"].(string))\n+\t\t\t})\n \t\t}\n \t\trequire.Equal(tCtx, dump(expectedManagedFields), dump(actualManagedFields), \"%s:\\n%s\", what, dump(obj))\n \t}"
    }
  ],
  "fix_category": "Other",
  "root_cause_category": "Unordered collections",
  "root_cause_subcategory": NaN
}