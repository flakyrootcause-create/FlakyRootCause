{
  "id": 104,
  "repo": "maven-surefire",
  "issue_url": "https://github.com/apache/maven-surefire/pull/309",
  "pr_url": "https://github.com/apache/maven-surefire/pull/309",
  "issue_description": "The changes in this pull request address issue SUREFIRE-756. Namely, the changes include\r\n\r\n- Output of the random seed used to generate a particular random test order when -Dsurefire.runOrder=random or -Dfailsafe.runOrder=random is set\r\n- Ability to replay a previously observed random test order by setting -Dsurefire.seed and -Dfailsafe.seed to the seed that observed the random test order\r\n- Tests to ensure that the setting of the _same_ random seeds do create the _same_ test orders and _different_ random seeds do create _different_ test orders. Note that the inherent randomness of the orders does mean that the tests can be flaky (nondeterministically pass or fail without changes to the code). The current tests have a rate of 0.4% ```(1/3)^5``` of failing. Increasing the number of tests (```3```) or the number of times to loop (```5```) would decrease the odds of the tests failing.",
  "files_changed": [
    {
      "filename": "maven-failsafe-plugin/src/main/java/org/apache/maven/plugin/failsafe/IntegrationTestMojo.java",
      "status": "modified",
      "patch": "@@ -310,6 +310,22 @@ public class IntegrationTestMojo\n     @Parameter( property = \"failsafe.runOrder\", defaultValue = \"filesystem\" )\n     private String runOrder;\n \n+    /**\n+     * Sets the random seed that will be used to order the tests if {@code failsafe.runOrder} is set to {@code random}.\n+     * <br>\n+     * <br>\n+     * If no seeds are set and {@code failsafe.runOrder} is set to {@code random}, then the seed used will be\n+     * outputted (search for \"To reproduce ordering use flag -Dfailsafe.runOrder.random.seed\").\n+     * <br>\n+     * <br>\n+     * To deterministically reproduce any random test order that was run before, simply set the seed to \n+     * be the same value.\n+     *\n+     * @since 3.0.0-M6\n+     */\n+    @Parameter( property = \"failsafe.runOrder.random.seed\" )\n+    private Long runOrderRandomSeed;\n+\n     /**\n      * A file containing include patterns, each in a next line. Blank lines, or lines starting with # are ignored.\n      * If {@code includes} are also specified, these patterns are appended. Example with path, simple and regex\n@@ -891,6 +907,18 @@ public void setRunOrder( String runOrder )\n         this.runOrder = runOrder;\n     }\n \n+    @Override\n+    public Long getRunOrderRandomSeed()\n+    {\n+        return runOrderRandomSeed;\n+    }\n+\n+    @Override\n+    public void setRunOrderRandomSeed( Long runOrderRandomSeed )\n+    {\n+        this.runOrderRandomSeed = runOrderRandomSeed;\n+    }\n+\n     @Override\n     public File getIncludesFile()\n     {"
    },
    {
      "filename": "maven-surefire-common/src/main/java/org/apache/maven/plugin/surefire/AbstractSurefireMojo.java",
      "status": "modified",
      "patch": "@@ -865,6 +865,10 @@ public abstract class AbstractSurefireMojo\n \n     public abstract void setRunOrder( String runOrder );\n \n+    public abstract Long getRunOrderRandomSeed();\n+\n+    public abstract void setRunOrderRandomSeed( Long runOrderRandomSeed );\n+\n     protected abstract void handleSummary( RunResult summary, Exception firstForkException )\n         throws MojoExecutionException, MojoFailureException;\n \n@@ -1129,6 +1133,7 @@ boolean verifyParameters()\n             warnIfNotApplicableSkipAfterFailureCount();\n             warnIfIllegalTempDir();\n             warnIfForkCountIsZero();\n+            printDefaultSeedIfNecessary();\n         }\n         return true;\n     }\n@@ -1285,7 +1290,7 @@ private RunResult executeProvider( @Nonnull ProviderInfo provider, @Nonnull Defa\n         ClassLoaderConfiguration classLoaderConfiguration = getClassLoaderConfiguration();\n         provider.addProviderProperties();\n         RunOrderParameters runOrderParameters =\n-            new RunOrderParameters( getRunOrder(), getStatisticsFile( getConfigChecksum() ) );\n+            new RunOrderParameters( getRunOrder(), getStatisticsFile( getConfigChecksum() ), getRunOrderRandomSeed() );\n \n         if ( isNotForking() )\n         {\n@@ -3051,6 +3056,17 @@ private void warnIfIllegalTempDir() throws MojoFailureException\n         }\n     }\n \n+    private void printDefaultSeedIfNecessary()\n+    {\n+        if ( getRunOrderRandomSeed() == null && getRunOrder().equals( RunOrder.RANDOM.name() ) )\n+        {\n+            setRunOrderRandomSeed( System.nanoTime() );\n+            getConsoleLogger().info(\n+                \"Tests will run in random order. To reproduce ordering use flag -D\"\n+                    + getPluginName() + \".runOrder.random.seed=\" + getRunOrderRandomSeed() );\n+        }\n+    }\n+\n     final class TestNgProviderInfo\n         implements ProviderInfo\n     {"
    },
    {
      "filename": "maven-surefire-common/src/main/java/org/apache/maven/plugin/surefire/booterclient/BooterSerializer.java",
      "status": "modified",
      "patch": "@@ -56,6 +56,7 @@\n import static org.apache.maven.surefire.booter.BooterConstants.PLUGIN_PID;\n import static org.apache.maven.surefire.booter.BooterConstants.PROCESS_CHECKER;\n import static org.apache.maven.surefire.booter.BooterConstants.PROVIDER_CONFIGURATION;\n+import static org.apache.maven.surefire.booter.BooterConstants.RUN_ORDER_RANDOM_SEED;\n import static org.apache.maven.surefire.booter.BooterConstants.REPORTSDIRECTORY;\n import static org.apache.maven.surefire.booter.BooterConstants.REQUESTEDTEST;\n import static org.apache.maven.surefire.booter.BooterConstants.RERUN_FAILING_TESTS_COUNT;\n@@ -161,6 +162,7 @@ File serialize( KeyValueSource sourceProperties, ProviderConfiguration providerC\n         {\n             properties.setProperty( RUN_ORDER, RunOrder.asString( runOrderParameters.getRunOrder() ) );\n             properties.setProperty( RUN_STATISTICS_FILE, runOrderParameters.getRunStatisticsFile() );\n+            properties.setProperty( RUN_ORDER_RANDOM_SEED, runOrderParameters.getRunOrderRandomSeed() );\n         }\n \n         ReporterConfiguration reporterConfiguration = providerConfiguration.getReporterConfiguration();"
    },
    {
      "filename": "maven-surefire-common/src/test/java/org/apache/maven/plugin/surefire/AbstractSurefireMojoJava7PlusTest.java",
      "status": "modified",
      "patch": "@@ -839,6 +839,18 @@ public void setRunOrder( String runOrder )\n \n         }\n \n+        @Override\n+        public Long getRunOrderRandomSeed()\n+        {\n+            return null;\n+        }\n+\n+        @Override\n+        public void setRunOrderRandomSeed( Long runOrderRandomSeed )\n+        {\n+\n+        }\n+\n         @Override\n         protected void handleSummary( RunResult summary, Exception firstForkException )\n         {"
    },
    {
      "filename": "maven-surefire-common/src/test/java/org/apache/maven/plugin/surefire/AbstractSurefireMojoTest.java",
      "status": "modified",
      "patch": "@@ -2381,6 +2381,18 @@ public void setRunOrder( String runOrder )\n \n         }\n \n+        @Override\n+        public Long getRunOrderRandomSeed()\n+        {\n+            return null;\n+        }\n+\n+        @Override\n+        public void setRunOrderRandomSeed( Long runOrderRandomSeed )\n+        {\n+\n+        }\n+\n         @Override\n         protected void handleSummary( RunResult summary, Exception firstForkException )\n         {"
    },
    {
      "filename": "maven-surefire-common/src/test/java/org/apache/maven/plugin/surefire/MojoMocklessTest.java",
      "status": "modified",
      "patch": "@@ -709,6 +709,18 @@ public void setRunOrder( String runOrder )\n \n         }\n \n+        @Override\n+        public Long getRunOrderRandomSeed()\n+        {\n+            return null;\n+        }\n+\n+        @Override\n+        public void setRunOrderRandomSeed( Long runOrderRandomSeed )\n+        {\n+\n+        }\n+\n         @Override\n         public String[] getDependenciesToScan()\n         {"
    },
    {
      "filename": "maven-surefire-plugin/src/main/java/org/apache/maven/plugin/surefire/SurefirePlugin.java",
      "status": "modified",
      "patch": "@@ -292,6 +292,22 @@ public class SurefirePlugin\n     @Parameter( property = \"surefire.runOrder\", defaultValue = \"filesystem\" )\n     private String runOrder;\n \n+    /**\n+     * Sets the random seed that will be used to order the tests if {@code surefire.runOrder} is set to {@code random}.\n+     * <br>\n+     * <br>\n+     * If no seeds are set and {@code surefire.runOrder} is set to {@code random}, then the seed used will be\n+     * outputted (search for \"To reproduce ordering use flag -Dsurefire.runOrder.random.seed\").\n+     * <br>\n+     * <br>\n+     * To deterministically reproduce any random test order that was run before, simply set the seed to \n+     * be the same value.\n+     *\n+     * @since 3.0.0-M6\n+     */\n+    @Parameter( property = \"surefire.runOrder.random.seed\" )\n+    private Long runOrderRandomSeed;\n+\n     /**\n      * A file containing include patterns. Blank lines, or lines starting with # are ignored. If {@code includes} are\n      * also specified, these patterns are appended. Example with path, simple and regex includes:\n@@ -794,6 +810,18 @@ public void setRunOrder( String runOrder )\n         this.runOrder = runOrder;\n     }\n \n+    @Override\n+    public Long getRunOrderRandomSeed()\n+    {\n+        return runOrderRandomSeed;\n+    }\n+\n+    @Override\n+    public void setRunOrderRandomSeed( Long runOrderRandomSeed )\n+    {\n+        this.runOrderRandomSeed = runOrderRandomSeed;\n+    }\n+\n     @Override\n     public File getIncludesFile()\n     {"
    },
    {
      "filename": "surefire-api/src/main/java/org/apache/maven/surefire/api/testset/RunOrderParameters.java",
      "status": "modified",
      "patch": "@@ -31,16 +31,34 @@ public class RunOrderParameters\n \n     private File runStatisticsFile;\n \n+    private Long runOrderRandomSeed;\n+\n     public RunOrderParameters( RunOrder[] runOrder, File runStatisticsFile )\n     {\n         this.runOrder = runOrder;\n         this.runStatisticsFile = runStatisticsFile;\n+        this.runOrderRandomSeed = null;\n     }\n \n     public RunOrderParameters( String runOrder, File runStatisticsFile )\n     {\n         this.runOrder = runOrder == null ? RunOrder.DEFAULT : RunOrder.valueOfMulti( runOrder );\n         this.runStatisticsFile = runStatisticsFile;\n+        this.runOrderRandomSeed = null;\n+    }\n+\n+    public RunOrderParameters( RunOrder[] runOrder, File runStatisticsFile, Long runOrderRandomSeed )\n+    {\n+        this.runOrder = runOrder;\n+        this.runStatisticsFile = runStatisticsFile;\n+        this.runOrderRandomSeed = runOrderRandomSeed;\n+    }\n+\n+    public RunOrderParameters( String runOrder, File runStatisticsFile, Long runOrderRandomSeed )\n+    {\n+        this.runOrder = runOrder == null ? RunOrder.DEFAULT : RunOrder.valueOfMulti( runOrder );\n+        this.runStatisticsFile = runStatisticsFile;\n+        this.runOrderRandomSeed = runOrderRandomSeed;\n     }\n \n     public static RunOrderParameters alphabetical()\n@@ -53,6 +71,16 @@ public RunOrder[] getRunOrder()\n         return runOrder;\n     }\n \n+    public Long getRunOrderRandomSeed()\n+    {\n+        return runOrderRandomSeed;\n+    }\n+\n+    public void setRunOrderRandomSeed( Long runOrderRandomSeed )\n+    {\n+        this.runOrderRandomSeed = runOrderRandomSeed;\n+    }\n+\n     public File getRunStatisticsFile()\n     {\n         return runStatisticsFile;"
    },
    {
      "filename": "surefire-api/src/main/java/org/apache/maven/surefire/api/util/DefaultRunOrderCalculator.java",
      "status": "modified",
      "patch": "@@ -28,6 +28,7 @@\n import java.util.Comparator;\n import java.util.LinkedHashSet;\n import java.util.List;\n+import java.util.Random;\n \n /**\n  * Applies the final runorder of the tests\n@@ -45,12 +46,21 @@ public class DefaultRunOrderCalculator\n \n     private final int threadCount;\n \n+    private final Random random;\n+\n     public DefaultRunOrderCalculator( RunOrderParameters runOrderParameters, int threadCount )\n     {\n         this.runOrderParameters = runOrderParameters;\n         this.threadCount = threadCount;\n         this.runOrder = runOrderParameters.getRunOrder();\n         this.sortOrder = this.runOrder.length > 0 ? getSortOrderComparator( this.runOrder[0] ) : null;\n+        Long runOrderRandomSeed = runOrderParameters.getRunOrderRandomSeed();\n+        if ( runOrderRandomSeed == null )\n+        {\n+            runOrderRandomSeed = System.nanoTime();\n+            runOrderParameters.setRunOrderRandomSeed( runOrderRandomSeed );\n+        }\n+        this.random = new Random( runOrderRandomSeed );\n     }\n \n     @Override\n@@ -72,7 +82,7 @@ private void orderTestClasses( List<Class<?>> testClasses, RunOrder runOrder )\n     {\n         if ( RunOrder.RANDOM.equals( runOrder ) )\n         {\n-            Collections.shuffle( testClasses );\n+            Collections.shuffle( testClasses, random );\n         }\n         else if ( RunOrder.FAILEDFIRST.equals( runOrder ) )\n         {"
    },
    {
      "filename": "surefire-booter/src/main/java/org/apache/maven/surefire/booter/BooterConstants.java",
      "status": "modified",
      "patch": "@@ -46,6 +46,7 @@ private BooterConstants()\n     public static final String SOURCE_DIRECTORY = \"testSuiteDefinitionTestSourceDirectory\";\n     public static final String TEST_CLASSES_DIRECTORY = \"testClassesDirectory\";\n     public static final String RUN_ORDER = \"runOrder\";\n+    public static final String RUN_ORDER_RANDOM_SEED = \"runOrderRandomSeed\";\n     public static final String RUN_STATISTICS_FILE = \"runStatisticsFile\";\n     public static final String TEST_SUITE_XML_FILES = \"testSuiteXmlFiles\";\n     public static final String PROVIDER_CONFIGURATION = \"providerConfiguration\";"
    },
    {
      "filename": "surefire-booter/src/main/java/org/apache/maven/surefire/booter/BooterDeserializer.java",
      "status": "modified",
      "patch": "@@ -102,6 +102,7 @@ public ProviderConfiguration deserialize()\n         final List<String> testSuiteXmlFiles = properties.getStringList( TEST_SUITE_XML_FILES );\n         final File testClassesDirectory = properties.getFileProperty( TEST_CLASSES_DIRECTORY );\n         final String runOrder = properties.getProperty( RUN_ORDER );\n+        final Long runOrderRandomSeed = properties.getLongProperty( RUN_ORDER_RANDOM_SEED );\n         final String runStatisticsFile = properties.getProperty( RUN_STATISTICS_FILE );\n \n         final int rerunFailingTestsCount = properties.getIntProperty( RERUN_FAILING_TESTS_COUNT );\n@@ -111,7 +112,8 @@ public ProviderConfiguration deserialize()\n                                             properties.getBooleanProperty( FAILIFNOTESTS ), runOrder );\n \n         RunOrderParameters runOrderParameters\n-                = new RunOrderParameters( runOrder, runStatisticsFile == null ? null : new File( runStatisticsFile ) );\n+                = new RunOrderParameters( runOrder, runStatisticsFile == null ? null : new File( runStatisticsFile ),\n+                                          runOrderRandomSeed );\n \n         TestArtifactInfo testNg = new TestArtifactInfo( testNgVersion, testArtifactClassifier );\n         TestRequest testSuiteDefinition ="
    },
    {
      "filename": "surefire-booter/src/main/java/org/apache/maven/surefire/booter/SurefireReflector.java",
      "status": "modified",
      "patch": "@@ -178,10 +178,11 @@ private Object createRunOrderParameters( RunOrderParameters runOrderParameters )\n             return null;\n         }\n         //Can't use the constructor with the RunOrder parameter. Using it causes some integration tests to fail.\n-        Class<?>[] arguments = { String.class, File.class };\n+        Class<?>[] arguments = { String.class, File.class, Long.class };\n         Constructor<?> constructor = getConstructor( this.runOrderParameters, arguments );\n         File runStatisticsFile = runOrderParameters.getRunStatisticsFile();\n-        return newInstance( constructor, RunOrder.asString( runOrderParameters.getRunOrder() ), runStatisticsFile );\n+        return newInstance( constructor, RunOrder.asString( runOrderParameters.getRunOrder() ), runStatisticsFile,\n+                            runOrderParameters.getRunOrderRandomSeed() );\n     }\n \n     private Object createTestArtifactInfo( TestArtifactInfo testArtifactInfo )"
    },
    {
      "filename": "surefire-booter/src/test/java/org/apache/maven/surefire/booter/SurefireReflectorTest.java",
      "status": "modified",
      "patch": "@@ -119,6 +119,20 @@ public void testRunOrderParameters()\n         assertTrue( isCalled( foo ) );\n     }\n \n+    public void testRunOrderParametersWithRunOrderRandomSeed()\n+    {\n+        SurefireReflector surefireReflector = getReflector();\n+        Object foo = getFoo();\n+\n+        // Arbitrary random seed that should be ignored because RunOrder is not RANDOM\n+        Long runOrderRandomSeed = 5L;\n+\n+        RunOrderParameters runOrderParameters = new RunOrderParameters( RunOrder.DEFAULT, new File( \".\" ),\n+                                                                        runOrderRandomSeed );\n+        surefireReflector.setRunOrderParameters( foo, runOrderParameters );\n+        assertTrue( isCalled( foo ) );\n+    }\n+\n     public void testNullRunOrderParameters()\n     {\n         SurefireReflector surefireReflector = getReflector();"
    },
    {
      "filename": "surefire-its/src/test/java/org/apache/maven/surefire/its/RunOrderIT.java",
      "status": "modified",
      "patch": "@@ -19,6 +19,7 @@\n  * under the License.\n  */\n \n+import java.util.Arrays;\n import java.util.Calendar;\n import org.apache.maven.it.VerificationException;\n import org.apache.maven.surefire.its.fixture.OutputValidator;\n@@ -60,6 +61,43 @@ public void testAlphabeticalJUnit5()\n         assertTestnamesAppearInSpecificOrder( validator, TESTS_IN_ALPHABETICAL_ORDER );\n     }\n \n+    @Test\n+    public void testRandomJUnit4DifferentSeed()\n+        throws Exception\n+    {\n+        long seed = 0L;\n+        OutputValidator validator = executeWithRandomOrder( \"junit4\", seed );\n+        String[] expected = validator.getStringsOrderInLog( TESTS_IN_ALPHABETICAL_ORDER );\n+        for ( long i = seed; i < 5 + seed; i++ )\n+        {\n+            OutputValidator validator2 = executeWithRandomOrder( \"junit4\", i );\n+            String[] observed = validator2.getStringsOrderInLog( TESTS_IN_ALPHABETICAL_ORDER );\n+            if ( ! Arrays.equals( expected, observed ) )\n+            {\n+                return;\n+            }\n+        }\n+        throw new VerificationException( \"All random orders with the different seeds produced the same orders\" );\n+    }\n+\n+    @Test\n+    public void testRandomJUnit4SameSeed()\n+        throws Exception\n+    {\n+        long seed = 0L;\n+        OutputValidator validator = executeWithRandomOrder( \"junit4\", seed );\n+        String[] expected = validator.getStringsOrderInLog( TESTS_IN_ALPHABETICAL_ORDER );\n+        for ( long i = 0; i < 5; i++ )\n+        {\n+            OutputValidator validator2 = executeWithRandomOrder( \"junit4\", seed );\n+            String[] observed = validator2.getStringsOrderInLog( TESTS_IN_ALPHABETICAL_ORDER );\n+            if ( ! Arrays.equals( expected, observed ) )\n+            {\n+                throw new VerificationException( \"Random orders with the same seed produced different orders\" );\n+            }\n+        }\n+    }\n+    \n     @Test\n     public void testReverseAlphabeticalJUnit4()\n         throws Exception\n@@ -149,6 +187,17 @@ private OutputValidator executeWithRunOrder( String runOrder, String profile )\n             .verifyErrorFree( 3 );\n     }\n \n+    private OutputValidator executeWithRandomOrder( String profile, long seed  )\n+    {\n+        return unpack()\n+            .activateProfile( profile )\n+            .forkMode( getForkMode() )\n+            .runOrder( \"random\" )\n+            .runOrderRandomSeed( String.valueOf( seed ) )\n+            .executeTest()\n+            .verifyErrorFree( 3 );\n+    }\n+\n     protected String getForkMode()\n     {\n         return \"once\";"
    },
    {
      "filename": "surefire-its/src/test/java/org/apache/maven/surefire/its/fixture/OutputValidator.java",
      "status": "modified",
      "patch": "@@ -23,6 +23,7 @@\n import java.io.IOException;\n import java.nio.charset.Charset;\n import java.util.ArrayList;\n+import java.util.Arrays;\n import java.util.List;\n \n import org.apache.commons.io.FileUtils;\n@@ -223,6 +224,32 @@ public File getBaseDir()\n         return baseDir;\n     }\n \n+    public String[] getStringsOrderInLog( String[] strings )\n+        throws VerificationException\n+    {\n+        String[] retArr = new String[strings.length];\n+        List<String> strList = new ArrayList<String>( Arrays.asList( strings ) );\n+        int i = 0;\n+        for ( String line : loadLogLines() )\n+        {\n+            for ( int j = 0; j < strList.size(); j++ )\n+            {\n+                if ( line.startsWith( strList.get( j ) ) ) \n+                {\n+                    retArr[i] = strList.get( j );\n+                    ++i;\n+                    if ( i == strings.length )\n+                    {\n+                        return retArr;\n+                    }\n+                    strList.remove( j );\n+                    break;\n+                }\n+            }\n+        }\n+        return retArr;\n+    }\n+\n     public boolean stringsAppearInSpecificOrderInLog( String[] strings )\n         throws VerificationException\n     {"
    },
    {
      "filename": "surefire-its/src/test/java/org/apache/maven/surefire/its/fixture/SurefireLauncher.java",
      "status": "modified",
      "patch": "@@ -289,6 +289,12 @@ public SurefireLauncher runOrder( String runOrder )\n         return this;\n     }\n \n+    public SurefireLauncher runOrderRandomSeed( String runOrderRandomSeed )\n+    {\n+        mavenLauncher.sysProp( \"surefire.runOrder.random.seed\", runOrderRandomSeed );\n+        return this;\n+    }\n+\n     public SurefireLauncher failIfNoTests( boolean fail )\n     {\n         mavenLauncher.sysProp( \"failIfNoTests\", fail );"
    }
  ],
  "fix_category": "Other",
  "root_cause_category": "Randomness",
  "root_cause_subcategory": NaN
}