{
  "id": 251,
  "repo": "hbase",
  "issue_url": "https://github.com/apache/hbase/pull/5211",
  "pr_url": "https://github.com/apache/hbase/pull/5211",
  "issue_description": "",
  "files_changed": [
    {
      "filename": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/FromClientSideBase.java",
      "status": "modified",
      "patch": "@@ -98,8 +98,8 @@ protected static boolean isSameParameterizedCluster(Class<?> registryImpl, int n\n     return confClass.getName().equals(registryImpl.getName()) && numHedgedReqs == hedgedReqConfig;\n   }\n \n-  protected static final void initialize(Class<?> registryImpl, int numHedgedReqs, Class<?>... cps)\n-    throws Exception {\n+  protected static final void initialize(Class<? extends ConnectionRegistry> registryImpl,\n+    int numHedgedReqs, Class<?>... cps) throws Exception {\n     // initialize() is called for every unit test, however we only want to reset the cluster state\n     // at the end of every parameterized run.\n     if (isSameParameterizedCluster(registryImpl, numHedgedReqs)) {"
    },
    {
      "filename": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestFromClientSide5.java",
      "status": "modified",
      "patch": "@@ -28,7 +28,6 @@\n import java.io.IOException;\n import java.util.ArrayList;\n import java.util.Arrays;\n-import java.util.Collection;\n import java.util.LinkedList;\n import java.util.List;\n import java.util.Map;\n@@ -91,6 +90,7 @@\n import org.junit.experimental.categories.Category;\n import org.junit.runner.RunWith;\n import org.junit.runners.Parameterized;\n+import org.junit.runners.Parameterized.Parameters;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n@@ -115,21 +115,23 @@ public class TestFromClientSide5 extends FromClientSideBase {\n   @ClassRule\n   public static final HBaseClassTestRule CLASS_RULE =\n     HBaseClassTestRule.forClass(TestFromClientSide5.class);\n+\n   @Rule\n   public TableNameTestRule name = new TableNameTestRule();\n \n   // To keep the child classes happy.\n   TestFromClientSide5() {\n   }\n \n-  public TestFromClientSide5(Class registry, int numHedgedReqs) throws Exception {\n+  public TestFromClientSide5(Class<? extends ConnectionRegistry> registry, int numHedgedReqs)\n+    throws Exception {\n     initialize(registry, numHedgedReqs, MultiRowMutationEndpoint.class);\n   }\n \n-  @Parameterized.Parameters\n-  public static Collection parameters() {\n-    return Arrays.asList(new Object[][] { { MasterRegistry.class, 1 }, { MasterRegistry.class, 2 },\n-      { ZKConnectionRegistry.class, 1 } });\n+  @Parameters(name = \"{index}: registry={0}, numHedgedReqs={1}\")\n+  public static List<Object[]> parameters() {\n+    return Arrays.asList(new Object[] { MasterRegistry.class, 1 },\n+      new Object[] { MasterRegistry.class, 2 }, new Object[] { ZKConnectionRegistry.class, 1 });\n   }\n \n   @AfterClass\n@@ -771,10 +773,20 @@ private List<Result> doAppend(final boolean walUsed) throws IOException {\n       t.put(put_1);\n       List<Result> results = new LinkedList<>();\n       try (ResultScanner scanner = t.getScanner(s)) {\n+        // get one row(should be row3) from the scanner to make sure that we have send a request to\n+        // region server, which means we have already set the read point, so later we should not see\n+        // the new appended values.\n+        Result r = scanner.next();\n+        assertNotNull(r);\n+        results.add(r);\n         t.append(append_1);\n         t.append(append_2);\n         t.append(append_3);\n-        for (Result r : scanner) {\n+        for (;;) {\n+          r = scanner.next();\n+          if (r == null) {\n+            break;\n+          }\n           results.add(r);\n         }\n       }\n@@ -788,11 +800,11 @@ public void testAppendWithoutWAL() throws Exception {\n     List<Result> resultsWithWal = doAppend(true);\n     List<Result> resultsWithoutWal = doAppend(false);\n     assertEquals(resultsWithWal.size(), resultsWithoutWal.size());\n-    for (int i = 0; i != resultsWithWal.size(); ++i) {\n+    for (int i = 0; i < resultsWithWal.size(); ++i) {\n       Result resultWithWal = resultsWithWal.get(i);\n       Result resultWithoutWal = resultsWithoutWal.get(i);\n       assertEquals(resultWithWal.rawCells().length, resultWithoutWal.rawCells().length);\n-      for (int j = 0; j != resultWithWal.rawCells().length; ++j) {\n+      for (int j = 0; j < resultWithWal.rawCells().length; ++j) {\n         Cell cellWithWal = resultWithWal.rawCells()[j];\n         Cell cellWithoutWal = resultWithoutWal.rawCells()[j];\n         assertArrayEquals(CellUtil.cloneRow(cellWithWal), CellUtil.cloneRow(cellWithoutWal));"
    },
    {
      "filename": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestFromClientSideWithCoprocessor5.java",
      "status": "modified",
      "patch": "@@ -18,7 +18,7 @@\n package org.apache.hadoop.hbase.client;\n \n import java.util.Arrays;\n-import java.util.Collection;\n+import java.util.List;\n import org.apache.hadoop.hbase.HBaseClassTestRule;\n import org.apache.hadoop.hbase.coprocessor.MultiRowMutationEndpoint;\n import org.apache.hadoop.hbase.regionserver.NoOpScanPolicyObserver;\n@@ -27,7 +27,7 @@\n import org.junit.AfterClass;\n import org.junit.ClassRule;\n import org.junit.experimental.categories.Category;\n-import org.junit.runners.Parameterized;\n+import org.junit.runners.Parameterized.Parameters;\n \n /**\n  * Test all client operations with a coprocessor that just implements the default flush/compact/scan\n@@ -41,18 +41,19 @@ public class TestFromClientSideWithCoprocessor5 extends TestFromClientSide5 {\n \n   // Override the parameters from the parent class. We just want to run it for the default\n   // param combination.\n-  @Parameterized.Parameters\n-  public static Collection parameters() {\n-    return Arrays\n-      .asList(new Object[][] { { MasterRegistry.class, 1 }, { ZKConnectionRegistry.class, 1 } });\n+  @Parameters(name = \"{index}: registry={0}, numHedgedReqs={1}\")\n+  public static List<Object[]> parameters() {\n+    return Arrays.asList(new Object[] { MasterRegistry.class, 1 },\n+      new Object[] { ZKConnectionRegistry.class, 1 });\n   }\n \n   @AfterClass\n   public static void tearDownAfterClass() throws Exception {\n     afterClass();\n   }\n \n-  public TestFromClientSideWithCoprocessor5(Class registry, int numHedgedReqs) throws Exception {\n+  public TestFromClientSideWithCoprocessor5(Class<? extends ConnectionRegistry> registry,\n+    int numHedgedReqs) throws Exception {\n     initialize(registry, numHedgedReqs, NoOpScanPolicyObserver.class,\n       MultiRowMutationEndpoint.class);\n   }"
    }
  ],
  "fix_category": "WaitFor",
  "root_cause_category": "Async wait",
  "root_cause_subcategory": NaN
}