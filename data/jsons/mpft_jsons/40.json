{
  "id": 40,
  "repo": "node",
  "issue_url": "https://github.com/nodejs/node/pull/59742",
  "pr_url": "https://github.com/nodejs/node/pull/59742",
  "issue_description": "[PR Linked Issue]\n\n| Reason | <code>client-proxy/test-https-proxy-request-invalid-char-in-url</code> |\n| - | :- |\n| Type | JS_TEST_FAILURE |\n| Failed PR | 3 ([https://github.com/nodejs/node/pull/59587/](https://ci.nodejs.org/job/node-test-pull-request/68946/), [https://github.com/nodejs/node/pull/59734/](https://ci.nodejs.org/job/node-test-pull-request/69013/), [https://github.com/nodejs/node/pull/59717/](https://ci.nodejs.org/job/node-test-pull-request/69014/)) |\n| Appeared | [vm-efv4j](https://ci.nodejs.org/job/node-test-commit-osx/nodes=osx13-x64/66595/console), [vm-a49f1](https://ci.nodejs.org/job/node-test-commit-osx/nodes=osx13-x64/66594/console), [vm-yy37e](https://ci.nodejs.org/job/node-test-commit-osx/nodes=osx13-x64/66523/console) |\n| First CI | https://ci.nodejs.org/job/node-test-pull-request/68946/ |\n| Last CI | https://ci.nodejs.org/job/node-test-pull-request/69014/ |\n\n<details>\n<summary><a href=\"https://ci.nodejs.org/job/node-test-commit-osx/nodes=osx13-x64/66595/console\">Example</a></summary>\n\n```\nnot ok 4333 client-proxy/test-https-proxy-request-invalid-char-in-url\n  ---\n  duration_ms: 413.52500\n  severity: fail\n  exitcode: 1\n  stack: |-\n    #6 eneded response for: 'https://local\\rhost:55386/carriage-return-in-host'\n    #5 eneded response for: 'https://local\\r\\nhost:55386/crlf-in-host'\n    #4 eneded response for: 'https://local\\nhost:55386/newline-in-host'\n    #3 eneded response for: 'https://localhost:5\\r5386/carriage-return-in-port'\n    #2 eneded response for: 'https://localhost:5\\n5386/newline-in-port'\n    #1 eneded response for: 'https://localhost:5\\r\\n5386/crlf-in-port'\n    node:assert:147\n      throw new AssertionError(obj);\n      ^\n    \n    AssertionError [ERR_ASSERTION]: Expected values to be strictly deep-equal:\n    + actual - expected\n    \n    + Set(8) {\n    - Set(6) {\n        {\n    +     error: Error [ERR_STREAM_WRITE_AFTER_END]: write after end\n    +         at _write (node:internal/streams/writable:487:11)\n    +         at Writable.write (node:internal/streams/writable:508:10)\n    +      ...\n```\n</details>\n\nFrom https://github.com/nodejs/reliability/blob/main/reports/2025-09-03.md",
  "files_changed": [
    {
      "filename": "test/client-proxy/test-https-proxy-request-invalid-char-in-url.mjs",
      "status": "modified",
      "patch": "@@ -21,9 +21,10 @@ const server = https.createServer({\n   cert: fixtures.readKey('agent8-cert.pem'),\n   key: fixtures.readKey('agent8-key.pem'),\n }, (req, res) => {\n+  console.log(`[Upstream server] responding to request for ${inspect(req.url)}`);\n   requests.add(`https://localhost:${server.address().port}${req.url}`);\n   res.writeHead(200, { 'Content-Type': 'text/plain' });\n-  res.end(`Response for ${req.url}`);\n+  res.end(`Response for ${inspect(req.url)}`);\n });\n \n server.listen(0);\n@@ -54,7 +55,7 @@ https.globalAgent = new https.Agent({\n \n const severHost = `localhost:${server.address().port}`;\n \n-let counter = testCases.length;\n+let counter = 0;\n const expectedUrls = new Set();\n const expectedProxyLogs = new Set();\n for (const testCase of testCases) {\n@@ -69,15 +70,20 @@ for (const testCase of testCases) {\n   https.request(url, (res) => {\n     res.on('error', common.mustNotCall());\n     res.setEncoding('utf8');\n-    res.on('data', () => {});\n-    res.on('end', common.mustCall(() => {\n-      console.log(`#${counter--} eneded response for: ${inspect(url)}`);\n+    res.on('data', (data) => {\n+      console.log(`[Proxy client] Received response from server for ${inspect(url)}: ${data.toString()}`);\n+    });\n+    res.on('close', common.mustCall(() => {\n+      console.log(`[Proxy client] #${++counter} closed request for: ${inspect(url)}`);\n       // Finished all test cases.\n-      if (counter === 0) {\n-        proxy.close();\n-        server.close();\n-        assert.deepStrictEqual(requests, expectedUrls);\n-        assert.deepStrictEqual(new Set(logs), expectedProxyLogs);\n+      if (counter === testCases.length) {\n+        setImmediate(() => {\n+          console.log('All requests completed, shutting down.');\n+          proxy.close();\n+          server.close();\n+          assert.deepStrictEqual(requests, expectedUrls);\n+          assert.deepStrictEqual(new Set(logs), expectedProxyLogs);\n+        });\n       }\n     }));\n   }).on('error', common.mustNotCall()).end();"
    },
    {
      "filename": "test/common/proxy-server.js",
      "status": "modified",
      "patch": "@@ -63,7 +63,7 @@ exports.createProxyServer = function(options = {}) {\n     });\n \n     res.on('error', (err) => {\n-      logs.push({ error: err, source: 'proxy response' });\n+      logs.push({ error: err, source: 'client response for request' });\n     });\n \n     req.pipe(proxyReq, { end: true });\n@@ -75,7 +75,7 @@ exports.createProxyServer = function(options = {}) {\n     const [hostname, port] = req.url.split(':');\n \n     res.on('error', (err) => {\n-      logs.push({ error: err, source: 'proxy response' });\n+      logs.push({ error: err, source: 'client response for connect' });\n     });\n \n     const proxyReq = net.connect(port, hostname, () => {\n@@ -90,9 +90,13 @@ exports.createProxyServer = function(options = {}) {\n     });\n \n     proxyReq.on('error', (err) => {\n-      logs.push({ error: err, source: 'proxy request' });\n-      res.write('HTTP/1.1 500 Connection Error\\r\\n\\r\\n');\n-      res.end('Proxy error: ' + err.message);\n+      logs.push({ error: err, source: 'proxy connect' });\n+      // The proxy client might have already closed the connection\n+      // when the upstream connection fails.\n+      if (!res.writableEnded) {\n+        res.write('HTTP/1.1 500 Connection Error\\r\\n\\r\\n');\n+        res.end('Proxy error: ' + err.message);\n+      }\n     });\n   });\n "
    }
  ],
  "fix_category": "Change condition",
  "root_cause_category": "Network",
  "root_cause_subcategory": NaN
}