{
  "id": 45,
  "repo": "pulsar",
  "issue_url": "https://github.com/apache/pulsar/pull/21366",
  "pr_url": "https://github.com/apache/pulsar/pull/21366",
  "issue_description": "### Motivation\r\n\r\nRunning ClusterMigrationTest could fail with OOME.\r\nWhen investigating the problem, it showed up that ClusterMigrationTest's TestBroker inner class doesn't clean up resources properly. The admin clients weren't closed.\r\n\r\n### Modifications\r\n\r\n* Call `super.internalCleanup()` in the `cleanup` method.\r\n* Close admin clients in the test cleanup method\r\n\r\n### Documentation\r\n\r\n<!-- DO NOT REMOVE THIS SECTION. CHECK THE PROPER BOX ONLY. -->\r\n\r\n- [ ] `doc` <!-- Your PR contains doc changes. -->\r\n- [ ] `doc-required` <!-- Your PR changes impact docs and you will update later -->\r\n- [x] `doc-not-needed` <!-- Your PR changes do not impact docs -->\r\n- [ ] `doc-complete` <!-- Docs have been already added -->",
  "files_changed": [
    {
      "filename": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/ClusterMigrationTest.java",
      "status": "modified",
      "patch": "@@ -25,13 +25,13 @@\n import static org.testng.Assert.assertNotNull;\n import static org.testng.Assert.assertNull;\n import static org.testng.Assert.assertTrue;\n-\n+import com.google.common.collect.Sets;\n import java.lang.reflect.Method;\n import java.net.URL;\n import java.util.List;\n import java.util.Optional;\n import java.util.concurrent.TimeUnit;\n-\n+import lombok.Cleanup;\n import org.apache.pulsar.broker.BrokerTestUtil;\n import org.apache.pulsar.broker.PulsarService;\n import org.apache.pulsar.broker.auth.MockedPulsarServiceBaseTest;\n@@ -55,10 +55,6 @@\n import org.testng.annotations.DataProvider;\n import org.testng.annotations.Test;\n \n-import com.google.common.collect.Sets;\n-\n-import lombok.Cleanup;\n-\n @Test(groups = \"broker\")\n public class ClusterMigrationTest {\n \n@@ -232,9 +228,13 @@ public void setup() throws Exception {\n     protected void cleanup() throws Exception {\n         log.info(\"--- Shutting down ---\");\n         broker1.cleanup();\n+        admin1.close();\n         broker2.cleanup();\n+        admin2.close();\n         broker3.cleanup();\n+        admin3.close();\n         broker4.cleanup();\n+        admin4.close();\n     }\n \n     @BeforeMethod(alwaysRun = true)\n@@ -459,7 +459,7 @@ public void testClusterMigrationWithReplicationBacklog(boolean persistent, Subsc\n         assertEquals(topic1.getReplicators().size(), 1);\n \n        // stop service in the replication cluster to build replication backlog\n-        broker3.cleanup();\n+        broker3.stop();\n         retryStrategically((test) -> broker3.getPulsarService() == null, 10, 1000);\n         assertNull(pulsar3.getBrokerService());\n \n@@ -529,7 +529,7 @@ public void testClusterMigrationWithReplicationBacklog(boolean persistent, Subsc\n     /**\n      * This test validates that blue cluster first creates list of subscriptions into green cluster so, green cluster\n      * will not lose the data if producer migrates.\n-     * \n+     *\n      * @throws Exception\n      */\n     @Test\n@@ -928,7 +928,7 @@ public void testNamespaceMigrationWithReplicationBacklog(boolean persistent, Sub\n         assertEquals(blueTopicNs2.getReplicators().size(), 1);\n \n         // stop service in the replication cluster to build replication backlog\n-        broker3.cleanup();\n+        broker3.stop();\n         retryStrategically((test) -> broker3.getPulsarService() == null, 10, 1000);\n         assertNull(pulsar3.getBrokerService());\n \n@@ -1063,9 +1063,13 @@ public String getClusterName() {\n             return configClusterName;\n         }\n \n+        public void stop() throws Exception {\n+            stopBroker();\n+        }\n+\n         @Override\n         protected void cleanup() throws Exception {\n-            stopBroker();\n+            internalCleanup();\n         }\n \n         public void restart() throws Exception {"
    }
  ],
  "fix_category": "WaitFor",
  "root_cause_category": "Concurrency",
  "root_cause_subcategory": NaN
}