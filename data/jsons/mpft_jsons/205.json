{
  "id": 205,
  "repo": "gemini-cli",
  "issue_url": "https://github.com/google-gemini/gemini-cli/pull/8395",
  "pr_url": "https://github.com/google-gemini/gemini-cli/pull/8395",
  "issue_description": "## TLDR\r\n\r\nfixes a few flaky tests\r\n\r\n## Dive Deeper\r\n\r\n- Mock file size check in fileUtils test to avoid creating large files\r\n- Add retry options to directory cleanup in memoryDiscovery test\r\n- Create test directories in parallel for better performance\r\n\r\n## Reviewer Test Plan\r\n\r\nrun the tests and they shouldn't flake\r\n\r\n## Testing Matrix\r\n\r\n|          | \ud83c\udf4f  | \ud83e\ude9f  | \ud83d\udc27  |\r\n| -------- | --- | --- | --- |\r\n| npm run  | \u2753  | \u2753  | \u2705  |\r\n| npx      | \u2753  | \u2753  | \u2753  |\r\n| Docker   | \u2753  | \u2753  | \u2753  |\r\n| Podman   | \u2753  | -   | -   |\r\n| Seatbelt | \u2753  | -   | -   |\r\n\r\n## Linked issues / bugs\r\n\r\n- Fixes #8345\r\n- Fixes #8351",
  "files_changed": [
    {
      "filename": "packages/core/src/utils/fileUtils.test.ts",
      "status": "modified",
      "patch": "@@ -15,6 +15,7 @@ import {\n } from 'vitest';\n \n import * as actualNodeFs from 'node:fs'; // For setup/teardown\n+import fs from 'node:fs';\n import fsPromises from 'node:fs/promises';\n import path from 'node:path';\n import os from 'node:os';\n@@ -954,22 +955,30 @@ describe('fileUtils', () => {\n     });\n \n     it('should return an error if the file size exceeds 20MB', async () => {\n-      // Create a file just over 20MB\n-      const twentyOneMB = 21 * 1024 * 1024;\n-      const buffer = Buffer.alloc(twentyOneMB, 0x61); // Fill with 'a'\n-      actualNodeFs.writeFileSync(testTextFilePath, buffer);\n-\n-      const result = await processSingleFileContent(\n-        testTextFilePath,\n-        tempRootDir,\n-        new StandardFileSystemService(),\n-      );\n-\n-      expect(result.error).toContain('File size exceeds the 20MB limit');\n-      expect(result.returnDisplay).toContain(\n-        'File size exceeds the 20MB limit',\n-      );\n-      expect(result.llmContent).toContain('File size exceeds the 20MB limit');\n+      // Create a small test file\n+      actualNodeFs.writeFileSync(testTextFilePath, 'test content');\n+\n+      // Spy on fs.promises.stat to return a large file size\n+      const statSpy = vi.spyOn(fs.promises, 'stat').mockResolvedValueOnce({\n+        size: 21 * 1024 * 1024,\n+        isDirectory: () => false,\n+      } as fs.Stats);\n+\n+      try {\n+        const result = await processSingleFileContent(\n+          testTextFilePath,\n+          tempRootDir,\n+          new StandardFileSystemService(),\n+        );\n+\n+        expect(result.error).toContain('File size exceeds the 20MB limit');\n+        expect(result.returnDisplay).toContain(\n+          'File size exceeds the 20MB limit',\n+        );\n+        expect(result.llmContent).toContain('File size exceeds the 20MB limit');\n+      } finally {\n+        statSpy.mockRestore();\n+      }\n     });\n   });\n });"
    },
    {
      "filename": "packages/core/src/utils/memoryDiscovery.test.ts",
      "status": "modified",
      "patch": "@@ -63,7 +63,13 @@ describe('loadServerHierarchicalMemory', () => {\n     // Some tests set this to a different value.\n     setGeminiMdFilename(DEFAULT_CONTEXT_FILENAME);\n     // Clean up the temporary directory to prevent resource leaks.\n-    await fsPromises.rm(testRootDir, { recursive: true, force: true });\n+    // Use maxRetries option for robust cleanup without race conditions\n+    await fsPromises.rm(testRootDir, {\n+      recursive: true,\n+      force: true,\n+      maxRetries: 3,\n+      retryDelay: 10,\n+    });\n   });\n \n   describe('when untrusted', () => {\n@@ -354,9 +360,11 @@ describe('loadServerHierarchicalMemory', () => {\n       .spyOn(console, 'debug')\n       .mockImplementation(() => {});\n \n-    for (let i = 0; i < 100; i++) {\n-      await createEmptyDir(path.join(cwd, `deep_dir_${i}`));\n-    }\n+    // Create directories in parallel for better performance\n+    const dirPromises = Array.from({ length: 2 }, (_, i) =>\n+      createEmptyDir(path.join(cwd, `deep_dir_${i}`)),\n+    );\n+    await Promise.all(dirPromises);\n \n     // Pass the custom limit directly to the function\n     await loadServerHierarchicalMemory(\n@@ -371,12 +379,12 @@ describe('loadServerHierarchicalMemory', () => {\n         respectGitIgnore: true,\n         respectGeminiIgnore: true,\n       },\n-      50, // maxDirs\n+      1, // maxDirs\n     );\n \n     expect(consoleDebugSpy).toHaveBeenCalledWith(\n       expect.stringContaining('[DEBUG] [BfsFileSearch]'),\n-      expect.stringContaining('Scanning [50/50]:'),\n+      expect.stringContaining('Scanning [1/1]:'),\n     );\n \n     vi.mocked(console.debug).mockRestore();"
    }
  ],
  "fix_category": "Setup/clean up state",
  "root_cause_category": "I/O",
  "root_cause_subcategory": NaN
}