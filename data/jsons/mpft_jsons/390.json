{
  "id": 390,
  "repo": "node",
  "issue_url": "https://github.com/nodejs/node/pull/59595",
  "pr_url": "https://github.com/nodejs/node/pull/59595",
  "issue_description": "[PR Linked Issue]\n### Test\n\nparallel/test-http-keep-alive-empty-line\n\n### Platform\n\nLinux ARM64\n\n### Console output\n\n```console\nnot ok 1876 parallel/test-http-keep-alive-empty-line\n  ---\n  duration_ms: 3582.76000\n  severity: fail\n  exitcode: 1\n  stack: |-\n    node:events:486\n          throw er; // Unhandled 'error' event\n          ^\n    \n    Error [ERR_STREAM_WRITE_AFTER_END]: write after end\n        at _write (node:internal/streams/writable:487:11)\n        at Writable.write (node:internal/streams/writable:508:10)\n        at Timeout._onTimeout (file:///home/iojs/build/workspace/node-test-commit-arm-debug/test/parallel/test-http-keep-alive-empty-line.mjs:32:14)\n        at listOnTimeout (node:internal/timers:608:17)\n        at process.processTimers (node:internal/timers:543:7)\n    Emitted 'error' event on Socket instance at:\n        at emitErrorNT (node:internal/streams/destroy:170:8)\n        at emitErrorCloseNT (node:internal/streams/destroy:129:3)\n        at process.processTicksAndRejections (node:internal/process/task_queues:90:21) {\n      code: 'ERR_STREAM_WRITE_AFTER_END'\n    }\n    \n    Node.js v25.0.0-pre\n  ...\n```\n\n### Build links\n\n| Reason | <code>parallel/test-http-keep-alive-empty-line</code> |\n| - | :- |\n| Type | JS_TEST_FAILURE |\n| Failed PR | 7 ([https://github.com/nodejs/node/pull/59507/](https://ci.nodejs.org/job/node-test-pull-request/68737/), [https://github.com/nodejs/node/pull/59350/](https://ci.nodejs.org/job/node-test-pull-request/68767/), [https://github.com/nodejs/node/pull/59550/](https://ci.nodejs.org/job/node-test-pull-request/68771/), [https://github.com/nodejs/node/pull/59464/](https://ci.nodejs.org/job/node-test-pull-request/68774/), [https://github.com/nodejs/node/pull/59527/](https://ci.nodejs.org/job/node-test-pull-request/68779/), [https://github.com/nodejs/node/pull/59570/](https://ci.nodejs.org/job/node-test-pull-request/68790/), [https://github.com/nodejs/node/pull/59558/](https://ci.nodejs.org/job/node-test-pull-request/68798/)) |\n| Appeared | [test-equinix-ubuntu2204_container-arm64-4](https://ci.nodejs.org/job/node-test-commit-arm-debug/nodes=ubuntu2204_debug-arm64/20010/console), [test-equinix-rhel8_container-arm64-2](https://ci.nodejs.org/job/node-test-commit-arm/nodes=rhel8-arm64/60027/console), [test-equinix-ubuntu2204_container-arm64-6](https://ci.nodejs.org/job/node-test-commit-arm/nodes=ubuntu2204-arm64/60019/console) |\n| First CI | https://ci.nodejs.org/job/node-test-pull-request/68737/ |\n| Last CI | https://ci.nodejs.org/job/node-test-pull-request/68798/ |\n\n### Additional information\n\nThis test was added in https://github.com/nodejs/node/pull/58178 and has been flaky some time after that.",
  "files_changed": [
    {
      "filename": "test/parallel/test-http-keep-alive-empty-line.mjs",
      "status": "modified",
      "patch": "@@ -3,6 +3,10 @@ import assert from 'node:assert';\n import { createServer } from 'node:http';\n import { connect } from 'node:net';\n \n+// This test ensures that data like an empty line (`\\r\\n`) recevied by the\n+// server after a request, does not reset the keep-alive timeout. See\n+// https://github.com/nodejs/node/issues/58140.\n+\n const server = createServer({\n   connectionsCheckingInterval: 100,\n   headersTimeout: 100,\n@@ -28,23 +32,24 @@ server.listen(0, () => {\n           '\\r\\n'\n     );\n \n-    setTimeout(() => {\n-      client.write('\\r\\n');\n-    }, 100);\n-\n-    let responseBuffer = '';\n+    let response = '';\n+    let responseReceived = false;\n \n+    client.setEncoding('utf-8');\n     client.on('data', (chunk) => {\n-      responseBuffer += chunk.toString();\n+      response += chunk;\n \n       // Check if we've received the full header (ending with \\r\\n\\r\\n)\n-      if (responseBuffer.includes('\\r\\n\\r\\n')) {\n-        const statusLine = responseBuffer.split('\\r\\n')[0];\n+      if (response.includes('\\r\\n\\r\\n')) {\n+        responseReceived = true;\n+        const statusLine = response.split('\\r\\n')[0];\n         const status = statusLine.split(' ')[1];\n         assert.strictEqual(status, '404');\n-        client.end();\n+        client.write('\\r\\n');\n       }\n     });\n-    client.on('end', common.mustCall());\n+    client.on('end', common.mustCall(() => {\n+      assert.ok(responseReceived);\n+    }));\n   });\n });"
    }
  ],
  "fix_category": "WaitFor",
  "root_cause_category": "Async wait",
  "root_cause_subcategory": NaN
}