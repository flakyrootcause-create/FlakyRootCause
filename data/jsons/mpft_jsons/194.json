{
  "id": 194,
  "repo": "sentry-python",
  "issue_url": "https://github.com/getsentry/sentry-python/pull/4278",
  "pr_url": "https://github.com/getsentry/sentry-python/pull/4278",
  "issue_description": "These tests were causing flakes where the mock method was being called more than once. The tests were also difficult to understand.\n\nThis change removes the need for mocking (hopefully increasing test stability) and also should hopefully make it easier to understand what these tests are meant to be checking",
  "files_changed": [
    {
      "filename": "tests/test_basics.py",
      "status": "modified",
      "patch": "@@ -9,7 +9,6 @@\n import pytest\n from sentry_sdk.client import Client\n from sentry_sdk.utils import datetime_from_isoformat\n-from tests.conftest import patch_start_tracing_child\n \n import sentry_sdk\n import sentry_sdk.scope\n@@ -935,46 +934,100 @@ def class_(cls, arg):\n         return cls, arg\n \n \n-def test_staticmethod_tracing(sentry_init):\n-    test_staticmethod_name = \"tests.test_basics.TracingTestClass.static\"\n+# We need to fork here because the test modifies tests.test_basics.TracingTestClass\n+@pytest.mark.forked\n+def test_staticmethod_class_tracing(sentry_init, capture_events):\n+    sentry_init(\n+        debug=True,\n+        traces_sample_rate=1.0,\n+        functions_to_trace=[\n+            {\"qualified_name\": \"tests.test_basics.TracingTestClass.static\"}\n+        ],\n+    )\n \n-    assert (\n-        \".\".join(\n-            [\n-                TracingTestClass.static.__module__,\n-                TracingTestClass.static.__qualname__,\n-            ]\n-        )\n-        == test_staticmethod_name\n-    ), \"The test static method was moved or renamed. Please update the name accordingly\"\n+    events = capture_events()\n \n-    sentry_init(functions_to_trace=[{\"qualified_name\": test_staticmethod_name}])\n+    with sentry_sdk.start_transaction(name=\"test\"):\n+        assert TracingTestClass.static(1) == 1\n \n-    for instance_or_class in (TracingTestClass, TracingTestClass()):\n-        with patch_start_tracing_child() as fake_start_child:\n-            assert instance_or_class.static(1) == 1\n-            assert fake_start_child.call_count == 1\n+    (event,) = events\n+    assert event[\"type\"] == \"transaction\"\n+    assert event[\"transaction\"] == \"test\"\n \n+    (span,) = event[\"spans\"]\n+    assert span[\"description\"] == \"tests.test_basics.TracingTestClass.static\"\n \n-def test_classmethod_tracing(sentry_init):\n-    test_classmethod_name = \"tests.test_basics.TracingTestClass.class_\"\n \n-    assert (\n-        \".\".join(\n-            [\n-                TracingTestClass.class_.__module__,\n-                TracingTestClass.class_.__qualname__,\n-            ]\n-        )\n-        == test_classmethod_name\n-    ), \"The test class method was moved or renamed. Please update the name accordingly\"\n+# We need to fork here because the test modifies tests.test_basics.TracingTestClass\n+@pytest.mark.forked\n+def test_staticmethod_instance_tracing(sentry_init, capture_events):\n+    sentry_init(\n+        debug=True,\n+        traces_sample_rate=1.0,\n+        functions_to_trace=[\n+            {\"qualified_name\": \"tests.test_basics.TracingTestClass.static\"}\n+        ],\n+    )\n+\n+    events = capture_events()\n+\n+    with sentry_sdk.start_transaction(name=\"test\"):\n+        assert TracingTestClass().static(1) == 1\n+\n+    (event,) = events\n+    assert event[\"type\"] == \"transaction\"\n+    assert event[\"transaction\"] == \"test\"\n \n-    sentry_init(functions_to_trace=[{\"qualified_name\": test_classmethod_name}])\n+    (span,) = event[\"spans\"]\n+    assert span[\"description\"] == \"tests.test_basics.TracingTestClass.static\"\n+\n+\n+# We need to fork here because the test modifies tests.test_basics.TracingTestClass\n+@pytest.mark.forked\n+def test_classmethod_class_tracing(sentry_init, capture_events):\n+    sentry_init(\n+        debug=True,\n+        traces_sample_rate=1.0,\n+        functions_to_trace=[\n+            {\"qualified_name\": \"tests.test_basics.TracingTestClass.class_\"}\n+        ],\n+    )\n+\n+    events = capture_events()\n+\n+    with sentry_sdk.start_transaction(name=\"test\"):\n+        assert TracingTestClass.class_(1) == (TracingTestClass, 1)\n+\n+    (event,) = events\n+    assert event[\"type\"] == \"transaction\"\n+    assert event[\"transaction\"] == \"test\"\n+\n+    (span,) = event[\"spans\"]\n+    assert span[\"description\"] == \"tests.test_basics.TracingTestClass.class_\"\n+\n+\n+# We need to fork here because the test modifies tests.test_basics.TracingTestClass\n+@pytest.mark.forked\n+def test_classmethod_instance_tracing(sentry_init, capture_events):\n+    sentry_init(\n+        debug=True,\n+        traces_sample_rate=1.0,\n+        functions_to_trace=[\n+            {\"qualified_name\": \"tests.test_basics.TracingTestClass.class_\"}\n+        ],\n+    )\n+\n+    events = capture_events()\n+\n+    with sentry_sdk.start_transaction(name=\"test\"):\n+        assert TracingTestClass().class_(1) == (TracingTestClass, 1)\n+\n+    (event,) = events\n+    assert event[\"type\"] == \"transaction\"\n+    assert event[\"transaction\"] == \"test\"\n \n-    for instance_or_class in (TracingTestClass, TracingTestClass()):\n-        with patch_start_tracing_child() as fake_start_child:\n-            assert instance_or_class.class_(1) == (TracingTestClass, 1)\n-            assert fake_start_child.call_count == 1\n+    (span,) = event[\"spans\"]\n+    assert span[\"description\"] == \"tests.test_basics.TracingTestClass.class_\"\n \n \n def test_last_event_id(sentry_init):"
    }
  ],
  "fix_category": "Setup/clean up state",
  "root_cause_category": "Test order dependency",
  "root_cause_subcategory": NaN
}