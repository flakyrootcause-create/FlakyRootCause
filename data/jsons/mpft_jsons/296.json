{
  "id": 296,
  "repo": "elasticsearch",
  "issue_url": "https://github.com/elastic/elasticsearch/pull/133489",
  "pr_url": "https://github.com/elastic/elasticsearch/pull/133489",
  "issue_description": "[PR Linked Issue]\n**Build Scans:**\n- [elasticsearch-intake #27158 / part3](https://gradle-enterprise.elastic.co/s/akaigagd47vke)\n- [elasticsearch-periodic-platform-support #10137 / rocky-9_platform-support-unix](https://gradle-enterprise.elastic.co/s/7266jgkv5xaqy)\n\n**Reproduction Line:**\n```\n./gradlew \":x-pack:plugin:esql:internalClusterTest\" --tests \"org.elasticsearch.xpack.esql.action.RandomizedTimeSeriesIT.testGroupByNothing\" -Dtests.seed=3050CE9CE9791881 -Dtests.locale=sa -Dtests.timezone=Australia/LHI -Druntime.java=24\n```\n\n**Applicable branches:**\nmain\n\n**Reproduces locally?:**\nN/A\n\n**Failure History:**\n[See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.xpack.esql.action.RandomizedTimeSeriesIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!('testGroupByNothing'),title:'Test',type:optionsListControl)))))\n\n**Failure Message:**\n```\norg.elasticsearch.action.bulk.IndexDocFailureStoreStatus$ExceptionWithFailureStoreStatus: [.ds-tsit_ds-2025.08.20-000001/TEfC-UbzS46u74MtBQWqXA][[.ds-tsit_ds-2025.08.20-000001][0]] org.elasticsearch.index.engine.VersionConflictEngineException: [C49S8X6g-QjW9uynAAABmMd3qH4][KBkJUGhjrYx0kKOigCXrLeK0RcVVTL_itQLi69ku_AIJqqsrijofpOU@2025-08-20T12:32:44.670Z]: version conflict, document already exists (current version [1])\n```\n\n**Issue Reasons:**\n- [main] 2 failures in test testGroupByNothing (1.7% fail rate in 118 executions)\n\n**Note:**\nThis issue was created using new test triage automation. Please report issues or feedback to es-delivery.",
  "files_changed": [
    {
      "filename": "muted-tests.yml",
      "status": "modified",
      "patch": "@@ -546,12 +546,6 @@ tests:\n - class: org.elasticsearch.gradle.internal.transport.TransportVersionValidationFuncTest\n   method: definitions have primary ids which cannot change\n   issue: https://github.com/elastic/elasticsearch/issues/133131\n-- class: org.elasticsearch.xpack.esql.action.RandomizedTimeSeriesIT\n-  method: testGroupBySubset\n-  issue: https://github.com/elastic/elasticsearch/issues/133220\n-- class: org.elasticsearch.xpack.esql.action.RandomizedTimeSeriesIT\n-  method: testGroupByNothing\n-  issue: https://github.com/elastic/elasticsearch/issues/133225\n - class: org.elasticsearch.gradle.internal.transport.TransportVersionValidationFuncTest\n   method: named and unreferenced definitions cannot have the same name\n   issue: https://github.com/elastic/elasticsearch/issues/133255"
    },
    {
      "filename": "x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/RandomizedTimeSeriesIT.java",
      "status": "modified",
      "patch": "@@ -183,10 +183,10 @@ public void populateIndex() throws IOException {\n             if (documents == null) {\n                 documents = new ArrayList<>();\n             }\n-            documents.add(document);\n             var indexRequest = client().prepareIndex(DATASTREAM_NAME).setOpType(DocWriteRequest.OpType.CREATE).setSource(document);\n             indexRequest.setRefreshPolicy(org.elasticsearch.action.support.WriteRequest.RefreshPolicy.IMMEDIATE);\n             indexRequest.get();\n+            documents.add(document);\n         }\n     }\n "
    },
    {
      "filename": "x-pack/plugin/esql/src/internalClusterTest/java/org/elasticsearch/xpack/esql/action/TSDataGenerationHelper.java",
      "status": "modified",
      "patch": "@@ -24,6 +24,7 @@\n \n import java.io.IOException;\n import java.time.Instant;\n+import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n@@ -65,6 +66,29 @@ private static Object randomDimensionValue(String dimensionName) {\n             return dimensionsInMetric.stream().map(attr -> new Tuple<>(attr, randomDimensionValue(attr))).collect(Collectors.toList());\n         }).toList();\n \n+        // We want to ensure that all documents have different timestamps.\n+        var now = Instant.now();\n+        var timestampSet = new HashSet<Instant>();\n+        var regens = 0;\n+        for (int i = 0; i < numDocs; i++) {\n+            // Random timestamps within the last 90 days.\n+            while (true) {\n+                var randomIns = Instant.ofEpochMilli(\n+                    ESTestCase.randomLongBetween(now.minusSeconds(60 * 60 * 2).toEpochMilli(), now.toEpochMilli())\n+                );\n+                if (timestampSet.add(randomIns)) {\n+                    break;\n+                }\n+                regens++;\n+                if (regens > numDocs) {\n+                    throw new IllegalStateException(\"Too many collisions when generating timestamps\");\n+                }\n+            }\n+        }\n+        // Timestampset should have exactly numDocs entries - this works as long as the random number generator\n+        // does not cycle early.\n+        assert timestampSet.size() == numDocs : \"Expected [\" + numDocs + \"] timestamps but got [\" + timestampSet.size() + \"]\";\n+        var timestampsIter = timestampSet.iterator();\n         spec = DataGeneratorSpecification.builder()\n             .withMaxFieldCountPerLevel(0)\n             .withPredefinedFields(\n@@ -73,7 +97,7 @@ private static Object randomDimensionValue(String dimensionName) {\n                         \"@timestamp\",\n                         FieldType.DATE,\n                         Map.of(\"type\", \"date\"),\n-                        fieldMapping -> ESTestCase.randomInstantBetween(Instant.now().minusSeconds(2 * 60 * 60), Instant.now())\n+                        fieldMapping -> timestampsIter.next()\n                     ),\n                     new PredefinedField.WithGenerator(\n                         \"attributes\","
    }
  ],
  "fix_category": "Other",
  "root_cause_category": "Randomness",
  "root_cause_subcategory": NaN
}