{
  "id": 297,
  "repo": "elasticsearch",
  "issue_url": "https://github.com/elastic/elasticsearch/pull/130810",
  "pr_url": "https://github.com/elastic/elasticsearch/pull/130810",
  "issue_description": "[PR Linked Issue]\n**Build Scans:**\n- [elasticsearch-periodic-platform-support #9255 / windows-2025_checkpart1_platform-support-windows](https://gradle-enterprise.elastic.co/s/wrqmjkr2q5tv2)\n- [elasticsearch-periodic-platform-support #9227 / amazonlinux-2023_platform-support-aws](https://gradle-enterprise.elastic.co/s/lnzqxbgk5pjyi)\n- [elasticsearch-periodic-platform-support #9227 / oraclelinux-9_platform-support-unix](https://gradle-enterprise.elastic.co/s/bc573kel6n2ae)\n\n**Reproduction Line:**\n```\ngradlew \":server:internalClusterTest\" --tests \"org.elasticsearch.search.aggregations.bucket.FiltersCancellationIT.testFiltersSubAggsCancellation\" -Dtests.seed=E591B05A93049B8B -Dtests.locale=fr-TG -Dtests.timezone=US/Eastern -Druntime.java=24\n```\n\n**Applicable branches:**\nmain\n\n**Reproduces locally?:**\nN/A\n\n**Failure History:**\n[See dashboard](https://es-delivery-stats.elastic.dev/app/dashboards#/view/dcec9e60-72ac-11ee-8f39-55975ded9e63?_g=(refreshInterval:(pause:!t,value:60000),time:(from:now-7d%2Fd,to:now))&_a=(controlGroupState:(initialChildControlState:('0c0c9cb8-ccd2-45c6-9b13-96bac4abc542':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:task.keyword,order:0,selectedOptions:!(),title:'GradleTask',type:optionsListControl),'4e6ad9d6-6fdc-4fcc-bf1a-aa6ca79e0850':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:className.keyword,order:1,selectedOptions:!(org.elasticsearch.search.aggregations.bucket.FiltersCancellationIT),title:'Suite',type:optionsListControl),'144933da-5c1b-4257-a969-7f43455a7901':(dataViewId:fbbdc689-be23-4b3d-8057-aa402e9ed0c5,fieldName:name.keyword,order:2,selectedOptions:!('testFiltersSubAggsCancellation'),title:'Test',type:optionsListControl)))))\n\n**Failure Message:**\n```\njava.lang.AssertionError: null\n```\n\n**Issue Reasons:**\n- [main] 3 failures in test testFiltersSubAggsCancellation (1.1% fail rate in 263 executions)\n- [main] 2 failures in pipeline elasticsearch-periodic-platform-support (40.0% fail rate in 5 executions)\n\n**Note:**\nThis issue was created using new test triage automation. Please report issues or feedback to es-delivery.",
  "files_changed": [
    {
      "filename": "server/src/internalClusterTest/java/org/elasticsearch/search/aggregations/bucket/FiltersCancellationIT.java",
      "status": "modified",
      "patch": "@@ -28,6 +28,7 @@\n import org.elasticsearch.test.ESIntegTestCase;\n import org.elasticsearch.xcontent.XContentBuilder;\n import org.elasticsearch.xcontent.json.JsonXContent;\n+import org.junit.Before;\n \n import java.util.Collection;\n import java.util.List;\n@@ -39,9 +40,22 @@\n import static org.elasticsearch.search.aggregations.AggregationBuilders.filters;\n import static org.elasticsearch.search.aggregations.AggregationBuilders.terms;\n import static org.hamcrest.Matchers.empty;\n+import static org.hamcrest.Matchers.equalTo;\n import static org.hamcrest.Matchers.greaterThan;\n import static org.hamcrest.Matchers.not;\n \n+/**\n+ * Ensures the filters aggregation checks task cancellation, by ensuring it doesn't process all the docs.\n+ * <p>\n+ *   The CancellableBulkScorer we use to break the execution is called per search thread in the query.\n+ *   It currently breaks the \"for each doc\" into blocks of 4096 docs (x2 every iteration), and checks for cancellation between blocks.\n+ *   This test creates N docs and releases N - X permits, to ensure the search request gets cancelled before grabbing all the permits.\n+ * </p>\n+ * <p>\n+ *   Also, if the search thread pool size is too high, it can lead to them trying to process too many documents anyway (pool size * 4096),\n+ *   eventually blocking the threads (And failing the test). So it's explicitly set to a small number to avoid this.\n+ * </p>\n+ */\n @ESIntegTestCase.SuiteScopeTestCase\n public class FiltersCancellationIT extends ESIntegTestCase {\n \n@@ -55,11 +69,12 @@ public class FiltersCancellationIT extends ESIntegTestCase {\n \n     @Override\n     protected Collection<Class<? extends Plugin>> nodePlugins() {\n-        return CollectionUtils.appendToCopy(super.nodePlugins(), pausableFieldPluginClass());\n+        return CollectionUtils.appendToCopy(super.nodePlugins(), PauseScriptPlugin.class);\n     }\n \n-    protected Class<? extends Plugin> pausableFieldPluginClass() {\n-        return PauseScriptPlugin.class;\n+    @Override\n+    public Settings nodeSettings(int nodeOrdinal, Settings otherSettings) {\n+        return Settings.builder().put(super.nodeSettings(nodeOrdinal, otherSettings)).put(\"thread_pool.search.size\", 4).build();\n     }\n \n     @Override\n@@ -99,6 +114,11 @@ public void setupSuiteScopeCluster() throws Exception {\n         client().admin().indices().prepareForceMerge(INDEX).setMaxNumSegments(1).get();\n     }\n \n+    @Before\n+    public void reset() {\n+        SCRIPT_SEMAPHORE.drainPermits();\n+    }\n+\n     public void testFiltersCountCancellation() throws Exception {\n         ensureProperCancellation(\n             client().prepareSearch(INDEX)\n@@ -129,14 +149,14 @@ public void testFiltersSubAggsCancellation() throws Exception {\n \n     private void ensureProperCancellation(SearchRequestBuilder searchRequestBuilder) throws Exception {\n         var searchRequestFuture = searchRequestBuilder.setTimeout(TimeValue.timeValueSeconds(1)).execute();\n-        assertFalse(searchRequestFuture.isCancelled());\n-        assertFalse(searchRequestFuture.isDone());\n+        assertThat(searchRequestFuture.isCancelled(), equalTo(false));\n+        assertThat(searchRequestFuture.isDone(), equalTo(false));\n \n         // Check that there are search tasks running\n         assertThat(getSearchTasks(), not(empty()));\n \n         // Wait for the script field to get blocked\n-        assertBusy(() -> { assertThat(SCRIPT_SEMAPHORE.getQueueLength(), greaterThan(0)); });\n+        assertBusy(() -> assertThat(SCRIPT_SEMAPHORE.getQueueLength(), greaterThan(0)));\n \n         // Cancel the tasks\n         // Warning: Adding a waitForCompletion(true)/execute() here sometimes causes tasks to not get canceled and threads to get stuck\n@@ -146,8 +166,8 @@ private void ensureProperCancellation(SearchRequestBuilder searchRequestBuilder)\n \n         // Ensure the search request finished and that there are no more search tasks\n         assertBusy(() -> {\n-            assertTrue(searchRequestFuture.isDone());\n-            assertThat(getSearchTasks(), empty());\n+            assertThat(\"Search request didn't finish\", searchRequestFuture.isDone(), equalTo(true));\n+            assertThat(\"There are dangling search tasks\", getSearchTasks(), empty());\n         });\n     }\n "
    }
  ],
  "fix_category": "Lock atomic region",
  "root_cause_category": "Concurrency",
  "root_cause_subcategory": NaN
}