{
  "id": 280,
  "repo": "kubernetes",
  "issue_url": "https://github.com/kubernetes/kubernetes/pull/123686",
  "pr_url": "https://github.com/kubernetes/kubernetes/pull/123686",
  "issue_description": "[PR Linked Issue]\n### Failure cluster [46c1b1ee59dffad82fad](https://storage.googleapis.com/k8s-triage/index.html?pr=1#46c1b1ee59dffad82fad)\r\n\r\n##### Error text:\r\n```\r\n=== RUN   TestFrameworkHandler_IterateOverWaitingPods/pods_with_different_profiles_are_waiting_on_permit_stage\r\n    framework.go:381: I0229 10:48:13.714983] the scheduler starts to work with those plugins Plugins={\"PreEnqueue\":{\"Enabled\":null,\"Disabled\":null},\"QueueSort\":{\"Enabled\":[{\"Name\":\"PrioritySort\",\"Weight\":0}],\"Disabled\":null},\"PreFilter\":{\"Enabled\":null,\"Disabled\":null},\"Filter\":{\"Enabled\":null,\"Disabled\":null},\"PostFilter\":{\"Enabled\":null,\"Disabled\":null},\"PreScore\":{\"Enabled\":null,\"Disabled\":null},\"Score\":{\"Enabled\":null,\"Disabled\":null},\"Reserve\":{\"Enabled\":null,\"Disabled\":null},\"Permit\":{\"Enabled\":[{\"Name\":\"fakePermit\",\"Weight\":0}],\"Disabled\":null},\"PreBind\":{\"Enabled\":null,\"Disabled\":null},\"Bind\":{\"Enabled\":[{\"Name\":\"DefaultBinder\",\"Weight\":0}],\"Disabled\":null},\"PostBind\":{\"Enabled\":null,\"Disabled\":null},\"MultiPoint\":{\"Enabled\":null,\"Disabled\":null}}\r\n    framework.go:381: I0229 10:48:13.715309] the scheduler starts to work with those plugins Plugins={\"PreEnqueue\":{\"Enabled\":null,\"Disabled\":null},\"QueueSort\":{\"Enabled\":[{\"Name\":\"PrioritySort\",\"Weight\":0}],\"Disabled\":null},\"PreFilter\":{\"Enabled\":null,\"Disabled\":null},\"Filter\":{\"Enabled\":null,\"Disabled\":null},\"PostFilter\":{\"Enabled\":null,\"Disabled\":null},\"PreScore\":{\"Enabled\":null,\"Disabled\":null},\"Score\":{\"Enabled\":null,\"Disabled\":null},\"Reserve\":{\"Enabled\":null,\"Disabled\":null},\"Permit\":{\"Enabled\":[{\"Name\":\"fakePermit\",\"Weight\":0}],\"Disabled\":null},\"PreBind\":{\"Enabled\":null,\"Disabled\":null},\"Bind\":{\"Enabled\":[{\"Name\":\"DefaultBinder\",\"Weight\":0}],\"Disabled\":null},\"PostBind\":{\"Enabled\":null,\"Disabled\":null},\"MultiPoint\":{\"Enabled\":null,\"Disabled\":null}}\r\n    framework.go:381: I0229 10:48:13.715630] the scheduler starts to work with those plugins Plugins={\"PreEnqueue\":{\"Enabled\":null,\"Disabled\":null},\"QueueSort\":{\"Enabled\":[{\"Name\":\"PrioritySort\",\"Weight\":0}],\"Disabled\":null},\"PreFilter\":{\"Enabled\":null,\"Disabled\":null},\"Filter\":{\"Enabled\":null,\"Disabled\":null},\"PostFilter\":{\"Enabled\":null,\"Disabled\":null},\"PreScore\":{\"Enabled\":null,\"Disabled\":null},\"Score\":{\"Enabled\":null,\"Disabled\":null},\"Reserve\":{\"Enabled\":null,\"Disabled\":null},\"Permit\":{\"Enabled\":[{\"Name\":\"fakePermit\",\"Weight\":0}],\"Disabled\":null},\"PreBind\":{\"Enabled\":null,\"Disabled\":null},\"Bind\":{\"Enabled\":[{\"Name\":\"DefaultBinder\",\"Weight\":0}],\"Disabled\":null},\"PostBind\":{\"Enabled\":null,\"Disabled\":null},\"MultiPoint\":{\"Enabled\":null,\"Disabled\":null}}\r\n    eventhandlers.go:75: I0229 10:48:13.717736] Add event for node node=\"node1\"\r\n    node_tree.go:65: I0229 10:48:13.717988] Added node in listed group to NodeTree node=\"node1\" zone=\"\"\r\n    eventhandlers.go:75: I0229 10:48:13.718196] Add event for node node=\"node2\"\r\n    node_tree.go:65: I0229 10:48:13.718385] Added node in listed group to NodeTree node=\"node2\" zone=\"\"\r\n    eventhandlers.go:75: I0229 10:48:13.718588] Add event for node node=\"node3\"\r\n    node_tree.go:65: I0229 10:48:13.718793] Added node in listed group to NodeTree node=\"node3\" zone=\"\"\r\n    eventhandlers.go:128: I0229 10:48:13.718980] Add event for unscheduled pod pod=\"pod1\"\r\n    scheduling_queue.go:595: I0229 10:48:13.719138] Pod moved to an internal scheduling queue pod=\"pod1\" event=\"PodAdd\" queue=\"Active\"\r\n    schedule_one.go:84: I0229 10:48:13.719250] About to try and schedule pod pod=\"pod1\"\r\n    schedule_one.go:97: I0229 10:48:13.719321] Attempting to schedule pod pod=\"pod1\"\r\n    framework.go:1475: I0229 10:48:13.719623] Permit: One or more plugins asked to wait and no plugin rejected pod node=\"node1\" pod=\"pod1\"\r\n    framework.go:1500: I0229 10:48:13.719889] Pod waiting on permit pod=\"pod1\"\r\n    eventhandlers.go:128: I0229 10:48:13.720049] Add event for unscheduled pod pod=\"pod2\"\r\n    scheduling_queue.go:595: I0229 10:48:13.720184] Pod moved to an internal scheduling queue pod=\"pod2\" event=\"PodAdd\" queue=\"Active\"\r\n    schedule_one.go:84: I0229 10:48:13.720358] About to try and schedule pod pod=\"pod2\"\r\n    schedule_one.go:97: I0229 10:48:13.720451] Attempting to schedule pod pod=\"pod2\"\r\n    framework.go:1475: I0229 10:48:13.720791] Permit: One or more plugins asked to wait and no plugin rejected pod node=\"node2\" pod=\"pod2\"\r\n    framework.go:1500: I0229 10:48:13.721010] Pod waiting on permit pod=\"pod2\"\r\n    eventhandlers.go:128: I0229 10:48:13.721439] Add event for unscheduled pod pod=\"pod3\"\r\n    scheduling_queue.go:595: I0229 10:48:13.721732] Pod moved to an internal scheduling queue pod=\"pod3\" event=\"PodAdd\" queue=\"Active\"\r\n    eventhandlers.go:128: I0229 10:48:13.721917] Add event for unscheduled pod pod=\"pod4\"\r\n    schedule_one.go:84: I0229 10:48:13.722078] About to try and schedule pod pod=\"pod3\"\r\n    schedule_one.go:97: I0229 10:48:13.722236] Attempting to schedule pod pod=\"pod3\"\r\n    scheduling_queue.go:595: I0229 10:48:13.722449] Pod moved to an internal scheduling queue pod=\"pod4\" event=\"PodAdd\" queue=\"Active\"\r\n    framework.go:1475: I0229 10:48:13.722729] Permit: One or more plugins asked to wait and no plugin rejected pod node=\"node3\" pod=\"pod3\"\r\n    framework.go:1500: I0229 10:48:13.723032] Pod waiting on permit pod=\"pod3\"\r\n    schedule_one.go:84: I0229 10:48:13.723270] About to try and schedule pod pod=\"pod4\"\r\n    schedule_one.go:97: I0229 10:48:13.723413] Attempting to schedule pod pod=\"pod4\"\r\n    scheduler_test.go:1044: Unexpected waitingPods in scheduler profile test-scheduler-profile-1, expect: []string{\"pod1\", \"pod2\", \"pod3\", \"pod4\"}, got: []string{\"pod1\", \"pod2\", \"pod3\"}\r\n    --- FAIL: TestFrameworkHandler_IterateOverWaitingPods/pods_with_different_profiles_are_waiting_on_permit_stage (0.01s)\r\n```\r\n\r\n#### Recent failures:\r\n[3/1/2024, 7:14:16 AM pr:pull-kubernetes-unit](https://prow.k8s.io/view/gs/kubernetes-jenkins/pr-logs/pull/123614/pull-kubernetes-unit/1763538031354056704)\r\n[2/29/2024, 5:28:43 AM pr:pull-kubernetes-unit](https://prow.k8s.io/view/gs/kubernetes-jenkins/pr-logs/pull/123555/pull-kubernetes-unit/1763149087500144640)\r\n[2/28/2024, 12:17:55 PM pr:pull-kubernetes-unit](https://prow.k8s.io/view/gs/kubernetes-jenkins/pr-logs/pull/123562/pull-kubernetes-unit/1762889666685571072)\r\n\r\n\r\n/kind failing-test\r\n<!-- If this is a flake, please add: /kind flake -->\r\n/kind flake\r\n\r\n<!-- Please assign a SIG using: /sig SIG-NAME -->\r\n/sig scheduling",
  "files_changed": [
    {
      "filename": "pkg/scheduler/scheduler_test.go",
      "status": "modified",
      "patch": "@@ -31,6 +31,7 @@ import (\n \tmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n \t\"k8s.io/apimachinery/pkg/runtime\"\n \t\"k8s.io/apimachinery/pkg/util/sets\"\n+\t\"k8s.io/apimachinery/pkg/util/wait\"\n \tutilfeature \"k8s.io/apiserver/pkg/util/feature\"\n \t\"k8s.io/client-go/informers\"\n \t\"k8s.io/client-go/kubernetes\"\n@@ -977,14 +978,16 @@ func TestFrameworkHandler_IterateOverWaitingPods(t *testing.T) {\n \t\t\tfakeClient := fake.NewSimpleClientset(objs...)\n \t\t\tinformerFactory := informers.NewSharedInformerFactory(fakeClient, 0)\n \t\t\teventBroadcaster := events.NewBroadcaster(&events.EventSinkImpl{Interface: fakeClient.EventsV1()})\n+\t\t\tdefer eventBroadcaster.Shutdown()\n \t\t\teventRecorder := eventBroadcaster.NewRecorder(scheme.Scheme, fakePermit)\n \n \t\t\toutOfTreeRegistry := frameworkruntime.Registry{\n \t\t\t\tfakePermit: newFakePermitPlugin(eventRecorder),\n \t\t\t}\n \n \t\t\t_, ctx := ktesting.NewTestContext(t)\n-\t\t\tctx, cancel := context.WithCancel(ctx)\n+\t\t\t// timeout equals to the permit plugin waiting time.\n+\t\t\tctx, cancel := context.WithTimeout(ctx, 100*time.Second)\n \t\t\tdefer cancel()\n \n \t\t\tscheduler, err := New(\n@@ -1032,17 +1035,23 @@ func TestFrameworkHandler_IterateOverWaitingPods(t *testing.T) {\n \t\t\t// Wait all pods in waitSchedulingPods to be scheduled.\n \t\t\twg.Wait()\n \n-\t\t\t// Ensure that all waitingPods in scheduler can be obtained from any profiles.\n-\t\t\tfor _, fwk := range scheduler.Profiles {\n-\t\t\t\tactualPodNamesInWaitingPods := sets.NewString()\n-\t\t\t\tfwk.IterateOverWaitingPods(func(pod framework.WaitingPod) {\n-\t\t\t\t\tactualPodNamesInWaitingPods.Insert(pod.GetPod().Name)\n-\t\t\t\t})\n-\t\t\t\t// Validate the name of pods in waitingPods matches expectations.\n-\t\t\t\tif actualPodNamesInWaitingPods.Len() != len(tc.expectPodNamesInWaitingPods) ||\n-\t\t\t\t\t!actualPodNamesInWaitingPods.HasAll(tc.expectPodNamesInWaitingPods...) {\n-\t\t\t\t\tt.Fatalf(\"Unexpected waitingPods in scheduler profile %s, expect: %#v, got: %#v\", fwk.ProfileName(), tc.expectPodNamesInWaitingPods, actualPodNamesInWaitingPods.List())\n+\t\t\t// When permit plugin emits the event, pod may not been added to the waitingPods pool yet, so we use pollUntil here.\n+\t\t\tif err := wait.PollUntilContextCancel(ctx, 100*time.Microsecond, true, func(context.Context) (done bool, err error) {\n+\t\t\t\t// Ensure that all waitingPods in scheduler can be obtained from any profiles.\n+\t\t\t\tfor _, fwk := range scheduler.Profiles {\n+\t\t\t\t\tactualPodNamesInWaitingPods := sets.NewString()\n+\t\t\t\t\tfwk.IterateOverWaitingPods(func(pod framework.WaitingPod) {\n+\t\t\t\t\t\tactualPodNamesInWaitingPods.Insert(pod.GetPod().Name)\n+\t\t\t\t\t})\n+\t\t\t\t\t// Validate the name of pods in waitingPods matches expectations.\n+\t\t\t\t\tif actualPodNamesInWaitingPods.Len() != len(tc.expectPodNamesInWaitingPods) ||\n+\t\t\t\t\t\t!actualPodNamesInWaitingPods.HasAll(tc.expectPodNamesInWaitingPods...) {\n+\t\t\t\t\t\treturn false, fmt.Errorf(\"Unexpected waitingPods in scheduler profile %s, expect: %#v, got: %#v\", fwk.ProfileName(), tc.expectPodNamesInWaitingPods, actualPodNamesInWaitingPods.List())\n+\t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t\treturn true, nil\n+\t\t\t}); err != nil {\n+\t\t\t\tt.Fatal(\"got unexpected result\")\n \t\t\t}\n \t\t})\n \t}"
    }
  ],
  "fix_category": "WaitFor",
  "root_cause_category": "Async wait",
  "root_cause_subcategory": NaN
}