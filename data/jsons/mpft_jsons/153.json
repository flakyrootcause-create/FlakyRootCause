{
  "id": 153,
  "repo": "kubernetes",
  "issue_url": "https://github.com/kubernetes/kubernetes/commit/83273e2",
  "pr_url": "https://github.com/kubernetes/kubernetes/commit/83273e2",
  "issue_description": "**What type of PR is this?**\r\n\r\n/kind bug\r\n\r\n**What this PR does / why we need it**:\r\n\r\nPod with PVC will not be scheduled if the PVC is being deleted.\r\nThis can happen when the PVC has finalizers of storage plugins.\r\n\r\nSuch a pod becomes pending.  Unfortunately, after the finalizer\r\nfinishes and PVC is deleted, the pod remains pending forever.\r\nThe StatefulSet controller does nothing for this pending pod.\r\n\r\nThis commit prevents the StatefulSet controller from creating\r\nsuch pods when PVC is to be deleted.\r\n\r\nReprocedure:\r\n\r\n1. Create a single node cluster with [kind](https://github.com/kubernetes-sigs/kind).\r\n2. Create a StatefulSet with the following manifests:\r\n\r\n```yaml\r\napiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: test\r\n  namespace: default\r\nspec:\r\n  clusterIP: None\r\n  selector:\r\n    app: test\r\n---\r\napiVersion: apps/v1\r\nkind: StatefulSet\r\nmetadata:\r\n  name: test\r\n  namespace: default\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app: test\r\n  serviceName: test\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app: test\r\n    spec:\r\n      containers:\r\n      - command:\r\n        - pause\r\n        image: quay.io/cybozu/ubuntu:18.04\r\n        name: ubuntu\r\n        volumeMounts:\r\n        - mountPath: /usr/share/nginx/html\r\n          name: www\r\n  volumeClaimTemplates:\r\n  - metadata:\r\n      name: www\r\n    spec:\r\n      accessModes:\r\n      - ReadWriteOnce\r\n      resources:\r\n        requests:\r\n          storage: 1Gi\r\n      volumeMode: Filesystem\r\n```\r\n\r\n3. Once the pod gets running, edit PVC to add a finalizer `aaa.bbb/ccc`.\r\n4. Run `kubectl delete --wait=false pvc/www-test-0`.\r\n5. Run `kubectl delete --wait=false pods/test-0`.\r\n6. See a new pod is created and become pending.\r\n7. Edit the PVC to remove the `aaa.bbb/ccc` finalizer.\r\n8. See the PVC is get deleted.\r\n9. See the Pod remains pending forever.\r\n\r\n**Does this PR introduce a user-facing change?**:\r\n```release-note\r\nAdding fix to statefulset controller to wait for pvc deletion before creating pods.\r\n```\r\n",
  "files_changed": [
    {
      "filename": "pkg/controller/statefulset/stateful_pod_control.go",
      "status": "modified",
      "patch": "@@ -179,7 +179,7 @@ func (spc *realStatefulPodControl) recordClaimEvent(verb string, set *apps.State\n func (spc *realStatefulPodControl) createPersistentVolumeClaims(set *apps.StatefulSet, pod *v1.Pod) error {\n \tvar errs []error\n \tfor _, claim := range getPersistentVolumeClaims(set, pod) {\n-\t\t_, err := spc.pvcLister.PersistentVolumeClaims(claim.Namespace).Get(claim.Name)\n+\t\tpvc, err := spc.pvcLister.PersistentVolumeClaims(claim.Namespace).Get(claim.Name)\n \t\tswitch {\n \t\tcase apierrors.IsNotFound(err):\n \t\t\t_, err := spc.client.CoreV1().PersistentVolumeClaims(claim.Namespace).Create(&claim)\n@@ -192,6 +192,8 @@ func (spc *realStatefulPodControl) createPersistentVolumeClaims(set *apps.Statef\n \t\tcase err != nil:\n \t\t\terrs = append(errs, fmt.Errorf(\"failed to retrieve PVC %s: %s\", claim.Name, err))\n \t\t\tspc.recordClaimEvent(\"create\", set, pod, &claim, err)\n+\t\tcase pvc.DeletionTimestamp != nil:\n+\t\t\terrs = append(errs, fmt.Errorf(\"pvc %s is to be deleted\", claim.Name))\n \t\t}\n \t\t// TODO: Check resource requirements and accessmodes, update if necessary\n \t}"
    },
    {
      "filename": "pkg/controller/statefulset/stateful_pod_control_test.go",
      "status": "modified",
      "patch": "@@ -20,6 +20,7 @@ import (\n \t\"errors\"\n \t\"strings\"\n \t\"testing\"\n+\t\"time\"\n \n \tapierrors \"k8s.io/apimachinery/pkg/api/errors\"\n \t\"k8s.io/apimachinery/pkg/runtime\"\n@@ -29,6 +30,7 @@ import (\n \t\"k8s.io/client-go/tools/record\"\n \n \t\"k8s.io/api/core/v1\"\n+\tmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n \t\"k8s.io/client-go/kubernetes/fake\"\n \tcorelisters \"k8s.io/client-go/listers/core/v1\"\n \t_ \"k8s.io/kubernetes/pkg/apis/apps/install\"\n@@ -128,6 +130,42 @@ func TestStatefulPodControlCreatePodPvcCreateFailure(t *testing.T) {\n \t\t}\n \t}\n }\n+func TestStatefulPodControlCreatePodPvcDeleting(t *testing.T) {\n+\trecorder := record.NewFakeRecorder(10)\n+\tset := newStatefulSet(3)\n+\tpod := newStatefulSetPod(set, 0)\n+\tfakeClient := &fake.Clientset{}\n+\tpvcs := getPersistentVolumeClaims(set, pod)\n+\tpvcIndexer := cache.NewIndexer(cache.MetaNamespaceKeyFunc, cache.Indexers{cache.NamespaceIndex: cache.MetaNamespaceIndexFunc})\n+\tdeleteTime := time.Date(2019, time.January, 1, 0, 0, 0, 0, time.UTC)\n+\tfor k := range pvcs {\n+\t\tpvc := pvcs[k]\n+\t\tpvc.DeletionTimestamp = &metav1.Time{Time: deleteTime}\n+\t\tpvcIndexer.Add(&pvc)\n+\t}\n+\tpvcLister := corelisters.NewPersistentVolumeClaimLister(pvcIndexer)\n+\tcontrol := NewRealStatefulPodControl(fakeClient, nil, nil, pvcLister, recorder)\n+\tfakeClient.AddReactor(\"create\", \"persistentvolumeclaims\", func(action core.Action) (bool, runtime.Object, error) {\n+\t\tcreate := action.(core.CreateAction)\n+\t\treturn true, create.GetObject(), nil\n+\t})\n+\tfakeClient.AddReactor(\"create\", \"pods\", func(action core.Action) (bool, runtime.Object, error) {\n+\t\tcreate := action.(core.CreateAction)\n+\t\treturn true, create.GetObject(), nil\n+\t})\n+\tif err := control.CreateStatefulPod(set, pod); err == nil {\n+\t\tt.Error(\"Failed to produce error on deleting PVC\")\n+\t}\n+\tevents := collectEvents(recorder.Events)\n+\tif eventCount := len(events); eventCount != 1 {\n+\t\tt.Errorf(\"Deleting PVC: got %d events, but want 1\", eventCount)\n+\t}\n+\tfor i := range events {\n+\t\tif !strings.Contains(events[i], v1.EventTypeWarning) {\n+\t\t\tt.Errorf(\"Found unexpected non-warning event %s\", events[i])\n+\t\t}\n+\t}\n+}\n \n type fakeIndexer struct {\n \tcache.Indexer"
    }
  ],
  "fix_category": "Make deterministic",
  "root_cause_category": "Time",
  "root_cause_subcategory": NaN
}