{
  "id": 127,
  "repo": "PowerToys",
  "issue_url": "https://github.com/microsoft/PowerToys/pull/40390",
  "pr_url": "https://github.com/microsoft/PowerToys/pull/40390",
  "issue_description": "The test `Win32ProgramRepositoryMustCallOnAppRenamedForLnkAppsWhenRenamedEventIsRaised` was experiencing random failures due to object identity mismatches in the repository's hash-based storage system.\r\n\r\n## Root Cause\r\n\r\nThe test was manually creating `Win32Program` objects:\r\n\r\n```csharp\r\nWin32Program olditem = new Win32Program\r\n{\r\n    Name = \"oldpath\",\r\n    ExecutableName = oldpath,\r\n    FullPath = linkingTo,\r\n};\r\n```\r\n\r\nHowever, the `DoOnAppRenamedAsync` method creates the `oldApp` object for removal using a different approach for .lnk files:\r\n\r\n```csharp\r\noldApp = new Win32Program() { \r\n    Name = Path.GetFileNameWithoutExtension(e.OldName), \r\n    ExecutableName = Path.GetFileName(e.OldName), \r\n    FullPath = newApp?.FullPath ?? oldPath \r\n};\r\n```\r\n\r\nSince the repository uses `GetHashCode()` (based on `Name`, `ExecutableName`, and `FullPath`) to identify objects for removal, any subtle differences in these properties would cause the `Remove()` operation to fail, leading to test assertion failures.\r\n\r\n## Fix\r\n\r\nChanged the test to use `Win32Program.GetAppFromPath()` instead of manual object creation:\r\n\r\n```csharp\r\nWin32Program olditem = Win32Program.GetAppFromPath(oldFullPath);\r\nWin32Program newitem = Win32Program.GetAppFromPath(newFullPath);\r\n```\r\n\r\nThis mirrors the approach used in the working `Win32ProgramRepositoryMustCallOnAppRenamedForUrlAppsWhenRenamedEventIsRaised` test and ensures that test objects are created using the same code path as the production code, eliminating hash code mismatches.\r\n\r\n## Why This Was Random\r\n\r\nThe test failure appeared random because it depended on subtle differences in object creation that could vary based on timing, mock setup, or other environmental factors. By using the same object creation method as the production code, the test becomes deterministic.",
  "files_changed": [
    {
      "filename": "src/modules/launcher/Plugins/Microsoft.Plugin.Program.UnitTests/Storage/Win32ProgramRepositoryTest.cs",
      "status": "modified",
      "patch": "@@ -363,7 +363,7 @@ public async Task Win32ProgramRepositoryMustCallOnAppRenamedForLnkAppsWhenRename\n             RenamedEventArgs e = new RenamedEventArgs(WatcherChangeTypes.Renamed, directory, path, oldpath);\n \n             string oldFullPath = directory + \"\\\\\" + oldpath;\n-            string fullPath = directory + \"\\\\\" + path;\n+            string newFullPath = directory + \"\\\\\" + path;\n             string linkingTo = Directory.GetCurrentDirectory();\n \n             // ShellLinkHelper must be mocked for lnk applications\n@@ -372,19 +372,8 @@ public async Task Win32ProgramRepositoryMustCallOnAppRenamedForLnkAppsWhenRename\n             Win32Program.ShellLinkHelper = mockShellLink.Object;\n \n             // old item and new item are the actual items when they are in existence\n-            Win32Program olditem = new Win32Program\n-            {\n-                Name = \"oldpath\",\n-                ExecutableName = oldpath,\n-                FullPath = linkingTo,\n-            };\n-\n-            Win32Program newitem = new Win32Program\n-            {\n-                Name = \"path\",\n-                ExecutableName = path,\n-                FullPath = linkingTo,\n-            };\n+            Win32Program olditem = Win32Program.GetAppFromPath(oldFullPath);\n+            Win32Program newitem = Win32Program.GetAppFromPath(newFullPath);\n \n             win32ProgramRepository.Add(olditem);\n "
    }
  ],
  "fix_category": "Setup/clean up state",
  "root_cause_category": "Concurrency",
  "root_cause_subcategory": NaN
}