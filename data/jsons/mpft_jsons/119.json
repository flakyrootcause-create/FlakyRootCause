{
  "id": 119,
  "repo": "fluent-logger-java",
  "issue_url": "https://github.com/fluent/fluent-logger-java/pull/102",
  "pr_url": "https://github.com/fluent/fluent-logger-java/pull/102",
  "issue_description": "### Description:\r\nI observed a previous suggested fix injected some delay to fix the flaky test, but I believe that fix might be unstable in a CI environment or when run on different machines, given the dependency on some constant wait time. I suggest a new way to fix the test by adding some synchronization for the test execution only. I at first identify the source code location whose slow execution (from Line 436 to 442) leads to the flaky test failure. Hence, I introduce one variable in this test class  that is only there to provide some synchronization. Basically, until these statements are executed, I force the thread that shuts down the services. The waiting location is at Line 447 of this test class.\r\n\r\n### Failure:\r\nRunning org.fluentd.logger.TestFluentLogger\r\n2023-03-31 10:11:42,340 DEBUG [pool-2-thread-1] Started MockFluentd port:33845\r\nException in thread \"pool-3-thread-15\" java.lang.NullPointerException\r\nat org.fluentd.logger.FluentLogger.log(FluentLogger.java:101)\r\nat org.fluentd.logger.FluentLogger.log(FluentLogger.java:86)\r\nat org.fluentd.logger.TestFluentLogger$7.run(TestFluentLogger.java:436)\r\nat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\nat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\nat java.base/java.lang.Thread.run(Thread.java:829)\r\njava.lang.NullPointerException\r\nat org.fluentd.logger.FluentLogger.log(FluentLogger.java:101)\r\nat org.fluentd.logger.FluentLogger.log(FluentLogger.java:86)\r\nat org.fluentd.logger.TestFluentLogger$7.run(TestFluentLogger.java:436)\r\nat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\nat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\nat java.base/java.lang.Thread.run(Thread.java:829)\r\nException in thread \"pool-3-thread-7\" java.lang.NullPointerException\r\nat org.fluentd.logger.FluentLogger.log(FluentLogger.java:101)\r\nat org.fluentd.logger.FluentLogger.log(FluentLogger.java:86)\r\nat org.fluentd.logger.TestFluentLogger$7.run(TestFluentLogger.java:436)\r\nat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\nat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\nat java.base/java.lang.Thread.run(Thread.java:829)\r\nException in thread \"pool-3-thread-10\" java.lang.NullPointerException\r\nat org.fluentd.logger.FluentLogger.log(FluentLogger.java:101)\r\nat org.fluentd.logger.FluentLogger.log(FluentLogger.java:86)\r\nat org.fluentd.logger.TestFluentLogger$7.run(TestFluentLogger.java:436)\r\nat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\nat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\nat java.base/java.lang.Thread.run(Thread.java:829)\r\n2023-03-31 10:16:50,774 ERROR [main] Timed out\r\n2023-03-31 10:16:50,774 DEBUG [pool-2-thread-1] Terminated MockFluentd port:33845\r\nTests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 308.585 sec <<< FAILURE!\r\n\r\n### Results :\r\n\r\nFailed tests:\r\ntestInMultiThreading(org.fluentd.logger.TestFluentLogger): expected:<210000> but was:<209591>\r\n\r\nTests run: 1, Failures: 1, Errors: 0, Skipped: 0",
  "files_changed": [
    {
      "filename": "src/test/java/org/fluentd/logger/TestFluentLogger.java",
      "status": "modified",
      "patch": "@@ -27,6 +27,7 @@\n import static org.junit.Assert.*;\n \n public class TestFluentLogger {\n+    private static volatile boolean hasExecuted = false;\n     private Logger _logger = LoggerFactory.getLogger(TestFluentLogger.class);\n \n     class FixedThreadManager {\n@@ -439,9 +440,13 @@ public void run() {\n                             logger.flush();\n                     }\n                     logger.flush();\n+                    hasExecuted = true;\n                 }\n             });\n         }\n+        while (!hasExecuted) { \n+            Thread.yield(); \n+        }\n         Thread.sleep(1000);\n         executorService.shutdown();\n         executorService.awaitTermination(300, TimeUnit.SECONDS);"
    }
  ],
  "fix_category": "WaitFor",
  "root_cause_category": "Concurrency",
  "root_cause_subcategory": NaN
}