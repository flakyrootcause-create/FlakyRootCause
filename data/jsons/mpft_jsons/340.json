{
  "id": 340,
  "repo": "jenkins",
  "issue_url": "https://github.com/jenkinsci/jenkins/pull/8453",
  "pr_url": "https://github.com/jenkinsci/jenkins/pull/8453",
  "issue_description": "I am aware of a case where the same set of plugins would lead to one controller starting successfully and one controller failing to start, depending on the order in which the plugins were listed. We currently use file system iteration order, which is undefined. This PR sorts the list by filename before passing the result to the topological sorting function, so every controller with the same set of plugins will now load them in the same order. This should make it easier to debug such problems, because they will either always occur, or they will never occur \u2014 but at least the behavior will be deterministic.\r\n\r\n### Testing done\r\n\r\nI added a log statement to print the list of active plugins as consumed by the `UberClassLoader` and verified that at each level of the topological sort the entries were in lexicographical order.\r\n\r\n### Proposed changelog entries\r\n\r\nList plugins in deterministic order to improve diagnosability of plugin linkage errors.\r\n\r\n### Proposed upgrade guidelines\r\n\r\nN/A\r\n\r\n```[tasklist]\r\n### Submitter checklist\r\n- [ ] The Jira issue, if it exists, is well-described.\r\n- [ ] The changelog entries and upgrade guidelines are appropriate for the audience affected by the change (users or developers, depending on the change) and are in the imperative mood (see [examples](https://github.com/jenkins-infra/jenkins.io/blob/master/content/_data/changelogs/weekly.yml)). Fill in the **Proposed upgrade guidelines** section only if there are breaking changes or changes that may require extra steps from users during upgrade.\r\n- [ ] There is automated testing or an explanation as to why this change has no tests.\r\n- [ ] New public classes, fields, and methods are annotated with `@Restricted` or have `@since TODO` Javadocs, as appropriate.\r\n- [ ] New deprecations are annotated with `@Deprecated(since = \"TODO\")` or `@Deprecated(forRemoval = true, since = \"TODO\")`, if applicable.\r\n- [ ] New or substantially changed JavaScript is not defined inline and does not call `eval` to ease future introduction of Content Security Policy (CSP) directives (see [documentation](https://www.jenkins.io/doc/developer/security/csp/)).\r\n- [ ] For dependency updates, there are links to external changelogs and, if possible, full differentials.\r\n- [ ] For new APIs and extension points, there is a link to at least one consumer.\r\n```\r\n\r\n### Desired reviewers\r\n\r\n@mention\r\n\r\n<!-- Comment:\r\nIf you need an accelerated review process by the community (e.g., for critical bugs), mention @jenkinsci/core-pr-reviewers.\r\n-->\r\n\r\nBefore the changes are marked as `ready-for-merge`:\r\n\r\n```[tasklist]\r\n### Maintainer checklist\r\n- [ ] There are at least two (2) approvals for the pull request and no outstanding requests for change.\r\n- [ ] Conversations in the pull request are over, or it is explicit that a reviewer is not blocking the change.\r\n- [ ] Changelog entries in the pull request title and/or **Proposed changelog entries** are accurate, human-readable, and in the imperative mood.\r\n- [ ] Proper changelog labels are set so that the changelog can be generated automatically.\r\n- [ ] If the change needs additional upgrade steps from users, the `upgrade-guide-needed` label is set and there is a **Proposed upgrade guidelines** section in the pull request title (see [example](https://github.com/jenkinsci/jenkins/pull/4387)).\r\n- [ ] If it would make sense to backport the change to LTS, a Jira issue must exist, be a _Bug_ or _Improvement_, and be labeled as `lts-candidate` to be considered (see [query](https://issues.jenkins.io/issues/?filter=12146)).\r\n```\r\n\n\n<a href=\"https://gitpod.io/#https://github.com/jenkinsci/jenkins/pull/8453\"><img src=\"https://gitpod.io/button/open-in-gitpod.svg\"/></a>\n\n",
  "files_changed": [
    {
      "filename": "core/src/main/java/hudson/init/InitStrategy.java",
      "status": "modified",
      "patch": "@@ -9,6 +9,7 @@\n import java.util.ArrayList;\n import java.util.Arrays;\n import java.util.Collection;\n+import java.util.Comparator;\n import java.util.Iterator;\n import java.util.List;\n import java.util.ServiceLoader;\n@@ -64,7 +65,11 @@ private void listPluginFiles(PluginManager pm, String extension, Collection<File\n         if (files == null)\n             throw new IOException(\"Jenkins is unable to create \" + pm.rootDir + \"\\nPerhaps its security privilege is insufficient\");\n \n-        all.addAll(Arrays.asList(files));\n+        List<File> pluginFiles = new ArrayList<>();\n+        pluginFiles.addAll(List.of(files));\n+        pluginFiles.sort(Comparator.comparing(File::getName));\n+\n+        all.addAll(pluginFiles);\n     }\n \n     /**\n@@ -76,15 +81,16 @@ private void listPluginFiles(PluginManager pm, String extension, Collection<File\n     protected void getBundledPluginsFromProperty(final List<File> r) {\n         String hplProperty = SystemProperties.getString(\"hudson.bundled.plugins\");\n         if (hplProperty != null) {\n+            List<File> pluginFiles = new ArrayList<>();\n             for (String hplLocation : hplProperty.split(\",\")) {\n                 File hpl = new File(hplLocation.trim());\n                 if (hpl.exists()) {\n-                    r.add(hpl);\n+                    pluginFiles.add(hpl);\n                 } else if (hpl.getName().contains(\"*\")) {\n                     try {\n                         new DirScanner.Glob(hpl.getName(), null).scan(hpl.getParentFile(), new FileVisitor() {\n                             @Override public void visit(File f, String relativePath) throws IOException {\n-                                r.add(f);\n+                                pluginFiles.add(f);\n                             }\n                         });\n                     } catch (IOException x) {\n@@ -94,6 +100,8 @@ protected void getBundledPluginsFromProperty(final List<File> r) {\n                     LOGGER.warning(\"bundled plugin \" + hplLocation + \" does not exist\");\n                 }\n             }\n+            pluginFiles.sort(Comparator.comparing(File::getName));\n+            r.addAll(pluginFiles);\n         }\n     }\n "
    }
  ],
  "fix_category": "Make deterministic",
  "root_cause_category": "Unordered collections",
  "root_cause_subcategory": NaN
}