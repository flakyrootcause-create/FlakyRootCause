{
  "id": 201,
  "repo": "neural-search",
  "issue_url": "https://github.com/opensearch-project/neural-search/pull/1566",
  "pr_url": "https://github.com/opensearch-project/neural-search/pull/1566",
  "issue_description": "### Description\r\nThis is a PR for SEISMIC. I found there would be flakey tests within previous `warmUp` and `clearCache` related ITs. I fixed them in this PR. In addition, I refactored some codes to be cleaner.\r\n\r\n### Related Issues\r\nPrevious IT: #1559 \r\n\r\n### Check List\r\n- [ ] New functionality includes testing.\r\n- [ ] New functionality has been documented.\r\n- [ ] API changes companion pull request [created](https://github.com/opensearch-project/opensearch-api-specification/blob/main/DEVELOPER_GUIDE.md).\r\n- [x] Commits are signed per the DCO using `--signoff`.\r\n- [x] Public documentation issue/PR [created](https://github.com/opensearch-project/documentation-website/issues/new/choose).\r\n\r\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.\r\nFor more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/neural-search/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).\r\n",
  "files_changed": [
    {
      "filename": "CHANGELOG.md",
      "status": "modified",
      "patch": "@@ -7,7 +7,7 @@ The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),\n \n ### Features\n \n-- [SEISMIC] Support SEISMIC, a new sparse ANN algorithm [#1565](https://github.com/opensearch-project/neural-search/pull/1565), [#1564](https://github.com/opensearch-project/neural-search/pull/1564), [#1563](https://github.com/opensearch-project/neural-search/pull/1563), [#1562](https://github.com/opensearch-project/neural-search/pull/1562), [#1559](https://github.com/opensearch-project/neural-search/pull/1559), [#1557](https://github.com/opensearch-project/neural-search/pull/1557), [#1555](https://github.com/opensearch-project/neural-search/pull/1555), [#1554](https://github.com/opensearch-project/neural-search/pull/1554), [#1553](https://github.com/opensearch-project/neural-search/pull/1553), [#1539](https://github.com/opensearch-project/neural-search/pull/1539), [#1538](https://github.com/opensearch-project/neural-search/pull/1538), [#1537](https://github.com/opensearch-project/neural-search/pull/1537), [#1536](https://github.com/opensearch-project/neural-search/pull/1536), [#1524](https://github.com/opensearch-project/neural-search/pull/1524), [#1514](https://github.com/opensearch-project/neural-search/pull/1514), [#1502](https://github.com/opensearch-project/neural-search/pull/1502)\n+- [SEISMIC] Support SEISMIC, a new sparse ANN algorithm [#1566](https://github.com/opensearch-project/neural-search/pull/1566), [#1565](https://github.com/opensearch-project/neural-search/pull/1565), [#1564](https://github.com/opensearch-project/neural-search/pull/1564), [#1563](https://github.com/opensearch-project/neural-search/pull/1563), [#1562](https://github.com/opensearch-project/neural-search/pull/1562), [#1559](https://github.com/opensearch-project/neural-search/pull/1559), [#1557](https://github.com/opensearch-project/neural-search/pull/1557), [#1555](https://github.com/opensearch-project/neural-search/pull/1555), [#1554](https://github.com/opensearch-project/neural-search/pull/1554), [#1553](https://github.com/opensearch-project/neural-search/pull/1553), [#1539](https://github.com/opensearch-project/neural-search/pull/1539), [#1538](https://github.com/opensearch-project/neural-search/pull/1538), [#1537](https://github.com/opensearch-project/neural-search/pull/1537), [#1536](https://github.com/opensearch-project/neural-search/pull/1536), [#1524](https://github.com/opensearch-project/neural-search/pull/1524), [#1514](https://github.com/opensearch-project/neural-search/pull/1514), [#1502](https://github.com/opensearch-project/neural-search/pull/1502)\n \n ### Enhancements\n "
    },
    {
      "filename": "src/test/java/org/opensearch/neuralsearch/sparse/NeuralSparseCacheOperationIT.java",
      "status": "modified",
      "patch": "@@ -71,7 +71,7 @@ public void testWarmUpCache() {\n         Map<String, Object> responseMap = createParser(XContentType.JSON.xContent(), warmUpResponse.getEntity().getContent()).map();\n \n         assertNotNull(responseMap);\n-        assertEquals(responseMap.get(\"_shards\"), Map.of(\"total\", 1, \"successful\", 1, \"failed\", 0));\n+        assertEquals(Map.of(\"total\", 1, \"successful\", 1, \"failed\", 0), responseMap.get(\"_shards\"));\n \n         // Verify memory usage increased after warm up\n         List<Double> afterWarmUpSparseMemoryUsageStats = getSparseMemoryUsageStatsAcrossNodes();\n@@ -117,7 +117,7 @@ public void testClearCache() {\n         Map<String, Object> responseMap = createParser(XContentType.JSON.xContent(), response.getEntity().getContent()).map();\n \n         assertNotNull(responseMap);\n-        assertEquals(responseMap.get(\"_shards\"), Map.of(\"total\", 1, \"successful\", 1, \"failed\", 0));\n+        assertEquals(Map.of(\"total\", 1, \"successful\", 1, \"failed\", 0), responseMap.get(\"_shards\"));\n \n         // Verify memory usage decreased after clear cache\n         List<Double> afterClearCacheSparseMemoryUsageStats = getSparseMemoryUsageStatsAcrossNodes();\n@@ -158,21 +158,24 @@ public void testWarmUpMultiShardReplicasCache() {\n         // First clear cache before warm up\n         Request clearCacheRequest = new Request(\"POST\", \"/_plugins/_neural/clear_cache/\" + TEST_INDEX_NAME);\n         Response clearCacheResponse = client().performRequest(clearCacheRequest);\n+\n+        assertEquals(RestStatus.OK, RestStatus.fromCode(clearCacheResponse.getStatusLine().getStatusCode()));\n+\n         List<Double> originalSparseMemoryUsageStats = getSparseMemoryUsageStatsAcrossNodes();\n         double originalSparseMemoryUsageSum = originalSparseMemoryUsageStats.stream().mapToDouble(Double::doubleValue).sum();\n \n         // Execute warm up cache request\n         Request warmUpRequest = new Request(\"POST\", \"/_plugins/_neural/warmup/\" + TEST_INDEX_NAME);\n         Response warmUpResponse = client().performRequest(warmUpRequest);\n \n-        assertEquals(RestStatus.OK, RestStatus.fromCode(clearCacheResponse.getStatusLine().getStatusCode()));\n         assertEquals(RestStatus.OK, RestStatus.fromCode(warmUpResponse.getStatusLine().getStatusCode()));\n \n         // Verify response structure\n         Map<String, Object> responseMap = createParser(XContentType.JSON.xContent(), warmUpResponse.getEntity().getContent()).map();\n \n         assertNotNull(responseMap);\n-        assertEquals(responseMap.get(\"_shards\"), Map.of(\"total\", totalShards, \"successful\", totalShards, \"failed\", 0));\n+        Map<String, Object> shardsInfo = (Map<String, Object>) responseMap.get(\"_shards\");\n+        assertEquals(0, shardsInfo.get(\"failed\"));\n \n         // Verify memory usage increased after warm up\n         List<Double> afterWarmUpSparseMemoryUsageStats = getSparseMemoryUsageStatsAcrossNodes();\n@@ -195,6 +198,7 @@ public void testClearMultiShardReplicasCache() {\n \n         // Create Sparse Index\n         prepareMultiShardReplicasIndex(TEST_INDEX_NAME, TEST_SPARSE_FIELD_NAME, TEST_TEXT_FIELD_NAME, shards, replicas);\n+\n         List<Double> originalSparseMemoryUsageStats = getSparseMemoryUsageStatsAcrossNodes();\n         double originalSparseMemoryUsageSum = originalSparseMemoryUsageStats.stream().mapToDouble(Double::doubleValue).sum();\n \n@@ -208,7 +212,8 @@ public void testClearMultiShardReplicasCache() {\n         Map<String, Object> responseMap = createParser(XContentType.JSON.xContent(), response.getEntity().getContent()).map();\n \n         assertNotNull(responseMap);\n-        assertEquals(responseMap.get(\"_shards\"), Map.of(\"total\", totalShards, \"successful\", totalShards, \"failed\", 0));\n+        Map<String, Object> shardsInfo = (Map<String, Object>) responseMap.get(\"_shards\");\n+        assertEquals(0, shardsInfo.get(\"failed\"));\n \n         // Verify memory usage decreased after clear cache\n         List<Double> afterClearCacheSparseMemoryUsageStats = getSparseMemoryUsageStatsAcrossNodes();\n@@ -231,21 +236,23 @@ public void testWarmUpCache_MixSeismicAndRankFeatures() {\n         // First clear cache before warm up\n         Request clearCacheRequest = new Request(\"POST\", \"/_plugins/_neural/clear_cache/\" + TEST_INDEX_NAME);\n         Response clearCacheResponse = client().performRequest(clearCacheRequest);\n+\n+        assertEquals(RestStatus.OK, RestStatus.fromCode(clearCacheResponse.getStatusLine().getStatusCode()));\n+\n         List<Double> originalSparseMemoryUsageStats = getSparseMemoryUsageStatsAcrossNodes();\n         double originalSparseMemoryUsageSum = originalSparseMemoryUsageStats.stream().mapToDouble(Double::doubleValue).sum();\n \n         // Execute warm up cache request\n         Request warmUpRequest = new Request(\"POST\", \"/_plugins/_neural/warmup/\" + TEST_INDEX_NAME);\n         Response warmUpResponse = client().performRequest(warmUpRequest);\n \n-        assertEquals(RestStatus.OK, RestStatus.fromCode(clearCacheResponse.getStatusLine().getStatusCode()));\n         assertEquals(RestStatus.OK, RestStatus.fromCode(warmUpResponse.getStatusLine().getStatusCode()));\n \n         // Verify response structure\n         Map<String, Object> responseMap = createParser(XContentType.JSON.xContent(), warmUpResponse.getEntity().getContent()).map();\n \n         assertNotNull(responseMap);\n-        assertEquals(responseMap.get(\"_shards\"), Map.of(\"total\", 1, \"successful\", 1, \"failed\", 0));\n+        assertEquals(Map.of(\"total\", 1, \"successful\", 1, \"failed\", 0), responseMap.get(\"_shards\"));\n \n         // Verify memory usage increased after warm up\n         List<Double> afterWarmUpSparseMemoryUsageStats = getSparseMemoryUsageStatsAcrossNodes();\n@@ -291,7 +298,7 @@ public void testClearCache_MixSeismicAndRankFeatures() {\n         Map<String, Object> responseMap = createParser(XContentType.JSON.xContent(), response.getEntity().getContent()).map();\n \n         assertNotNull(responseMap);\n-        assertEquals(responseMap.get(\"_shards\"), Map.of(\"total\", 1, \"successful\", 1, \"failed\", 0));\n+        assertEquals(Map.of(\"total\", 1, \"successful\", 1, \"failed\", 0), responseMap.get(\"_shards\"));\n \n         // Verify memory usage decreased after clear cache\n         List<Double> afterClearCacheSparseMemoryUsageStats = getSparseMemoryUsageStatsAcrossNodes();\n@@ -328,21 +335,23 @@ public void testWarmUpCache_OnlyRankFeatures() {\n         // First clear cache before warm up\n         Request clearCacheRequest = new Request(\"POST\", \"/_plugins/_neural/clear_cache/\" + TEST_INDEX_NAME);\n         Response clearCacheResponse = client().performRequest(clearCacheRequest);\n+\n+        assertEquals(RestStatus.OK, RestStatus.fromCode(clearCacheResponse.getStatusLine().getStatusCode()));\n+\n         List<Double> originalSparseMemoryUsageStats = getSparseMemoryUsageStatsAcrossNodes();\n         double originalSparseMemoryUsageSum = originalSparseMemoryUsageStats.stream().mapToDouble(Double::doubleValue).sum();\n \n         // Execute warm up cache request\n         Request warmUpRequest = new Request(\"POST\", \"/_plugins/_neural/warmup/\" + TEST_INDEX_NAME);\n         Response warmUpResponse = client().performRequest(warmUpRequest);\n \n-        assertEquals(RestStatus.OK, RestStatus.fromCode(clearCacheResponse.getStatusLine().getStatusCode()));\n         assertEquals(RestStatus.OK, RestStatus.fromCode(warmUpResponse.getStatusLine().getStatusCode()));\n \n         // Verify response structure\n         Map<String, Object> responseMap = createParser(XContentType.JSON.xContent(), warmUpResponse.getEntity().getContent()).map();\n \n         assertNotNull(responseMap);\n-        assertEquals(responseMap.get(\"_shards\"), Map.of(\"total\", 1, \"successful\", 1, \"failed\", 0));\n+        assertEquals(Map.of(\"total\", 1, \"successful\", 1, \"failed\", 0), responseMap.get(\"_shards\"));\n \n         // Verify memory usage not changed after warm up\n         List<Double> afterWarmUpSparseMemoryUsageStats = getSparseMemoryUsageStatsAcrossNodes();\n@@ -379,7 +388,7 @@ public void testClearCache_OnlyRankFeatures() {\n         Map<String, Object> responseMap = createParser(XContentType.JSON.xContent(), response.getEntity().getContent()).map();\n \n         assertNotNull(responseMap);\n-        assertEquals(responseMap.get(\"_shards\"), Map.of(\"total\", 1, \"successful\", 1, \"failed\", 0));\n+        assertEquals(Map.of(\"total\", 1, \"successful\", 1, \"failed\", 0), responseMap.get(\"_shards\"));\n \n         // Verify memory usage not changed after clear cache\n         List<Double> afterClearCacheSparseMemoryUsageStats = getSparseMemoryUsageStatsAcrossNodes();"
    }
  ],
  "fix_category": "Make deterministic",
  "root_cause_category": "Network",
  "root_cause_subcategory": NaN
}