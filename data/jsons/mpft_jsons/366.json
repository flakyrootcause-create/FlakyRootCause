{
  "id": 366,
  "repo": "rocketmq",
  "issue_url": "https://github.com/apache/rocketmq/pull/7625",
  "pr_url": "https://github.com/apache/rocketmq/pull/7625",
  "issue_description": "<!-- Please make sure the target branch is right. In most case, the target branch should be `develop`. -->\r\n\r\n### Which Issue(s) This PR Fixes\r\n\r\n<!-- Please ensure that the related issue has already been created, and [link this pull request to that issue using keywords](<https://docs.github.com/en/issues/tracking-your-work-with-issues/linking-a-pull-request-to-an-issue#linking-a-pull-request-to-an-issue-using-a-keyword>) to ensure automatic closure. -->\r\n\r\nFixes #7614 \r\n\r\n### Brief Description\r\n\r\n<!-- Write a brief description for your pull request to help the maintainer understand the reasons behind your changes. -->\r\n\r\n### How Did You Test This Change?\r\n\r\n```\r\nbazel test --config=remote  //store:src/test/java/org/apache/rocketmq/store/RocksDBMessageStoreTest --runs_per_test=1024\r\n```\r\nVerify there is no failures anymore.\r\n\r\n",
  "files_changed": [
    {
      "filename": "store/BUILD.bazel",
      "status": "modified",
      "patch": "@@ -69,9 +69,8 @@ java_library(\n GenTestRules(\n     name = \"GeneratedTestRules\",\n     exclude_tests = [\n-        # This test is extremely slow and flaky, exclude it.\n+        # These tests are extremely slow and flaky, exclude them before they are properly fixed.\n         \"src/test/java/org/apache/rocketmq/store/ha/autoswitch/AutoSwitchHATest\",\n-        \"src/test/java/org/apache/rocketmq/store/RocksDBMessageStoreTest\",\n     ],\n     medium_tests = [\n         \"src/test/java/org/apache/rocketmq/store/DefaultMessageStoreTest\",\n@@ -80,6 +79,7 @@ GenTestRules(\n         \"src/test/java/org/apache/rocketmq/store/MappedFileQueueTest\",\n         \"src/test/java/org/apache/rocketmq/store/queue/BatchConsumeMessageTest\",\n         \"src/test/java/org/apache/rocketmq/store/dledger/MixCommitlogTest\",\n+        \"src/test/java/org/apache/rocketmq/store/RocksDBMessageStoreTest\",\n     ],\n     test_files = glob([\"src/test/java/**/*Test.java\"]),\n     deps = ["
    },
    {
      "filename": "store/src/test/java/org/apache/rocketmq/store/RocksDBMessageStoreTest.java",
      "status": "modified",
      "patch": "@@ -60,15 +60,18 @@\n import org.apache.rocketmq.store.queue.CqUnit;\n import org.apache.rocketmq.store.stats.BrokerStatsManager;\n import org.assertj.core.util.Strings;\n+import org.awaitility.Awaitility;\n import org.junit.After;\n-import org.junit.Assert;\n import org.junit.Before;\n import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.mockito.junit.MockitoJUnitRunner;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.fail;\n import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertSame;\n import static org.junit.Assert.assertTrue;\n \n @RunWith(MockitoJUnitRunner.class)\n@@ -77,7 +80,7 @@ public class RocksDBMessageStoreTest {\n     private final String messageTopic = \"FooBar\";\n     private final String storeType = StoreType.DEFAULT_ROCKSDB.getStoreType();\n     private int queueTotal = 100;\n-    private AtomicInteger queueId = new AtomicInteger(0);\n+    private final AtomicInteger queueId = new AtomicInteger(0);\n     private SocketAddress bornHost;\n     private SocketAddress storeHost;\n     private byte[] messageBody;\n@@ -171,27 +174,27 @@ public void testWriteAndRead() {\n         if (notExecuted()) {\n             return;\n         }\n-        long ipv4HostMsgs = 10;\n-        long ipv6HostMsgs = 10;\n-        long totalMsgs = ipv4HostMsgs + ipv6HostMsgs;\n+        long ipv4HostMessages = 10;\n+        long ipv6HostMessages = 10;\n+        long totalMessages = ipv4HostMessages + ipv6HostMessages;\n         queueTotal = 1;\n         messageBody = storeMessage.getBytes();\n-        for (long i = 0; i < ipv4HostMsgs; i++) {\n+        for (long i = 0; i < ipv4HostMessages; i++) {\n             messageStore.putMessage(buildMessage());\n         }\n \n-        for (long i = 0; i < ipv6HostMsgs; i++) {\n+        for (long i = 0; i < ipv6HostMessages; i++) {\n             messageStore.putMessage(buildIPv6HostMessage());\n         }\n \n         StoreTestUtil.waitCommitLogReput((RocksDBMessageStore) messageStore);\n \n-        for (long i = 0; i < totalMsgs; i++) {\n+        for (long i = 0; i < totalMessages; i++) {\n             GetMessageResult result = messageStore.getMessage(\"GROUP_A\", \"FooBar\", 0, i, 1024 * 1024, null);\n             assertThat(result).isNotNull();\n             result.release();\n         }\n-        verifyThatMasterIsFunctional(totalMsgs, messageStore);\n+        verifyThatMasterIsFunctional(totalMessages, messageStore);\n     }\n \n     @Test\n@@ -549,15 +552,13 @@ private MessageExtBrokerInner buildIPv6HostMessage(byte[] messageBody, String to\n         try {\n             msg.setBornHost(new InetSocketAddress(InetAddress.getByName(\"1050:0000:0000:0000:0005:0600:300c:326b\"), 0));\n         } catch (UnknownHostException e) {\n-            e.printStackTrace();\n-            assertThat(Boolean.FALSE).isTrue();\n+            fail(\"build IPv6 host message error\", e);\n         }\n \n         try {\n             msg.setStoreHost(new InetSocketAddress(InetAddress.getByName(\"::1\"), 0));\n         } catch (UnknownHostException e) {\n-            e.printStackTrace();\n-            assertThat(Boolean.FALSE).isTrue();\n+            fail(\"build IPv6 host message error\", e);\n         }\n         return msg;\n     }\n@@ -582,27 +583,27 @@ public MessageExtBatch buildMessageBatch(MessageBatch msgBatch) {\n     }\n \n     @Test\n-    public void testGroupCommit() throws Exception {\n+    public void testGroupCommit() {\n         if (notExecuted()) {\n             return;\n         }\n-        long totalMsgs = 10;\n+        long totalMessages = 10;\n         queueTotal = 1;\n         messageBody = storeMessage.getBytes();\n-        for (long i = 0; i < totalMsgs; i++) {\n+        for (long i = 0; i < totalMessages; i++) {\n             messageStore.putMessage(buildMessage());\n         }\n \n-        for (long i = 0; i < totalMsgs; i++) {\n+        for (long i = 0; i < totalMessages; i++) {\n             GetMessageResult result = messageStore.getMessage(\"GROUP_A\", \"TOPIC_A\", 0, i, 1024 * 1024, null);\n             assertThat(result).isNotNull();\n             result.release();\n         }\n-        verifyThatMasterIsFunctional(totalMsgs, messageStore);\n+        verifyThatMasterIsFunctional(totalMessages, messageStore);\n     }\n \n     @Test\n-    public void testMaxOffset() throws InterruptedException {\n+    public void testMaxOffset() {\n         if (notExecuted()) {\n             return;\n         }\n@@ -618,11 +619,11 @@ public void testMaxOffset() throws InterruptedException {\n             messageStore.putMessage(msg);\n         }\n \n-        while (messageStore.dispatchBehindBytes() != 0) {\n-            TimeUnit.MILLISECONDS.sleep(1);\n-        }\n-\n-        assertThat(messageStore.getMaxOffsetInQueue(messageTopic, queueId)).isEqualTo(firstBatchMessages);\n+        Awaitility.await()\n+                .with()\n+                .atMost(3, TimeUnit.SECONDS)\n+                .pollInterval(1, TimeUnit.MILLISECONDS)\n+                .until(() -> messageStore.getMaxOffsetInQueue(messageTopic, queueId) == firstBatchMessages);\n \n         // Disable the dispatcher\n         messageStore.getDispatcherList().clear();\n@@ -644,14 +645,14 @@ private MessageExtBrokerInner buildIPv6HostMessage() {\n         return buildIPv6HostMessage(messageBody, \"FooBar\");\n     }\n \n-    private void verifyThatMasterIsFunctional(long totalMsgs, MessageStore master) {\n-        for (long i = 0; i < totalMsgs; i++) {\n+    private void verifyThatMasterIsFunctional(long totalMessages, MessageStore master) {\n+        for (long i = 0; i < totalMessages; i++) {\n             master.putMessage(buildMessage());\n         }\n \n         StoreTestUtil.waitCommitLogReput((RocksDBMessageStore) messageStore);\n \n-        for (long i = 0; i < totalMsgs; i++) {\n+        for (long i = 0; i < totalMessages; i++) {\n             GetMessageResult result = master.getMessage(\"GROUP_A\", \"FooBar\", 0, i, 1024 * 1024, null);\n             assertThat(result).isNotNull();\n             result.release();\n@@ -660,7 +661,7 @@ private void verifyThatMasterIsFunctional(long totalMsgs, MessageStore master) {\n     }\n \n     @Test\n-    public void testPullSize() throws Exception {\n+    public void testPullSize() {\n         if (notExecuted()) {\n             return;\n         }\n@@ -673,9 +674,11 @@ public void testPullSize() throws Exception {\n             messageStore.putMessage(messageExtBrokerInner);\n         }\n         // wait for consume queue build\n-        // the sleep time should be great than consume queue flush interval\n-        //Thread.sleep(100);\n-        StoreTestUtil.waitCommitLogReput((RocksDBMessageStore) messageStore);\n+        Awaitility.await().atMost(10, TimeUnit.SECONDS)\n+                .with()\n+                .pollInterval(10, TimeUnit.MILLISECONDS)\n+                .until(() -> messageStore.getMaxOffsetInQueue(topic, 0) >= 32);\n+\n         String group = \"simple\";\n         GetMessageResult getMessageResult32 = messageStore.getMessage(group, topic, 0, 0, 32, null);\n         assertThat(getMessageResult32.getMessageBufferList().size()).isEqualTo(32);\n@@ -705,21 +708,25 @@ public void testRecover() throws Exception {\n             messageStore.putMessage(messageExtBrokerInner);\n         }\n \n-        // Thread.sleep(100);//wait for build consumer queue\n-        StoreTestUtil.waitCommitLogReput((RocksDBMessageStore) messageStore);\n+        // wait for build consumer queue\n+        Awaitility.await()\n+                .with()\n+                .pollInterval(100, TimeUnit.MILLISECONDS)\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> messageStore.getMaxOffsetInQueue(topic, 0) >= 100);\n \n         long maxPhyOffset = messageStore.getMaxPhyOffset();\n         long maxCqOffset = messageStore.getMaxOffsetInQueue(topic, 0);\n \n         //1.just reboot\n         messageStore.shutdown();\n-        String storeRootDir = ((RocksDBMessageStore) messageStore).getMessageStoreConfig().getStorePathRootDir();\n+        String storeRootDir = messageStore.getMessageStoreConfig().getStorePathRootDir();\n         messageStore = buildMessageStore(storeRootDir, topic);\n         boolean load = messageStore.load();\n         assertTrue(load);\n         messageStore.start();\n-        assertTrue(maxPhyOffset == messageStore.getMaxPhyOffset());\n-        assertTrue(maxCqOffset == messageStore.getMaxOffsetInQueue(topic, 0));\n+        assertEquals(maxPhyOffset, messageStore.getMaxPhyOffset());\n+        assertEquals(maxCqOffset, messageStore.getMaxOffsetInQueue(topic, 0));\n \n         //2.damage commit-log and reboot normal\n         for (int i = 0; i < 100; i++) {\n@@ -728,39 +735,49 @@ public void testRecover() throws Exception {\n             messageExtBrokerInner.setQueueId(0);\n             messageStore.putMessage(messageExtBrokerInner);\n         }\n-        //Thread.sleep(100);\n-        StoreTestUtil.waitCommitLogReput((RocksDBMessageStore) messageStore);\n+\n+        Awaitility.await()\n+                .with()\n+                .pollInterval(100, TimeUnit.MILLISECONDS)\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> messageStore.getMaxOffsetInQueue(topic, 0) >= 200);\n+\n         long secondLastPhyOffset = messageStore.getMaxPhyOffset();\n         long secondLastCqOffset = messageStore.getMaxOffsetInQueue(topic, 0);\n \n+        // Append a message to corrupt\n         MessageExtBrokerInner messageExtBrokerInner = buildMessage();\n         messageExtBrokerInner.setTopic(topic);\n         messageExtBrokerInner.setQueueId(0);\n         messageStore.putMessage(messageExtBrokerInner);\n \n-\n         messageStore.shutdown();\n \n-        //damage last message\n+        // Corrupt the last message\n         damageCommitLog((RocksDBMessageStore) messageStore, secondLastPhyOffset);\n \n         //reboot\n         messageStore = buildMessageStore(storeRootDir, topic);\n         load = messageStore.load();\n         assertTrue(load);\n         messageStore.start();\n-        assertTrue(secondLastPhyOffset == messageStore.getMaxPhyOffset());\n-        assertTrue(secondLastCqOffset == messageStore.getMaxOffsetInQueue(topic, 0));\n+        assertEquals(secondLastPhyOffset, messageStore.getMaxPhyOffset());\n+        assertEquals(secondLastCqOffset, messageStore.getMaxOffsetInQueue(topic, 0));\n \n-        //3.damage commitlog and reboot abnormal\n+        //3.Corrupt commit-log and reboot abnormal\n         for (int i = 0; i < 100; i++) {\n             messageExtBrokerInner = buildMessage();\n             messageExtBrokerInner.setTopic(topic);\n             messageExtBrokerInner.setQueueId(0);\n             messageStore.putMessage(messageExtBrokerInner);\n         }\n-        //Thread.sleep(100);\n-        StoreTestUtil.waitCommitLogReput((RocksDBMessageStore) messageStore);\n+\n+        Awaitility.await()\n+                .with()\n+                .pollInterval(100, TimeUnit.MILLISECONDS)\n+                .atMost(10, TimeUnit.SECONDS)\n+                .until(() -> messageStore.getMaxOffsetInQueue(topic, 0) >= 300);\n+\n         secondLastPhyOffset = messageStore.getMaxPhyOffset();\n         secondLastCqOffset = messageStore.getMaxOffsetInQueue(topic, 0);\n \n@@ -770,20 +787,20 @@ public void testRecover() throws Exception {\n         messageStore.putMessage(messageExtBrokerInner);\n         messageStore.shutdown();\n \n-        //damage last message\n+        //Corrupt the last message\n         damageCommitLog((RocksDBMessageStore) messageStore, secondLastPhyOffset);\n         //add abort file\n-        String fileName = StorePathConfigHelper.getAbortFile(((RocksDBMessageStore) messageStore).getMessageStoreConfig().getStorePathRootDir());\n+        String fileName = StorePathConfigHelper.getAbortFile(messageStore.getMessageStoreConfig().getStorePathRootDir());\n         File file = new File(fileName);\n         UtilAll.ensureDirOK(file.getParent());\n-        file.createNewFile();\n+        assertTrue(file.createNewFile());\n \n         messageStore = buildMessageStore(storeRootDir, topic);\n         load = messageStore.load();\n         assertTrue(load);\n         messageStore.start();\n-        assertTrue(secondLastPhyOffset == messageStore.getMaxPhyOffset());\n-        assertTrue(secondLastCqOffset == messageStore.getMaxOffsetInQueue(topic, 0));\n+        assertEquals(secondLastPhyOffset, messageStore.getMaxPhyOffset());\n+        assertEquals(secondLastCqOffset, messageStore.getMaxOffsetInQueue(topic, 0));\n \n         //message write again\n         for (int i = 0; i < 100; i++) {\n@@ -860,7 +877,8 @@ public void testPutMsgBatchExceedsMaxLength() {\n         MessageExtBatch msgExtBatch = buildMessageBatch(msgBatch);\n \n         try {\n-            PutMessageResult result = this.messageStore.putMessages(msgExtBatch);\n+            this.messageStore.putMessages(msgExtBatch);\n+            fail(\"Should have raised an exception\");\n         } catch (Exception e) {\n             assertThat(e.getMessage()).contains(\"message body size exceeded\");\n         }\n@@ -871,7 +889,7 @@ public void testPutMsgWhenReplicasNotEnough() {\n         if (notExecuted()) {\n             return;\n         }\n-        MessageStoreConfig messageStoreConfig = ((RocksDBMessageStore) this.messageStore).getMessageStoreConfig();\n+        MessageStoreConfig messageStoreConfig = this.messageStore.getMessageStoreConfig();\n         messageStoreConfig.setBrokerRole(BrokerRole.SYNC_MASTER);\n         messageStoreConfig.setTotalReplicas(2);\n         messageStoreConfig.setInSyncReplicas(2);\n@@ -890,7 +908,7 @@ public void testPutMsgWhenAdaptiveDegradation() {\n         if (notExecuted()) {\n             return;\n         }\n-        MessageStoreConfig messageStoreConfig = ((RocksDBMessageStore) this.messageStore).getMessageStoreConfig();\n+        MessageStoreConfig messageStoreConfig = this.messageStore.getMessageStoreConfig();\n         messageStoreConfig.setBrokerRole(BrokerRole.SYNC_MASTER);\n         messageStoreConfig.setTotalReplicas(2);\n         messageStoreConfig.setInSyncReplicas(2);\n@@ -930,44 +948,44 @@ public void testGetBulkCommitLogData() {\n     }\n \n     @Test\n-    public void testPutLongMessage() throws Exception {\n+    public void testPutLongMessage() {\n         if (notExecuted()) {\n             return;\n         }\n         MessageExtBrokerInner messageExtBrokerInner = buildMessage();\n-        CommitLog commitLog = ((RocksDBMessageStore) messageStore).getCommitLog();\n-        MessageStoreConfig messageStoreConfig = ((RocksDBMessageStore) messageStore).getMessageStoreConfig();\n+        CommitLog commitLog = messageStore.getCommitLog();\n+        MessageStoreConfig messageStoreConfig = messageStore.getMessageStoreConfig();\n         MessageExtEncoder.PutMessageThreadLocal putMessageThreadLocal = commitLog.getPutMessageThreadLocal().get();\n \n         //body size, topic size, properties size exactly equal to max size\n         messageExtBrokerInner.setBody(new byte[messageStoreConfig.getMaxMessageSize()]);\n         messageExtBrokerInner.setTopic(new String(new byte[127]));\n         messageExtBrokerInner.setPropertiesString(new String(new byte[Short.MAX_VALUE]));\n         PutMessageResult encodeResult1 = putMessageThreadLocal.getEncoder().encode(messageExtBrokerInner);\n-        assertTrue(encodeResult1 == null);\n+        assertNull(encodeResult1);\n \n         //body size exactly more than max message body size\n         messageExtBrokerInner.setBody(new byte[messageStoreConfig.getMaxMessageSize() + 1]);\n         PutMessageResult encodeResult2 = putMessageThreadLocal.getEncoder().encode(messageExtBrokerInner);\n-        assertTrue(encodeResult2.getPutMessageStatus() == PutMessageStatus.MESSAGE_ILLEGAL);\n+        assertSame(encodeResult2.getPutMessageStatus(), PutMessageStatus.MESSAGE_ILLEGAL);\n \n         //body size exactly equal to max message size\n         messageExtBrokerInner.setBody(new byte[messageStoreConfig.getMaxMessageSize() + 64 * 1024]);\n         PutMessageResult encodeResult3 = putMessageThreadLocal.getEncoder().encode(messageExtBrokerInner);\n-        assertTrue(encodeResult3.getPutMessageStatus() == PutMessageStatus.MESSAGE_ILLEGAL);\n+        assertSame(encodeResult3.getPutMessageStatus(), PutMessageStatus.MESSAGE_ILLEGAL);\n \n         //message properties length more than properties maxSize\n         messageExtBrokerInner.setBody(new byte[messageStoreConfig.getMaxMessageSize()]);\n         messageExtBrokerInner.setPropertiesString(new String(new byte[Short.MAX_VALUE + 1]));\n         PutMessageResult encodeResult4 = putMessageThreadLocal.getEncoder().encode(messageExtBrokerInner);\n-        assertTrue(encodeResult4.getPutMessageStatus() == PutMessageStatus.PROPERTIES_SIZE_EXCEEDED);\n+        assertSame(encodeResult4.getPutMessageStatus(), PutMessageStatus.PROPERTIES_SIZE_EXCEEDED);\n \n         //message length more than buffer length capacity\n         messageExtBrokerInner.setBody(new byte[messageStoreConfig.getMaxMessageSize()]);\n         messageExtBrokerInner.setTopic(new String(new byte[Short.MAX_VALUE]));\n         messageExtBrokerInner.setPropertiesString(new String(new byte[Short.MAX_VALUE]));\n         PutMessageResult encodeResult5 = putMessageThreadLocal.getEncoder().encode(messageExtBrokerInner);\n-        assertTrue(encodeResult5.getPutMessageStatus() == PutMessageStatus.MESSAGE_ILLEGAL);\n+        assertSame(encodeResult5.getPutMessageStatus(), PutMessageStatus.MESSAGE_ILLEGAL);\n     }\n \n     @Test\n@@ -976,21 +994,21 @@ public void testDynamicMaxMessageSize() {\n             return;\n         }\n         MessageExtBrokerInner messageExtBrokerInner = buildMessage();\n-        MessageStoreConfig messageStoreConfig = ((RocksDBMessageStore) messageStore).getMessageStoreConfig();\n+        MessageStoreConfig messageStoreConfig = messageStore.getMessageStoreConfig();\n         int originMaxMessageSize = messageStoreConfig.getMaxMessageSize();\n \n         messageExtBrokerInner.setBody(new byte[originMaxMessageSize + 10]);\n         PutMessageResult putMessageResult = messageStore.putMessage(messageExtBrokerInner);\n-        assertTrue(putMessageResult.getPutMessageStatus() == PutMessageStatus.MESSAGE_ILLEGAL);\n+        assertSame(putMessageResult.getPutMessageStatus(), PutMessageStatus.MESSAGE_ILLEGAL);\n \n         int newMaxMessageSize = originMaxMessageSize + 10;\n         messageStoreConfig.setMaxMessageSize(newMaxMessageSize);\n         putMessageResult = messageStore.putMessage(messageExtBrokerInner);\n-        assertTrue(putMessageResult.getPutMessageStatus() == PutMessageStatus.PUT_OK);\n+        assertSame(putMessageResult.getPutMessageStatus(), PutMessageStatus.PUT_OK);\n \n         messageStoreConfig.setMaxMessageSize(10);\n         putMessageResult = messageStore.putMessage(messageExtBrokerInner);\n-        assertTrue(putMessageResult.getPutMessageStatus() == PutMessageStatus.MESSAGE_ILLEGAL);\n+        assertSame(putMessageResult.getPutMessageStatus(), PutMessageStatus.MESSAGE_ILLEGAL);\n \n         messageStoreConfig.setMaxMessageSize(originMaxMessageSize);\n     }\n@@ -1013,11 +1031,11 @@ public void testDeleteTopics() {\n             }\n             consumeQueueTable.put(topicName, cqTable);\n         }\n-        Assert.assertEquals(consumeQueueTable.size(), 10);\n+        assertEquals(consumeQueueTable.size(), 10);\n         HashSet<String> resultSet = Sets.newHashSet(\"topic-3\", \"topic-5\");\n         messageStore.deleteTopics(Sets.difference(consumeQueueTable.keySet(), resultSet));\n-        Assert.assertEquals(consumeQueueTable.size(), 2);\n-        Assert.assertEquals(resultSet, consumeQueueTable.keySet());\n+        assertEquals(consumeQueueTable.size(), 2);\n+        assertEquals(resultSet, consumeQueueTable.keySet());\n     }\n \n     @Test\n@@ -1038,14 +1056,14 @@ public void testCleanUnusedTopic() {\n             }\n             consumeQueueTable.put(topicName, cqTable);\n         }\n-        Assert.assertEquals(consumeQueueTable.size(), 10);\n+        assertEquals(consumeQueueTable.size(), 10);\n         HashSet<String> resultSet = Sets.newHashSet(\"topic-3\", \"topic-5\");\n         messageStore.cleanUnusedTopic(resultSet);\n-        Assert.assertEquals(consumeQueueTable.size(), 2);\n-        Assert.assertEquals(resultSet, consumeQueueTable.keySet());\n+        assertEquals(consumeQueueTable.size(), 2);\n+        assertEquals(resultSet, consumeQueueTable.keySet());\n     }\n \n-    private class MyMessageArrivingListener implements MessageArrivingListener {\n+    private static class MyMessageArrivingListener implements MessageArrivingListener {\n         @Override\n         public void arriving(String topic, int queueId, long logicOffset, long tagsCode, long msgStoreTime,\n             byte[] filterBitMap, Map<String, String> properties) {"
    },
    {
      "filename": "store/src/test/java/org/apache/rocketmq/store/timer/TimerMessageStoreTest.java",
      "status": "modified",
      "patch": "@@ -426,8 +426,8 @@ public Boolean call() {\n         assertEquals(first.getCommitReadTimeMs(), second.getCommitReadTimeMs());\n         second.start(true);\n \n-        // Wait until all messages have wrote back to commitLog and consumeQueue.\n-        await().atMost(5000, TimeUnit.MILLISECONDS).until(new Callable<Boolean>() {\n+        // Wait until all messages have been written back to commitLog and consumeQueue.\n+        await().atMost(30000, TimeUnit.MILLISECONDS).until(new Callable<Boolean>() {\n             @Override\n             public Boolean call() {\n                 ConsumeQueue cq = (ConsumeQueue) messageStore.getConsumeQueue(topic, 0);"
    }
  ],
  "fix_category": "Setup/clean up state",
  "root_cause_category": "I/O",
  "root_cause_subcategory": NaN
}