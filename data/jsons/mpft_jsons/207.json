{
  "id": 207,
  "repo": "azure-sdk-for-net",
  "issue_url": "https://github.com/Azure/azure-sdk-for-net/pull/52584",
  "pr_url": "https://github.com/Azure/azure-sdk-for-net/pull/52584",
  "issue_description": "",
  "files_changed": [
    {
      "filename": "sdk/storage/Azure.Storage.DataMovement.Blobs/tests/PageBlobStartTransferCopyTests.cs",
      "status": "modified",
      "patch": "@@ -251,7 +251,7 @@ private async Task VerifyPropertiesCopyAsyncInternal(\n                 {\n                     Assert.That(destinationProperties.AccessTier.ToString(), Is.Not.EqualTo(_defaultAccessTier.ToString()));\n                 }\n-                if (!premium)\n+                else\n                 {\n                     // Premium accounts do not support tags\n                     GetBlobTagResult destinationTags = await destinationClient.GetTagsAsync();"
    },
    {
      "filename": "sdk/storage/Azure.Storage.DataMovement/tests/Shared/PauseResumeTransferTestBase.cs",
      "status": "modified",
      "patch": "@@ -368,8 +368,23 @@ private async Task AssertDirectorySourceAndDestinationAsync(\n                 await VerifyTransferContent(childSourceResource, childDestinationResource, sourceContainer, destinationContainer, transferType);\n             }\n         }\n+\n+        private bool HasFileTransferReachedInProgressState(List<TransferProgress> progressUpdates)\n+        {\n+            return progressUpdates.Any(p => p.InProgressCount > 0);\n+        }\n         #endregion\n \n+        private class TestProgressHandler : IProgress<TransferProgress>\n+        {\n+            public List<TransferProgress> Updates { get; private set; } = new List<TransferProgress>();\n+\n+            public void Report(TransferProgress progress)\n+            {\n+                Updates.Add(progress);\n+            }\n+        }\n+\n         #region Tests\n         [Test]\n         [LiveOnly]\n@@ -392,7 +407,15 @@ public async Task TryPauseTransferAsync_Id(TransferDirection transferType)\n                 ProvidersForResuming = new List<StorageResourceProvider>() { provider },\n             };\n             TransferManager transferManager = new TransferManager(options);\n-            TransferOptions transferOptions = new TransferOptions();\n+            TestProgressHandler progressHandler = new();\n+            TransferOptions transferOptions = new TransferOptions\n+            {\n+                ProgressHandlerOptions = new TransferProgressHandlerOptions\n+                {\n+                    ProgressHandler = progressHandler,\n+                    TrackBytesTransferred = true\n+                }\n+            };\n             TestEventsRaised testEventsRaised = new TestEventsRaised(transferOptions);\n \n             // Add long-running job to pause, if the job is not big enough\n@@ -407,19 +430,25 @@ public async Task TryPauseTransferAsync_Id(TransferDirection transferType)\n                 transferOptions: transferOptions);\n \n             // Act\n-            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(20));\n+            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(30));\n             await transferManager.PauseTransferAsync(transfer.Id, cancellationTokenSource.Token);\n \n             // Assert\n             await testEventsRaised.AssertPausedCheck();\n             Assert.AreEqual(TransferState.Paused, transfer.Status.State);\n \n-            // Check if Job Plan File exists in checkpointer path.\n-            JobPartPlanFileName fileName = new JobPartPlanFileName(\n-                checkpointerPath: checkpointerDirectory.DirectoryPath,\n-                id: transfer.Id,\n-                jobPartNumber: 0);\n-            Assert.IsTrue(File.Exists(fileName.FullPath));\n+            List<TransferProgress> progressUpdates = progressHandler.Updates;\n+            // We need to check whether the transfer has any files that has reached 'InProgress' state\n+            // before checking whether the Job Part Plan File exists.\n+            if (HasFileTransferReachedInProgressState(progressUpdates))\n+            {\n+                // Check if Job Plan File exists in checkpointer path.\n+                JobPartPlanFileName fileName = new JobPartPlanFileName(\n+                    checkpointerPath: checkpointerDirectory.DirectoryPath,\n+                    id: transfer.Id,\n+                    jobPartNumber: 0);\n+                Assert.IsTrue(File.Exists(fileName.FullPath));\n+            }\n         }\n \n         [Test]\n@@ -442,7 +471,16 @@ public async Task TryPauseTransferAsync_TransferOperation(TransferDirection tran\n                 ErrorMode = TransferErrorMode.ContinueOnFailure,\n                 ProvidersForResuming = new List<StorageResourceProvider>() { provider },\n             };\n-            TransferOptions transferOptions = new TransferOptions();\n+\n+            TestProgressHandler progressHandler = new();\n+            TransferOptions transferOptions = new TransferOptions\n+            {\n+                ProgressHandlerOptions = new TransferProgressHandlerOptions\n+                {\n+                    ProgressHandler = progressHandler,\n+                    TrackBytesTransferred = true\n+                }\n+            };\n             TestEventsRaised testEventsRaised = new TestEventsRaised(transferOptions);\n             TransferManager transferManager = new TransferManager(options);\n \n@@ -458,19 +496,25 @@ public async Task TryPauseTransferAsync_TransferOperation(TransferDirection tran\n                 transferOptions: transferOptions);\n \n             // Act\n-            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(20));\n+            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(30));\n             await transferManager.PauseTransferAsync(transfer.Id, cancellationTokenSource.Token);\n \n             // Assert\n             await testEventsRaised.AssertPausedCheck();\n             Assert.AreEqual(TransferState.Paused, transfer.Status.State);\n \n-            // Check if Job Plan File exists in checkpointer path.\n-            JobPartPlanFileName fileName = new JobPartPlanFileName(\n-                checkpointerPath: checkpointerDirectory.DirectoryPath,\n-                id: transfer.Id,\n-                jobPartNumber: 0);\n-            Assert.IsTrue(File.Exists(fileName.FullPath));\n+            List<TransferProgress> progressUpdates = progressHandler.Updates;\n+            // We need to check whether the transfer has any files that has reached 'InProgress' state\n+            // before checking whether the Job Part Plan File exists.\n+            if (HasFileTransferReachedInProgressState(progressUpdates))\n+            {\n+                // Check if Job Plan File exists in checkpointer path.\n+                JobPartPlanFileName fileName = new JobPartPlanFileName(\n+                    checkpointerPath: checkpointerDirectory.DirectoryPath,\n+                    id: transfer.Id,\n+                    jobPartNumber: 0);\n+                Assert.IsTrue(File.Exists(fileName.FullPath));\n+            }\n         }\n \n         [RecordedTest]\n@@ -509,7 +553,16 @@ public async Task TryPauseTransferAsync_AlreadyPaused(TransferDirection transfer\n                 ErrorMode = TransferErrorMode.ContinueOnFailure,\n                 ProvidersForResuming = new List<StorageResourceProvider>() { provider },\n             };\n-            TransferOptions transferOptions = new TransferOptions();\n+\n+            TestProgressHandler progressHandler = new();\n+            TransferOptions transferOptions = new TransferOptions\n+            {\n+                ProgressHandlerOptions = new TransferProgressHandlerOptions\n+                {\n+                    ProgressHandler = progressHandler,\n+                    TrackBytesTransferred = true\n+                }\n+            };\n             TestEventsRaised testEventsRaised = new TestEventsRaised(transferOptions);\n             TransferManager transferManager = new TransferManager(options);\n \n@@ -525,7 +578,7 @@ public async Task TryPauseTransferAsync_AlreadyPaused(TransferDirection transfer\n                 transferOptions: transferOptions);\n \n             // Act\n-            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(20));\n+            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(30));\n             await transferManager.PauseTransferAsync(transfer.Id, cancellationTokenSource.Token);\n \n             // Assert\n@@ -537,12 +590,18 @@ public async Task TryPauseTransferAsync_AlreadyPaused(TransferDirection transfer\n \n             Assert.AreEqual(TransferState.Paused, transfer.Status.State);\n \n-            // Check if Job Plan File exists in checkpointer path.\n-            JobPartPlanFileName fileName = new JobPartPlanFileName(\n-                checkpointerPath: checkpointerDirectory.DirectoryPath,\n-                id: transfer.Id,\n-                jobPartNumber: 0);\n-            Assert.IsTrue(File.Exists(fileName.FullPath));\n+            List<TransferProgress> progressUpdates = progressHandler.Updates;\n+            // We need to check whether the transfer has any files that has reached 'InProgress' state\n+            // before checking whether the Job Part Plan File exists.\n+            if (HasFileTransferReachedInProgressState(progressUpdates))\n+            {\n+                // Check if Job Plan File exists in checkpointer path.\n+                JobPartPlanFileName fileName = new JobPartPlanFileName(\n+                    checkpointerPath: checkpointerDirectory.DirectoryPath,\n+                    id: transfer.Id,\n+                    jobPartNumber: 0);\n+                Assert.IsTrue(File.Exists(fileName.FullPath));\n+            }\n         }\n \n         [Test]\n@@ -586,7 +645,7 @@ public async Task PauseThenResumeTransferAsync(TransferDirection transferType)\n                 transferOptions: transferOptions);\n \n             // Act\n-            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(20));\n+            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(30));\n             await transferManager.PauseTransferAsync(transfer.Id, cancellationTokenSource.Token);\n \n             // Assert\n@@ -604,7 +663,7 @@ public async Task PauseThenResumeTransferAsync(TransferDirection transferType)\n                 transferId: transfer.Id,\n                 transferOptions: resumeOptions);\n \n-            CancellationTokenSource waitTransferCompletion = new CancellationTokenSource(TimeSpan.FromSeconds(20));\n+            CancellationTokenSource waitTransferCompletion = new CancellationTokenSource(TimeSpan.FromSeconds(60));\n             await resumeTransfer.WaitForCompletionAsync(waitTransferCompletion.Token);\n \n             // Assert\n@@ -674,7 +733,7 @@ public async Task ResumeTransferAsync(TransferDirection transferType)\n                 transferOptions: transferOptions);\n \n             // Act\n-            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(20));\n+            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(30));\n             await transferManager.PauseTransferAsync(transfer.Id, cancellationTokenSource.Token);\n \n             // Assert\n@@ -688,7 +747,7 @@ public async Task ResumeTransferAsync(TransferDirection transferType)\n                 transfer.Id,\n                 resumeOptions);\n \n-            CancellationTokenSource waitTransferCompletion = new CancellationTokenSource(TimeSpan.FromSeconds(20));\n+            CancellationTokenSource waitTransferCompletion = new CancellationTokenSource(TimeSpan.FromSeconds(30));\n             await resumeTransfer.WaitForCompletionAsync(waitTransferCompletion.Token);\n \n             // Assert\n@@ -741,7 +800,7 @@ public async Task ResumeTransferAsync_Options(TransferDirection transferType)\n             TransferOperation transfer = await transferManager.StartTransferAsync(source, destination);\n \n             // Act\n-            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(20));\n+            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(30));\n             await transferManager.PauseTransferAsync(transfer.Id, cancellationTokenSource.Token);\n \n             // Assert\n@@ -750,7 +809,7 @@ public async Task ResumeTransferAsync_Options(TransferDirection transferType)\n \n             // Act - Resume Job\n             TransferOperation resumeTransfer = await transferManager.ResumeTransferAsync(transfer.Id);\n-            CancellationTokenSource waitTransferCompletion = new CancellationTokenSource(TimeSpan.FromSeconds(20));\n+            CancellationTokenSource waitTransferCompletion = new CancellationTokenSource(TimeSpan.FromSeconds(30));\n             await resumeTransfer.WaitForCompletionAsync(waitTransferCompletion.Token);\n \n             // Assert\n@@ -800,7 +859,7 @@ public async Task TryPauseTransferAsync_Id_Directory(TransferDirection transferT\n                 transferOptions: transferOptions);\n \n             // Act\n-            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(20));\n+            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(30));\n             await transferManager.PauseTransferAsync(transfer.Id, cancellationTokenSource.Token);\n \n             // Assert\n@@ -848,7 +907,7 @@ public async Task TryPauseTransferAsync_TransferOperation_Directory(TransferDire\n                 transferOptions: transferOptions);\n \n             // Act\n-            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(20));\n+            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(30));\n             await transferManager.PauseTransferAsync(transfer.Id, cancellationTokenSource.Token);\n \n             // Assert\n@@ -896,7 +955,7 @@ public async Task TryPauseTransferAsync_AlreadyPaused_Directory(TransferDirectio\n                 transferOptions: transferOptions);\n \n             // Act\n-            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(20));\n+            CancellationTokenSource cancellationTokenSource = new CancellationTokenSource(TimeSpan.FromSeconds(30));\n             await transferManager.PauseTransferAsync(transfer.Id, cancellationTokenSource.Token);\n \n             // Assert\n@@ -1180,7 +1239,7 @@ public async Task PauseAllTriggersCorrectPauses()\n                 manager._transfers.TryAdd(Guid.NewGuid().ToString(), transfer.Object);\n             }\n \n-            CancellationTokenSource token = new CancellationTokenSource(TimeSpan.FromSeconds(20));\n+            CancellationTokenSource token = new CancellationTokenSource(TimeSpan.FromSeconds(30));\n             await manager.PauseAllRunningTransfersAsync(token.Token);\n \n             foreach (Mock<TransferOperation> transfer in pausable)"
    },
    {
      "filename": "sdk/storage/Azure.Storage.DataMovement/tests/Shared/StartTransferDirectoryDownloadTestBase.cs",
      "status": "modified",
      "patch": "@@ -476,6 +476,7 @@ private async Task<TransferOperation> CreateStartTransfer(\n             TransferManagerOptions managerOptions = new TransferManagerOptions()\n             {\n                 MaximumConcurrency = concurrency,\n+                ErrorMode = TransferErrorMode.StopOnAnyFailure\n             };\n             TransferManager transferManager = new TransferManager(managerOptions);\n "
    },
    {
      "filename": "sdk/storage/Azure.Storage.DataMovement/tests/Shared/TransferValidator.cs",
      "status": "modified",
      "patch": "@@ -41,7 +41,7 @@ public async Task TransferAndVerifyAsync(\n             if (cancellationToken == default)\n             {\n                 CancellationTokenSource cts = new();\n-                cts.CancelAfter(TimeSpan.FromSeconds(30));\n+                cts.CancelAfter(TimeSpan.FromSeconds(60));\n                 cancellationToken = cts.Token;\n             }\n "
    },
    {
      "filename": "sdk/storage/Azure.Storage.DataMovement/tests/TransferManagerTests.cs",
      "status": "modified",
      "patch": "@@ -63,7 +63,7 @@ private static async Task ProcessChunksAssert(\n         if (chunksPerPart > 1)\n         {\n             // Multichunk transfer sends a completion chunk after all the other chunks stepped through.\n-            await Task.Delay(50);\n+            await Task.Delay(100);\n             Assert.That(await chunksProcessor.StepAll() + chunksStepped, Is.EqualTo(numChunks + totalJobParts));\n         }\n         else"
    },
    {
      "filename": "sdk/storage/Azure.Storage.DataMovement/tests/TransferValidationTests.cs",
      "status": "modified",
      "patch": "@@ -29,7 +29,7 @@ public async Task LargeSingleFile(\n             TestEventsRaised events = new(options);\n             TransferOperation transfer = await transferManager.StartTransferAsync(srcResource, dstResource, options);\n \n-            CancellationTokenSource tokenSource = new(TimeSpan.FromSeconds(10));\n+            CancellationTokenSource tokenSource = new(TimeSpan.FromSeconds(30));\n             await transfer.WaitForCompletionAsync(tokenSource.Token);\n \n             Assert.That(transfer.HasCompleted, Is.True);\n@@ -54,7 +54,7 @@ public async Task LargeSingleFile_Fail_Source(\n             TestEventsRaised events = new(options);\n             TransferOperation transfer = await transferManager.StartTransferAsync(srcResource, dstResource, options);\n \n-            CancellationTokenSource tokenSource = new(TimeSpan.FromSeconds(10));\n+            CancellationTokenSource tokenSource = new(TimeSpan.FromSeconds(30));\n             await transfer.WaitForCompletionAsync(tokenSource.Token);\n \n             Assert.That(transfer.HasCompleted, Is.True);"
    }
  ],
  "fix_category": "Sleep",
  "root_cause_category": "Time",
  "root_cause_subcategory": NaN
}