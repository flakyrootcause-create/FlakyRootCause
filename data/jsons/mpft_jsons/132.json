{
  "id": 132,
  "repo": "spark",
  "issue_url": "https://github.com/apache/spark/pull/52248",
  "pr_url": "https://github.com/apache/spark/pull/52248",
  "issue_description": "### What changes were proposed in this pull request?\r\nThis PR removes an assertion from `SparkConnectServiceSuite.scala` to eliminate flakiness which affects the following tests in the test suite.\r\n\r\n* `SPARK-44776: LocalTableScanExec`\r\n* `SPARK-41224: collect data using arrow`\r\n\r\nIn those tests, [VerifyEvents#onNext](https://github.com/apache/spark/blob/9d27db940673196f64b1568d73c459f83eb6f788/sql/connect/server/src/test/scala/org/apache/spark/sql/connect/planner/SparkConnectServiceSuite.scala#L913) is called and checked `assert(executeHolder.eventsManager.status == ExecuteStatus.Analyzed)`, which can fail and this PR proposes to remove this assertion.\r\nIf this assertion fails, an exception will be thrown and [VerifyEvents#onError](https://github.com/apache/spark/blob/9d27db940673196f64b1568d73c459f83eb6f788/sql/connect/server/src/test/scala/org/apache/spark/sql/connect/planner/SparkConnectServiceSuite.scala#L921) is called but the reason this `onError` is called is not due to a query/command fails. So `executeHolder.eventsManager.hasError.isDefined` never changes to `true`.\r\n\r\n`VerifyEvents#onNext` is indirectly called from [ExecuteGrpcResponseSender#sendResponse](https://github.com/apache/spark/blob/9d27db940673196f64b1568d73c459f83eb6f788/sql/connect/server/src/main/scala/org/apache/spark/sql/connect/execution/ExecuteGrpcResponseSender.scala#L398), which runs on a sender thread.\r\nOn the other hand, an operation status is changed on another thread. Especially, transition to `Analyzed` status is done [here](https://github.com/apache/spark/blob/9d27db940673196f64b1568d73c459f83eb6f788/sql/connect/server/src/main/scala/org/apache/spark/sql/connect/execution/SparkConnectPlanExecution.scala#L75). But the status can transition to `ReadyForExecution` or `Finished` before `VerifyEvents#onNext` is called.\r\nSo, those tests can occasionally fail.\r\n\r\nYou can easily reproduce this issue by inserting sleep like as follows and then run those tests.\r\n```\r\n   def onNext(v: proto.ExecutePlanResponse): Unit = {\r\n     if (v.hasSchema) {\r\n+      Thread.sleep(5000)\r\n       assert(executeHolder.eventsManager.status == ExecuteStatus.Analyzed)\r\n     }\r\n```\r\n\r\nThe solution this PR proposes is just removing the assertion.\r\nIn `VerifyEvents#onNext`, there is another assertion `assert(executeHolder.eventsManager.status == ExecuteStatus.Finished)` and I think having only this assertion is enough because the status changes to `Finished` through `Analyzed`.\r\n\r\n\r\n### Why are the changes needed?\r\nFor test stability.\r\n\r\n### Does this PR introduce _any_ user-facing change?\r\nNo.\r\n\r\n\r\n### How was this patch tested?\r\nInserting sleep into `onNext` like explained above and run the problematic tests.\r\n\r\n### Was this patch authored or co-authored using generative AI tooling?\r\nNo.\r\n",
  "files_changed": [
    {
      "filename": "sql/connect/server/src/test/scala/org/apache/spark/sql/connect/planner/SparkConnectServiceSuite.scala",
      "status": "modified",
      "patch": "@@ -911,9 +911,6 @@ class SparkConnectServiceSuite\n       }\n     }\n     def onNext(v: proto.ExecutePlanResponse): Unit = {\n-      if (v.hasSchema) {\n-        assert(executeHolder.eventsManager.status == ExecuteStatus.Analyzed)\n-      }\n       if (v.hasMetrics) {\n         assert(executeHolder.eventsManager.status == ExecuteStatus.Finished)\n       }"
    }
  ],
  "fix_category": "Change assertion",
  "root_cause_category": "Concurrency",
  "root_cause_subcategory": NaN
}